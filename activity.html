<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Etkinlik Yönetimi</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/mobile.css" />
    <link rel="stylesheet" href="css/tablet.css" />
    <link rel="stylesheet" href="css/activity.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      .offcanvas {
        transform: translateX(-100%);
        visibility: visible;
        transition: transform 0.3s ease;
        width: 400px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        height: 100vh;
        background-color: white;
      }

      .offcanvas.show {
        transform: translateX(0);
      }

      #mainContainer {
        transition: all 0.3s ease;
        width: 100%;
        margin-left: 0;
        position: relative;
        overflow-x: auto;
        padding-bottom: 60px;
      }

      #mainContainer.shifted {
        margin-left: 400px;
        width: calc(100% - 400px);
      }

      #menuButton {
        display: inline-block;
      }

      @media (max-width: 992px) {
        /* Tablet and Mobile: Hide offcanvas by default */
        .offcanvas {
          transform: translateX(-100%);
        }

        .offcanvas.show {
          transform: translateX(0);
        }

        #mainContainer.shifted {
          margin-left: 0;
          width: 100%;
        }

        /* Show menu button on mobile and tablet */
        #menuButton {
          display: inline-block;
        }

        /* Mobile overlay */
        .menu-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1040;
        }

        .menu-overlay.active {
          display: block;
        }
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow-x: auto;
        padding: 20px;
      }

      footer {
        height: 50px;
        background-color: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
      }

      .container-fluid {
        margin-bottom: 70px;
      }

      .stats-card {
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 20px;
      }

      .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .event-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fff;
        transition: all 0.3s ease;
      }

      .event-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: #007bff;
      }

      /* Butonları her zaman görünür yap - Hover özelliklerini normal duruma taşı */
      .event-item .btn {
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
        transform: none !important;
        transition: all 0.3s ease !important;
      }

      /* Hover durumunu da aynı yap */
      .event-item:hover .btn,
      .event-item .btn:hover {
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
      }

      .event-item .d-flex {
        opacity: 1 !important;
        visibility: visible !important;
        display: flex !important;
      }

      /* Hover durumunda da container görünür kalsın */
      .event-item:hover .d-flex {
        opacity: 1 !important;
        visibility: visible !important;
        display: flex !important;
      }

      /* Buton container'ını her zaman görünür yap */
      .event-item .d-flex.gap-2 {
        opacity: 1 !important;
        visibility: visible !important;
        display: flex !important;
        transform: none !important;
      }

      /* Tüm buton türlerini zorla görünür yap */
      .event-item .btn-warning,
      .event-item .btn-success,
      .event-item .btn-secondary,
      .event-item .btn-danger,
      .event-item .btn-outline-info {
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
        pointer-events: auto !important;
      }

      /* En güçlü kural - tüm durumlar için */
      .event-item button,
      .event-item .btn,
      .event-item button.btn {
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
        pointer-events: auto !important;
        position: static !important;
        transform: none !important;
      }

      /* Hover durumunda da aynı */
      .event-item:hover button,
      .event-item:hover .btn,
      .event-item button:hover,
      .event-item .btn:hover {
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
      }

      .slider-badge {
        background-color: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        border-bottom: 1px solid #dee2e6;
      }

      .form-control,
      .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
      }

      .btn {
        border-radius: 6px;
      }

      @media (max-width: 768px) {
        .offcanvas {
          width: 300px;
        }

        #mainContainer.shifted {
          margin-left: 300px;
          width: calc(100% - 300px);
        }

        .event-item .btn {
          font-size: 0.9rem;
          padding: 8px 12px;
          margin-bottom: 5px;
        }

        .event-item .d-flex {
          flex-direction: column;
          align-items: stretch;
        }

        .event-item .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div
        class="offcanvas offcanvas-start"
        data-bs-backdrop="false"
        id="adminPanelSideMenu"
      >
        <div
          class="offcanvas-header d-flex justify-content-start"
          style="margin-top: 2%"
        >
          <div>
            <img
              src="assets/274348852_320609883437173_4953649348556891409_n.jpg"
              alt="profilResmi"
              width="50px"
              height="50px"
              style="border-radius: 50px"
            />
          </div>
          <div class="offcanvas-title text-primary ms-4 h4">Yönetim Paneli</div>
        </div>

        <div
          class="offcanvas-body offcanvas-primary d-flex align-items-top flex-column"
        >
          <div class="list-group mb-auto p2">
            <a
              href="activity.html"
              class="list-group-item list-group-item-action active"
              data-required-permissions="1,1a,2,2a"
              >Etkinlikler
            </a>
            <a
              href="staff.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,10,10a"
              >Ekip</a
            >
            <a
              href="salooncontrol.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,3,3a"
              >Salon Takip</a
            >
            <a
              href="ticket-management.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,2,2a"
              >Bilet Yönetimi</a
            >
            <a
              href="news.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,5,5a"
              >Haberler</a
            >
            <a
              href="costume.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,9,9a"
              >Kostümler</a
            >
            <a
              href="library.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,8,8a"
              >Kütüphane</a
            >
            <a
              href="messages.html"
              class="list-group-item list-group-item-action messages-link"
              style="display: none"
              data-required-permissions="1,1a,2,2a"
              >Mesajlar</a
            >
          </div>

          <div class="list-group">
            <button
              class="list-group-item list-group-item-action bg-danger text-white"
              id="logoutButton"
            >
              Çıkış Yap
            </button>
          </div>
        </div>
      </div>

      <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

      <div class="container-fluid" id="mainContainer">
        <div
          class="containerTitle d-flex justify-content-between border-bottom border-primary bg-white"
        >
          <button class="btn btn-primary mb-3 mt-3" id="menuButton">
            <i class="fas fa-times"></i>
          </button>
          <div class="h3 text-primary m-3 pb-0 flex-fill">
            Etkinlik Yönetimi
          </div>
        </div>

        <!-- İstatistikler -->
        <div class="row mt-4">
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #007bff, #0056b3)"
            >
              <div class="stats-number" id="totalEvents">0</div>
              <div class="stats-label">Toplam Etkinlik</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #28a745, #20c997)"
            >
              <div class="stats-number" id="sliderEvents">0</div>
              <div class="stats-label">Slider'da Gösterilen</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #ffc107, #fd7e14)"
            >
              <div class="stats-number" id="todayEvents">0</div>
              <div class="stats-label">Bugünkü Etkinlikler</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #dc3545, #e83e8c)"
            >
              <div class="stats-number" id="upcomingEvents">0</div>
              <div class="stats-label">Yaklaşan Etkinlikler</div>
            </div>
          </div>
        </div>

        <!-- Ana İçerik - Etkinlik Listesi -->
        <div class="row" id="eventsListContainer">
          <div class="col-12">
            <div class="card">
              <div
                class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">
                  <i class="fas fa-list me-2"></i>Etkinlikler
                </h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-success" id="newEventBtn">
                    <i class="fas fa-plus me-1"></i>Yeni Etkinlik
                  </button>
                  <button class="btn btn-info" id="templatesBtn">
                    <i class="fas fa-copy me-1"></i>Şablonlar
                  </button>
                  <button class="btn btn-warning" id="fromTemplateBtn">
                    <i class="fas fa-magic me-1"></i>Şablondan Ekle
                  </button>
                  <button
                    class="btn btn-outline-light btn-sm"
                    onclick="loadEvents()"
                  >
                    <i class="fas fa-sync-alt me-1"></i>Yenile
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div id="eventsContainer">
                  <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Etkinlikler yükleniyor...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Etkinlik Formu (Başlangıçta Gizli) -->
        <div class="row mt-4" id="eventFormContainer" style="display: none">
          <div class="col-12">
            <div class="card">
              <div
                class="card-header bg-success text-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0" id="formTitle">
                  <i class="fas fa-plus-circle me-2"></i>Yeni Etkinlik Ekle
                </h5>
                <button class="btn btn-outline-light btn-sm" id="cancelFormBtn">
                  <i class="fas fa-times me-1"></i>İptal
                </button>
              </div>
              <div class="card-body">
                <form id="eventForm">
                  <div class="mb-3">
                    <label class="form-label">Etkinlik Adı *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="eventName"
                      required
                    />
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea
                      class="form-control"
                      id="eventDescription"
                      rows="3"
                    ></textarea>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Tarih *</label>
                    <input
                      type="date"
                      class="form-control"
                      id="eventDate"
                      required
                    />
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Saat *</label>
                    <input
                      type="time"
                      class="form-control"
                      id="eventTime"
                      required
                    />
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Salon *</label>
                    <select class="form-select" id="eventLocation" required>
                      <option value="">Salon seçin...</option>
                      <option
                        value="İbrahim Erkal Dadaş KSM (Büyük Salon)"
                        data-lat="39.9208"
                        data-lng="41.2769"
                      >
                        İbrahim Erkal Dadaş KSM (Büyük Salon)
                      </option>
                      <option
                        value="İbrahim Erkal Dadaş KSM (Küçük Salon)"
                        data-lat="39.9210"
                        data-lng="41.2771"
                      >
                        İbrahim Erkal Dadaş KSM (Küçük Salon)
                      </option>
                      <option
                        value="İbrahim Erkal Dadaş KSM (Fuaye)"
                        data-lat="39.9205"
                        data-lng="41.2765"
                      >
                        İbrahim Erkal Dadaş KSM (Fuaye)
                      </option>
                      <option
                        value="Necip Fazıl KSM (Büyük Salon)"
                        data-lat="39.9212"
                        data-lng="41.2773"
                      >
                        Necip Fazıl KSM (Büyük Salon)
                      </option>
                      <option
                        value="Necip Fazıl KSM (Seminer Salonu 1)"
                        data-lat="39.9207"
                        data-lng="41.2767"
                      >
                        Necip Fazıl KSM (Seminer Salonu 1)
                      </option>
                      <option
                        value="Necip Fazıl KSM (Seminer Salonu 2)"
                        data-lat="39.9215"
                        data-lng="41.2775"
                      >
                        Necip Fazıl KSM (Seminer Salonu 2)
                      </option>
                      <option
                        value="Necip Fazıl KSM (Fuaye)"
                        data-lat="39.9213"
                        data-lng="41.2770"
                      >
                        Necip Fazıl KSM (Fuaye)
                      </option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Kategori</label>
                    <select class="form-select" id="eventCategory">
                      <option value="Konser">Konser</option>
                      <option value="Tiyatro">Tiyatro</option>
                      <option value="Seminer">Seminer</option>
                      <option value="Söyleşi">Söyleşi</option>
                      <option value="Sergi">Sergi</option>
                      <option value="Workshop">Workshop</option>
                      <option value="Diğer">Diğer</option>
                    </select>
                  </div>

                  <!-- Tiyatro Ek Özellikleri -->
                  <div id="theaterExtras" class="mb-3" style="display: none">
                    <div class="card">
                      <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                          <i class="fas fa-theater-masks me-2"></i>Tiyatro
                          Kadrosu
                        </h6>
                      </div>
                      <div class="card-body">
                        <div class="row mb-3">
                          <div class="col-md-4">
                            <label class="form-label">Görev</label>
                            <select class="form-select" id="staffRoleFilter">
                              <option value="">Tüm Görevler</option>
                              <optgroup label="Yönetim">
                                <option value="Daire Başkanı">
                                  Daire Başkanı
                                </option>
                                <option value="Şube Müdürü">Şube Müdürü</option>
                                <option value="Genel Sanat Yönetmeni">
                                  Genel Sanat Yönetmeni
                                </option>
                              </optgroup>
                              <optgroup label="Sanat ve Prodüksiyon">
                                <option value="Yönetmen">Yönetmen</option>
                                <option value="Işık Tasarımcısı">
                                  Işık Tasarımcısı
                                </option>
                                <option value="Dekor Tasarımcısı">
                                  Dekor Tasarımcısı
                                </option>
                                <option value="Grafik Tasarımcısı">
                                  Grafik Tasarımcısı
                                </option>
                                <option value="Müzik Yönetmeni">
                                  Müzik Yönetmeni
                                </option>
                                <option value="Senarist">Senarist</option>
                                <option value="Fotoğrafçı">Fotoğrafçı</option>
                                <option value="Oyuncu">Oyuncu</option>
                              </optgroup>
                              <optgroup label="İdari Personel">
                                <option value="Memur">Memur</option>
                                <option value="Teknik Görevli">
                                  Teknik Görevli
                                </option>
                              </optgroup>
                              <optgroup label="Destek Personeli">
                                <option value="Çaycı">Çaycı</option>
                                <option value="Temizlikçi">Temizlikçi</option>
                              </optgroup>
                            </select>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Ekip Üyesi Ara</label>
                            <input
                              type="text"
                              class="form-control"
                              id="staffSearchInput"
                              placeholder="İsim yazarak arayın..."
                            />
                          </div>
                          <div class="col-md-2 d-flex align-items-end">
                            <a
                              href="staff.html"
                              class="btn btn-outline-primary w-100"
                            >
                              <i class="fas fa-user-plus"></i> Yeni Ekip
                            </a>
                          </div>
                        </div>

                        <!-- Arama Sonuçları -->
                        <div
                          id="staffSearchResults"
                          class="mb-3"
                          style="display: none"
                        >
                          <h6 class="text-muted mb-2">Ekip Üyeleri:</h6>
                          <div
                            id="staffSearchContainer"
                            class="border rounded p-2"
                            style="
                              max-height: 200px;
                              overflow-y: auto;
                              background-color: #f8f9fa;
                            "
                          >
                            <!-- Arama sonuçları buraya gelecek -->
                          </div>
                        </div>

                        <!-- Kadro Listesi -->
                        <div id="staffList">
                          <h6 class="text-muted mb-2">Kadro:</h6>
                          <div
                            id="staffContainer"
                            class="border rounded p-2"
                            style="min-height: 60px; background-color: #f8f9fa"
                          >
                            <small class="text-muted"
                              >Henüz kadro eklenmedi.</small
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Yatay Afiş (Slider için)</label>
                    <div class="input-group mb-2">
                      <input
                        type="file"
                        class="form-control"
                        id="eventImageFile"
                        accept="image/*"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        id="uploadImageBtn"
                      >
                        <i class="fas fa-upload"></i> Yükle
                      </button>
                    </div>
                    <input
                      type="url"
                      class="form-control"
                      id="eventImage"
                      placeholder="Yüklenen görsel URL'si"
                      readonly
                    />
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Dikey Afiş (Poster)</label>
                    <div class="input-group mb-2">
                      <input
                        type="file"
                        class="form-control"
                        id="eventPosterImageFile"
                        accept="image/*"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        id="uploadPosterBtn"
                      >
                        <i class="fas fa-upload"></i> Yükle
                      </button>
                    </div>
                    <input
                      type="url"
                      class="form-control"
                      id="eventPosterImage"
                      placeholder="Yüklenen poster URL'si"
                      readonly
                    />
                  </div>

                  <div class="mb-3">
                    <label class="form-label"
                      >Kare Fotoğraf (Mobil & Küçük Slider)</label
                    >
                    <div class="input-group mb-2">
                      <input
                        type="file"
                        class="form-control"
                        id="eventSquareImageFile"
                        accept="image/*"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        id="uploadSquareImageBtn"
                      >
                        <i class="fas fa-upload"></i> Yükle
                      </button>
                    </div>
                    <input
                      type="url"
                      class="form-control"
                      id="eventSquareImage"
                      placeholder="Yüklenen kare fotoğraf URL'si"
                      readonly
                    />
                    <small class="text-muted"
                      >Önerilen oran 1:1 (örnek 800x800 piksel)</small
                    >
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Kayıt URL</label>
                    <input
                      type="url"
                      class="form-control"
                      id="registrationUrl"
                      placeholder="https://..."
                    />
                  </div>

                  <div class="mb-3 form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="showInSlider"
                    />
                    <label class="form-check-label" for="showInSlider">
                      <strong>Slider'da Göster</strong>
                      <small class="d-block text-muted"
                        >Ana sayfada öne çıkarılsın</small
                      >
                    </label>
                  </div>

                  <div class="mb-3 form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="activityTicketInfo"
                    />
                    <label class="form-check-label" for="activityTicketInfo">
                      <strong><i class="fas fa-ticket-alt me-1"></i>Biletli Etkinlik</strong>
                      <small class="d-block text-muted"
                        >Bu etkinlik için bilet satışı yapılacak</small
                      >
                    </label>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="saveAsTemplate"
                      />
                      <label class="form-check-label" for="saveAsTemplate">
                        <i class="fas fa-copy me-1"></i>Bu etkinliği şablon
                        olarak da kaydet
                      </label>
                    </div>
                  </div>

                  <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-save me-2"></i>Etkinlik Ekle
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                  <i class="fas fa-info-circle me-2"></i>Bilgilendirme
                </h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <h6><i class="fas fa-lightbulb me-2"></i>İpuçları:</h6>
                  <ul class="mb-0">
                    <li>
                      <strong>Tiyatro etkinlikleri</strong> için kadro
                      ekleyebilirsiniz
                    </li>
                    <li>
                      <strong>Slider'da göster</strong> seçeneği ana sayfada
                      görünür
                    </li>
                    <li>
                      <strong>Fotoğraf yükledikten</strong> sonra "Yükle"
                      butonuna basın
                    </li>
                    <li>
                      <strong>Yeni ekip üyesi</strong> eklemek için "Yeni Ekip"
                      linkini kullanın
                    </li>
                  </ul>
                </div>

                <div class="alert alert-warning">
                  <h6>
                    <i class="fas fa-exclamation-triangle me-2"></i>Dikkat:
                  </h6>
                  <p class="mb-0">
                    Etkinlik silindikten sonra geri alınamaz. Silme işleminden
                    önce emin olun.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Şablon Seçimi Modal -->
    <div
      class="modal fade"
      id="templateModal"
      tabindex="-1"
      aria-labelledby="templateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="templateModalLabel">
              <i class="fas fa-copy me-2"></i>Etkinlik Şablonları
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              data-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="templatesContainer">
              <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                <p class="mt-2 text-muted">Şablonlar yükleniyor...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-1"></i>Kapat
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Şablondan Etkinlik Oluşturma Modal -->
    <div
      class="modal fade"
      id="fromTemplateModal"
      tabindex="-1"
      aria-labelledby="fromTemplateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="fromTemplateModalLabel">
              <i class="fas fa-magic me-2"></i>Şablondan Etkinlik Oluştur
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Tarih *</label>
                <input
                  type="date"
                  class="form-control"
                  id="templateEventDate"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Saat *</label>
                <input
                  type="time"
                  class="form-control"
                  id="templateEventTime"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Şablon Seç *</label>
              <select class="form-select" id="templateSelect" required>
                <option value="">Şablon seçin...</option>
              </select>
            </div>
            <div
              id="selectedTemplatePreview"
              class="border rounded p-3 bg-light"
              style="display: none"
            >
              <h6 class="text-muted mb-2">Seçilen Şablon:</h6>
              <div id="templatePreviewContent"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              data-dismiss="modal"
            >
              <i class="fas fa-times me-1"></i>İptal
            </button>
            <button
              type="button"
              class="btn btn-warning"
              id="createFromTemplateBtn"
            >
              <i class="fas fa-magic me-1"></i>Etkinlik Oluştur
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Kadro Detay Modal -->
    <div
      class="modal fade"
      id="eventStaffDetailsModal"
      tabindex="-1"
      aria-labelledby="eventStaffDetailsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="eventStaffDetailsModalLabel">
              <i class="fas fa-user me-2"></i>Kadro Üyesi Detayları
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              data-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4 text-center mb-3">
                <div id="eventStaffDetailPhoto" class="mb-3"></div>
                <h5 id="eventStaffDetailName" class="mb-1">-</h5>
                <p id="eventStaffDetailRole" class="text-primary mb-1">-</p>
                <p
                  id="eventStaffDetailOriginalRole"
                  class="text-muted small mb-0"
                >
                  Asıl Görev: -
                </p>
                <p id="eventStaffDetailCharacter" class="text-muted small mb-0">
                  Karakter: -
                </p>
              </div>
              <div class="col-md-8">
                <div class="mb-3">
                  <label class="form-label fw-bold"
                    ><i class="fas fa-info-circle me-2"></i>Özgeçmiş:</label
                  >
                  <p id="eventStaffDetailBio" class="mb-0 text-muted">-</p>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold"
                    ><i class="fas fa-film me-2"></i>Geçmiş Projeler:</label
                  >
                  <div id="eventStaffDetailFilmography" class="text-muted">
                    -
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              data-dismiss="modal"
            >
              Kapat
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Kadro Ekleme Modal -->
    <div
      class="modal fade"
      id="addStaffModal"
      tabindex="-1"
      aria-labelledby="addStaffModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="addStaffModalLabel">
              <i class="fas fa-user-plus me-2"></i>Kadroya Ekle
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              data-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <img
                  id="selectedStaffPhoto"
                  src=""
                  alt="Fotoğraf"
                  class="img-fluid rounded"
                  style="width: 80px; height: 80px; object-fit: cover"
                />
              </div>
              <div class="col-md-8">
                <h6 id="selectedStaffName" class="mb-1">-</h6>
                <p id="selectedStaffOriginalRole" class="text-muted mb-0 small">
                  Asıl Görev: -
                </p>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Bu Etkinlikteki Görevi *</label>
              <select class="form-select" id="staffEventRole" required>
                <option value="">Görev seçin...</option>
                <optgroup label="Yönetim">
                  <option value="Yönetmen">Yönetmen</option>
                  <option value="Genel Sanat Yönetmeni">
                    Genel Sanat Yönetmeni
                  </option>
                  <option value="Yapımcı">Yapımcı</option>
                </optgroup>
                <optgroup label="Sanat ve Teknik">
                  <option value="Işık Tasarımcısı">Işık Tasarımcısı</option>
                  <option value="Dekor Tasarımcısı">Dekor Tasarımcısı</option>
                  <option value="Kostüm Tasarımcısı">Kostüm Tasarımcısı</option>
                  <option value="Müzik Yönetmeni">Müzik Yönetmeni</option>
                  <option value="Ses Teknisyeni">Ses Teknisyeni</option>
                  <option value="Grafik Tasarımcısı">Grafik Tasarımcısı</option>
                  <option value="Senarist">Senarist</option>
                  <option value="Fotoğrafçı">Fotoğrafçı</option>
                </optgroup>
                <optgroup label="Oyuncular">
                  <option value="Başrol Oyuncusu">Başrol Oyuncusu</option>
                  <option value="Oyuncu">Oyuncu</option>
                  <option value="Figüran">Figüran</option>
                </optgroup>
                <optgroup label="Diğer">
                  <option value="Asistan">Asistan</option>
                  <option value="Koordinatör">Koordinatör</option>
                </optgroup>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Karakter/Rol Adı (Opsiyonel)</label>
              <input
                type="text"
                class="form-control"
                id="staffCharacterName"
                placeholder="Örn: Hamlet, Kral Lear, vb."
              />
              <small class="text-muted"
                >Oyuncu ise hangi karakteri canlandıracağını yazın</small
              >
            </div>

            <div class="mb-3">
              <label class="form-label"
                >Bu Oyun İçin Özel Fotoğraf (Opsiyonel)</label
              >
              <div class="input-group mb-2">
                <input
                  type="file"
                  class="form-control"
                  id="staffEventPhotoFile"
                  accept="image/*"
                />
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="uploadStaffEventPhoto"
                >
                  <i class="fas fa-upload"></i> Yükle
                </button>
              </div>
              <input
                type="url"
                class="form-control"
                id="staffEventPhotoUrl"
                placeholder="Yüklenen fotoğraf URL'si"
                readonly
              />
              <small class="text-muted"
                >Bu fotoğraf sadece bu etkinlik için kullanılacak</small
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              data-dismiss="modal"
            >
              <i class="fas fa-times me-1"></i>İptal
            </button>
            <button type="button" class="btn btn-success" id="confirmAddStaff">
              <i class="fas fa-plus me-1"></i>Kadroya Ekle
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p style="margin: 0">© 2024 EBB Kültür Sanat. Tüm hakları saklıdır.</p>
    </footer>

    <script src="js/main.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- Firebase -->
    <script type="module">
      // Firebase imports
      import {
        initializeApp,
        getApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        query,
        orderBy,
        where,
        Timestamp,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
      import { ensureAuth, logActivity } from "./js/authGuard.js";
      import {
        updateMessagesLinkVisibility,
        enforceLinkPermissions,
      } from "./js/offcanvas.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD978ixFjE9KVlNsm6-BYww3B6S4qPVLfQ",
        authDomain: "ebbkultursanatapp.firebaseapp.com",
        projectId: "ebbkultursanatapp",
        storageBucket: "ebbkultursanatapp.appspot.com",
        messagingSenderId: "540910775157",
        appId: "1:540910775157:web:4af35312414acf20bd013c",
        measurementId: "G-4JCKV13ER8",
      };

      // Initialize Firebase
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      const authContext = await ensureAuth({
        app,
        auth,
        db,
        requiredAny: ["1", "1a", "2", "2a"],
        writeCodes: ["1", "2"],
        pageName: "Etkinlik Yönetimi",
      }).catch((error) => {
        console.error("Yetkilendirme başarısız:", error);
        return null;
      });

      if (!authContext) {
        throw new Error("Authorisation failed");
      }

      const currentUserEmail = authContext.user.email;
      const currentUserName =
        authContext.profile?.userName || authContext.user.displayName || "";
      const currentUserPermissions = authContext.permissions || [];
      const canWrite = authContext.canWrite;
      updateMessagesLinkVisibility(currentUserPermissions);
      enforceLinkPermissions(currentUserPermissions);

      if (!canWrite) {
        document.body.dataset.readOnly = "true";
      }

      window.currentUserEmail = currentUserEmail;
      window.currentUserName = currentUserName;
      window.activityCanWrite = canWrite;
      window.activityUserPermissions = currentUserPermissions;

      // Global variables
      let events = [];
      let editingEventId = null;
      let currentStaff = []; // Mevcut etkinlik için kadro listesi
      let allStaffMembers = []; // Tüm ekip üyeleri

      // Menu toggle functionality (salooncontrol style)
      function setupMenuToggle() {
        const menuButton = document.getElementById("menuButton");
        const adminPanel = document.getElementById("adminPanelSideMenu");
        const mainContainer = document.getElementById("mainContainer");

        if (!menuButton || !adminPanel || !mainContainer) {
          return;
        }

        const menuIcon = menuButton.querySelector("i");

        function toggleMenu() {
          adminPanel.classList.toggle("show");
          mainContainer.classList.toggle("shifted");

          // İkon değişimi
          if (menuIcon) {
            if (menuIcon.classList.contains("fa-bars")) {
              menuIcon.classList.remove("fa-bars");
              menuIcon.classList.add("fa-times");
            } else {
              menuIcon.classList.remove("fa-times");
              menuIcon.classList.add("fa-bars");
            }
          }
        }

        menuButton.addEventListener("click", function (e) {
          e.stopPropagation();
          toggleMenu();
        });

        // Initialize: menu açık başla (salooncontrol gibi)
        adminPanel.classList.add("show");
        mainContainer.classList.add("shifted");
        if (menuIcon) {
          menuIcon.classList.remove("fa-bars");
          menuIcon.classList.add("fa-times");
        }
      }

      function initializeActivityPage() {
        setupMenuToggle();

        const templatesBtn = document.getElementById("templatesBtn");
        if (templatesBtn) {
          templatesBtn.addEventListener("click", showTemplatesModal);
        }

        const fromTemplateBtn = document.getElementById("fromTemplateBtn");
        if (fromTemplateBtn) {
          fromTemplateBtn.addEventListener("click", showFromTemplateModal);
        }

        const createFromTemplateBtn = document.getElementById(
          "createFromTemplateBtn"
        );
        if (createFromTemplateBtn) {
          createFromTemplateBtn.addEventListener(
            "click",
            createEventFromTemplate
          );
        }

        const templateSelect = document.getElementById("templateSelect");
        if (templateSelect) {
          templateSelect.addEventListener("change", previewSelectedTemplate);
        }

        if (!canWrite) {
          if (fromTemplateBtn) {
            fromTemplateBtn.classList.add("disabled");
            fromTemplateBtn.addEventListener("click", function (e) {
              e.preventDefault();
              alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
            });
          }
          if (createFromTemplateBtn) {
            createFromTemplateBtn.classList.add("disabled");
          }
        }

        // Initialize
        loadEvents();
        setupEventForm();
        setupTheaterFeatures();
        setupFormToggle();
        setupUploadButtons();
        setupModalCloseButtons();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeActivityPage);
      } else {
        initializeActivityPage();
      }

      // Load events from Firebase
      async function loadEvents() {
        try {
          const eventsRef = collection(db, "activity");
          const q = query(eventsRef, orderBy("date", "desc"));
          const querySnapshot = await getDocs(q);

          events = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            let eventDate = new Date();
            if (data.date) {
              if (typeof data.date.toDate === "function") {
                eventDate = data.date.toDate();
              } else if (
                typeof data.date === "string" ||
                typeof data.date === "number"
              ) {
                const parsedDate = new Date(data.date);
                if (!isNaN(parsedDate.getTime())) {
                  eventDate = parsedDate;
                }
              }
            }
            events.push({
              id: doc.id,
              ...data,
              date: eventDate,
            });
          });

          renderEvents();
          updateStats();
        } catch (error) {
          console.error("Error loading events:", error);
          document.getElementById("eventsContainer").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
              <p class="mt-2 text-danger">Etkinlikler yüklenirken hata oluştu!</p>
            </div>
          `;
        }
      }

      // Render events list
      function renderEvents() {
        const container = document.getElementById("eventsContainer");

        if (events.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-calendar-times fa-2x text-muted"></i>
              <p class="mt-2 text-muted">Henüz etkinlik bulunmuyor.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = events
          .map(
            (event) => `
          <div class="event-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">${event.name}</h6>
              ${
                event.showInSlider
                  ? '<span class="slider-badge">Slider\'da</span>'
                  : ""
              }
            </div>

            <div class="row mb-2">
              <div class="col-sm-6">
                <small class="text-muted">
                  <i class="fas fa-calendar me-1"></i>${event.date.toLocaleDateString(
                    "tr-TR"
                  )}
                </small>
              </div>
              <div class="col-sm-6">
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i>${event.time || "00:00"}
                </small>
              </div>
              <div class="col-sm-6">
                <small class="text-muted">
                  <i class="fas fa-map-marker-alt me-1"></i>${
                    event.location || "Belirtilmemiş"
                  }
                </small>
              </div>
              <div class="col-sm-6">
                <small class="text-muted">
                  <i class="fas fa-tag me-1"></i>${event.category || "Genel"}
                </small>
              </div>
            </div>

            ${
              event.description
                ? `<p class="text-muted small mb-3">${event.description}</p>`
                : ""
            }

            ${
              event.category === "Tiyatro"
                ? `
              <div class="mb-3">
                <button class="btn btn-outline-info" style="opacity: 1 !important; visibility: visible !important; display: inline-block !important;" onclick="showStaffModal('${event.id}')">
                  <i class="fas fa-theater-masks me-1"></i>Kadroyu Görüntüle
                </button>
              </div>
            `
                : ""
            }

            ${
              canWrite
                ? `<div class="d-flex gap-2 flex-wrap mt-3 pt-2 border-top" style="opacity: 1 !important; visibility: visible !important; display: flex !important;">
                    <button class="btn btn-warning" style="opacity: 1 !important; visibility: visible !important; display: inline-block !important;" onclick="editEvent('${
                      event.id
                    }')">
                      <i class="fas fa-edit me-1"></i>Düzenle
                    </button>
                    <button class="btn btn-${
                      event.showInSlider ? "secondary" : "success"
                    }" style="opacity: 1 !important; visibility: visible !important; display: inline-block !important;"
                            onclick="toggleSlider('${
                              event.id
                            }', ${!event.showInSlider})">
                      <i class="fas fa-${
                        event.showInSlider ? "eye-slash" : "eye"
                      } me-1"></i>
                      ${
                        event.showInSlider
                          ? "Slider'dan Kaldır"
                          : "Slider'a Ekle"
                      }
                    </button>
                    <button class="btn btn-danger" style="opacity: 1 !important; visibility: visible !important; display: inline-block !important;" onclick="deleteEvent('${
                      event.id
                    }')">
                      <i class="fas fa-trash me-1"></i>Sil
                    </button>
                  </div>`
                : `<div class="mt-3 pt-2 border-top text-muted small">
                    <i class="fas fa-lock me-1"></i>Bu etkinlik üzerinde değişiklik yapma yetkiniz yok.
                  </div>`
            }
          </div>
        `
          )
          .join("");
      }

      // Update statistics
      function updateStats() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const totalEvents = events.length;
        const sliderEvents = events.filter((e) => e.showInSlider).length;
        const todayEvents = events.filter((e) => {
          const eventDate = new Date(e.date);
          eventDate.setHours(0, 0, 0, 0);
          return eventDate.getTime() === today.getTime();
        }).length;
        const upcomingEvents = events.filter((e) => e.date > new Date()).length;

        document.getElementById("totalEvents").textContent = totalEvents;
        document.getElementById("sliderEvents").textContent = sliderEvents;
        document.getElementById("todayEvents").textContent = todayEvents;
        document.getElementById("upcomingEvents").textContent = upcomingEvents;
      }

      // Upload image to Firebase Storage
      async function uploadImage(file, folder) {
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageRef = ref(storage, `${folder}/${fileName}`);

        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        return downloadURL;
      }

      // Setup upload buttons
      function setupUploadButtons() {
        // Upload event image
        const uploadImageBtn = document.getElementById("uploadImageBtn");
        if (uploadImageBtn) {
          uploadImageBtn.addEventListener("click", async () => {
            const fileInput = document.getElementById("eventImageFile");
            const file = fileInput.files[0];

            if (!file) {
              alert("Lütfen bir dosya seçin!");
              return;
            }

            try {
              const downloadURL = await uploadImage(file, "events");
              document.getElementById("eventImage").value = downloadURL;
              alert("Görsel başarıyla yüklendi!");
            } catch (error) {
              console.error("Error uploading image:", error);
              alert("Görsel yüklenirken hata oluştu!");
            }
          });
        }

        // Upload poster image
        const uploadPosterBtn = document.getElementById("uploadPosterBtn");
        if (uploadPosterBtn) {
          uploadPosterBtn.addEventListener("click", async () => {
            const fileInput = document.getElementById("eventPosterImageFile");
            const file = fileInput.files[0];

            if (!file) {
              alert("Lütfen bir dosya seçin!");
              return;
            }

            try {
              const downloadURL = await uploadImage(file, "posters");
              document.getElementById("eventPosterImage").value = downloadURL;
              alert("Poster başarıyla yüklendi!");
            } catch (error) {
              console.error("Error uploading poster:", error);
              alert("Poster yüklenirken hata oluştu!");
            }
          });
        }

        const uploadSquareImageBtn = document.getElementById(
          "uploadSquareImageBtn"
        );
        if (uploadSquareImageBtn) {
          uploadSquareImageBtn.addEventListener("click", async () => {
            const fileInput = document.getElementById("eventSquareImageFile");
            const file = fileInput.files[0];

            if (!file) {
              alert("Lütfen bir kare fotoğraf seçin!");
              return;
            }

            try {
              const downloadURL = await uploadImage(file, "event-square-images");
              document.getElementById("eventSquareImage").value = downloadURL;
              alert("Kare fotoğraf başarıyla yüklendi!");
            } catch (error) {
              console.error("Error uploading square image:", error);
              alert("Kare fotoğraf yüklenirken hata oluştu!");
            }
          });
        }

        // Upload staff event photo
        const uploadStaffEventPhotoBtn = document.getElementById(
          "uploadStaffEventPhoto"
        );
        if (uploadStaffEventPhotoBtn) {
          uploadStaffEventPhotoBtn.addEventListener("click", async () => {
            const fileInput = document.getElementById("staffEventPhotoFile");
            const file = fileInput.files[0];

            if (!file) {
              alert("Lütfen bir dosya seçin!");
              return;
            }

            try {
              const downloadURL = await uploadImage(file, "staff-event-photos");
              document.getElementById("staffEventPhotoUrl").value = downloadURL;
              alert("Fotoğraf başarıyla yüklendi!");
            } catch (error) {
              console.error("Error uploading staff event photo:", error);
              alert("Fotoğraf yüklenirken hata oluştu!");
            }
          });
        }
      }

      // Setup modal close buttons
      function setupModalCloseButtons() {
        // Helper: Hide modal compat (BS5/BS4)
        function hideModalById(modalId) {
          const el = document.getElementById(modalId);
          if (!el) return;
          try {
            if (window.bootstrap && bootstrap.Modal) {
              const inst = bootstrap.Modal.getInstance
                ? bootstrap.Modal.getInstance(el)
                : null;
              if (inst) {
                inst.hide();
                return;
              }
              // Fallback: create instance then hide
              const created = new bootstrap.Modal(el);
              created.hide();
              return;
            }
          } catch (e) {}
          // Bootstrap 4 fallback via jQuery
          if (window.$ && window.$.fn && window.$.fn.modal) {
            window.$(el).modal("hide");
            return;
          }
          // Last resort
          el.classList.remove("show");
          el.style.display = "none";
        }
        // Template modal close buttons
        document
          .querySelectorAll('#templateModal [data-bs-dismiss="modal"]')
          .forEach((button) => {
            button.addEventListener("click", function () {
              hideModalById("templateModal");
            });
          });

        // From template modal close buttons
        document
          .querySelectorAll('#fromTemplateModal [data-bs-dismiss="modal"]')
          .forEach((button) => {
            button.addEventListener("click", function () {
              hideModalById("fromTemplateModal");
            });
          });

        // Add staff modal close buttons
        document
          .querySelectorAll('#addStaffModal [data-bs-dismiss="modal"]')
          .forEach((button) => {
            button.addEventListener("click", function () {
              hideModalById("addStaffModal");
            });
          });

        // ESC key support for all modals
        document.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            // Close any open modal
            const modals = [
              "templateModal",
              "fromTemplateModal",
              "addStaffModal",
            ];
            modals.forEach((modalId) => hideModalById(modalId));
          }
        });
      }

      // Setup form toggle functionality
      function setupFormToggle() {
        const newEventBtn = document.getElementById("newEventBtn");
        const cancelFormBtn = document.getElementById("cancelFormBtn");
        const eventFormContainer =
          document.getElementById("eventFormContainer");
        const eventsListContainer = document.getElementById(
          "eventsListContainer"
        );
        const formTitle = document.getElementById("formTitle");

        // Yeni etkinlik butonu
        newEventBtn.addEventListener("click", function () {
          if (!canWrite) {
            alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
            return;
          }
          showEventForm("new");
        });

        // İptal butonu
        cancelFormBtn.addEventListener("click", function () {
          hideEventForm();
        });

        // Form göster
        function showEventForm(mode = "new") {
          // Liste gizle, form göster
          eventsListContainer.style.display = "none";
          eventFormContainer.style.display = "block";

          if (mode === "new") {
            formTitle.innerHTML =
              '<i class="fas fa-plus-circle me-2"></i>Yeni Etkinlik Ekle';
            document.getElementById("eventForm").reset();
            editingEventId = null;
            currentStaff = [];
            renderStaffList();
            document.getElementById("theaterExtras").style.display = "none";
          } else {
            formTitle.innerHTML =
              '<i class="fas fa-edit me-2"></i>Etkinlik Düzenle';
          }

          // Forma scroll
          eventFormContainer.scrollIntoView({ behavior: "smooth" });
        }

        // Form gizle, liste göster
        function hideEventForm() {
          // Form gizle, liste göster
          eventFormContainer.style.display = "none";
          eventsListContainer.style.display = "block";

          // Form temizle
          document.getElementById("eventForm").reset();
          editingEventId = null;
          currentStaff = [];
          renderStaffList();
          document.getElementById("theaterExtras").style.display = "none";

          // Listeye scroll
          eventsListContainer.scrollIntoView({ behavior: "smooth" });
        }

        // Global olarak erişilebilir yap
        if (!canWrite) {
          newEventBtn.disabled = true;
          newEventBtn.classList.add("disabled");
        }

        window.showEventForm = function (mode) {
          if (!canWrite) {
            alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
            return;
          }
          showEventForm(mode);
        };
        window.hideEventForm = hideEventForm;
      }

      // Setup theater features
      function setupTheaterFeatures() {
        const categorySelect = document.getElementById("eventCategory");
        const theaterExtras = document.getElementById("theaterExtras");
        const staffSearchInput = document.getElementById("staffSearchInput");
        const staffRoleFilter = document.getElementById("staffRoleFilter");
        const staffSearchResults =
          document.getElementById("staffSearchResults");

        // Load all staff members
        loadAllStaffMembers();

        // Kategori değişikliğini dinle
        categorySelect.addEventListener("change", function () {
          if (this.value === "Tiyatro") {
            theaterExtras.style.display = "block";
            loadAllStaffMembers();
          } else {
            theaterExtras.style.display = "none";
            currentStaff = [];
            renderStaffList();
            staffSearchResults.style.display = "none";
          }
        });

        // Arama inputunu dinle
        staffSearchInput.addEventListener("input", function () {
          const searchTerm = this.value.trim();
          if (searchTerm.length > 0) {
            searchStaff(searchTerm);
            staffSearchResults.style.display = "block";
          } else {
            staffSearchResults.style.display = "none";
          }
        });

        // Rol filtresini dinle
        staffRoleFilter.addEventListener("change", function () {
          const searchTerm = staffSearchInput.value.trim();
          if (searchTerm.length > 0) {
            searchStaff(searchTerm);
          }
        });
      }

      // Load all staff members from Firebase
      async function loadAllStaffMembers() {
        try {
          const staffRef = collection(db, "staff");
          const q = query(staffRef, orderBy("name", "asc"));
          const querySnapshot = await getDocs(q);

          allStaffMembers = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            allStaffMembers.push({
              id: doc.id,
              ...data,
            });
          });
        } catch (error) {
          console.error("Error loading staff members:", error);
        }
      }

      // Search staff members
      function searchStaff(searchTerm) {
        const roleFilter = document.getElementById("staffRoleFilter").value;

        let filteredStaff = allStaffMembers.filter((staff) =>
          staff.name.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (roleFilter) {
          filteredStaff = filteredStaff.filter(
            (staff) => staff.role === roleFilter
          );
        }

        renderSearchResults(filteredStaff);
      }

      // Render search results
      function renderSearchResults(staffList) {
        const container = document.getElementById("staffSearchContainer");

        if (staffList.length === 0) {
          container.innerHTML =
            '<small class="text-muted">Arama sonucu bulunamadı.</small>';
          return;
        }

        container.innerHTML = staffList
          .map(
            (staff) => `
          <div class="d-flex align-items-center justify-content-between p-2 mb-2 bg-white rounded border staff-search-item"
               style="cursor: pointer;" onclick="selectStaff('${staff.id}')">
            <div class="d-flex align-items-center">
              ${
                staff.photoUrl
                  ? `
                <img src="${staff.photoUrl}" alt="${staff.name}"
                     style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 10px;">
              `
                  : `
                <div style="width: 30px; height: 30px; border-radius: 50%; background: #e9ecef;
                           display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                  <i class="fas fa-user text-muted" style="font-size: 12px;"></i>
                </div>
              `
              }
              <div>
                <strong>${staff.name}</strong>
                <small class="d-block text-muted">${staff.role}</small>
              </div>
            </div>
            <i class="fas fa-plus text-success"></i>
          </div>
        `
          )
          .join("");
      }

      // Select staff member for event
      window.selectStaff = function (staffId) {
        const staff = allStaffMembers.find((s) => s.id === staffId);
        if (!staff) return;

        // Kategori kontrolü
        const category = document.getElementById("eventCategory").value;
        if (category !== "Tiyatro") {
          alert(
            "Kadro ekleme sadece Tiyatro etkinlikleri için kullanılabilir!\nLütfen önce kategoriyi 'Tiyatro' olarak seçin."
          );
          return;
        }

        // Aynı kişi farklı görevlerde yer alabilir; bu aşamada engelleme yok.

        // Modal'daki bilgileri doldur
        document.getElementById("selectedStaffPhoto").src =
          staff.photoUrl || "https://via.placeholder.com/80";
        document.getElementById("selectedStaffName").textContent = staff.name;
        document.getElementById(
          "selectedStaffOriginalRole"
        ).textContent = `Asıl Görev: ${staff.role}`;

        // Seçilen staff'ı geçici olarak sakla
        window.selectedStaffForEvent = {
          id: staffId,
          name: staff.name,
          originalRole: staff.role,
          photoUrl: staff.photoUrl,
          bio: staff.bio || "",
          filmography: staff.filmography || "",
        };

        // Modal form'unu temizle
        document.getElementById("staffEventRole").value = "";
        document.getElementById("staffCharacterName").value = "";
        document.getElementById("staffEventPhotoFile").value = "";
        document.getElementById("staffEventPhotoUrl").value = "";

        // Modal'ı aç
        const modal = new bootstrap.Modal(
          document.getElementById("addStaffModal")
        );
        modal.show();

        // Clear search
        document.getElementById("staffSearchInput").value = "";
        document.getElementById("staffSearchResults").style.display = "none";
      };

      // Kadro ekleme onayı
      document
        .getElementById("confirmAddStaff")
        .addEventListener("click", async function () {
          const eventRole = document.getElementById("staffEventRole").value;
          const characterName =
            document.getElementById("staffCharacterName").value;
          const eventPhotoUrl =
            document.getElementById("staffEventPhotoUrl").value;

          if (!eventRole) {
            alert("Lütfen bu etkinlikteki görevini seçin!");
            return;
          }

          // Kategori kontrolü
          const category = document.getElementById("eventCategory").value;
          if (category !== "Tiyatro") {
            alert(
              "Kadro ekleme sadece Tiyatro etkinlikleri için kullanılabilir!"
            );
            return;
          }

          const staffData = window.selectedStaffForEvent;

          // Aynı kişi-aynı görev kombinasyonunu engelle
          const existsSameCombo = currentStaff.some(
            (s) => s.staffId === staffData.id && s.role === eventRole
          );
          if (existsSameCombo) {
            alert(`${staffData.name} zaten '${eventRole}' olarak eklenmiş!`);
            return;
          }

          // Add to current staff with event-specific role
          const newStaffMember = {
            staffId: staffData.id,
            name: staffData.name,
            role: eventRole, // Bu etkinlikteki görevi
            originalRole: staffData.originalRole, // Asıl görevi
            characterName: characterName || "", // Karakter adı
            photoUrl: staffData.photoUrl || "", // Asıl fotoğraf
            eventPhotoUrl: eventPhotoUrl || "", // Bu oyun için özel fotoğraf
            bio: staffData.bio || "",
            filmography: staffData.filmography || "",
            id: Date.now(), // Geçici ID
          };

          currentStaff.push(newStaffMember);

          // Başarı uyarısı göster
          alert(`${staffData.name} kadroya başarıyla eklendi!`);

          // Eğer düzenleme modundaysa otomatik kaydet
          if (editingEventId) {
            try {
              await saveStaffToFirebase(editingEventId);
              console.log("Staff otomatik olarak kaydedildi");
            } catch (error) {
              console.error("Otomatik kaydetme hatası:", error);
              alert("Kadro kaydedilirken hata oluştu!");
            }
          } else {
            // Yeni etkinlik oluşturuyorsa uyarı ver
            console.log(
              "Yeni etkinlik - kadro geçici olarak eklendi, etkinliği kaydetmeyi unutmayın!"
            );
          }

          // Modal'ı kapat ve formu temizle
          // Close modal (compat with BS4/BS5)
          (function () {
            const el = document.getElementById("addStaffModal");
            if (!el) return;
            try {
              if (window.bootstrap && bootstrap.Modal) {
                const inst = bootstrap.Modal.getInstance
                  ? bootstrap.Modal.getInstance(el)
                  : null;
                if (inst) {
                  inst.hide();
                  return;
                }
                const created = new bootstrap.Modal(el);
                created.hide();
                return;
              }
            } catch (e) {}
            if (window.$ && window.$.fn && window.$.fn.modal) {
              window.$(el).modal("hide");
              return;
            }
            el.classList.remove("show");
            el.style.display = "none";
          })();
          document.getElementById("staffEventRole").value = "";
          document.getElementById("staffCharacterName").value = "";
          document.getElementById("staffEventPhotoFile").value = "";
          document.getElementById("staffEventPhotoUrl").value = "";

          // Update list
          renderStaffList();
        });

      // Kadro listesini render et
      function renderStaffList() {
        const container = document.getElementById("staffContainer");

        if (!container) {
          console.error("staffContainer not found!");
          return;
        }

        if (currentStaff.length === 0) {
          container.innerHTML =
            '<small class="text-muted">Henüz kadro eklenmedi.</small>';
          return;
        }

        container.innerHTML = currentStaff
          .map(
            (staff, index) => `
          <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-white rounded border shadow-sm staff-card-item" onclick="showEventStaffDetails(${index})" style="cursor:pointer;">
            <div class="d-flex align-items-center">
              ${
                staff.eventPhotoUrl || staff.photoUrl
                  ? `
                <img src="${staff.eventPhotoUrl || staff.photoUrl}" alt="${
                      staff.name
                    }"
                     style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 12px; ${
                       staff.eventPhotoUrl ? "border: 2px solid #007bff;" : ""
                     }">
              `
                  : `
                <div style="width: 60px; height: 60px; border-radius: 50%; background: #e9ecef;
                           display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                  <i class="fas fa-user text-muted fa-lg"></i>
                </div>
              `
              }
              <div>
                <div class="fw-bold">${staff.name}</div>
                <div class="small text-primary">${staff.role}${
              staff.characterName ? ` (${staff.characterName})` : ""
            }</div>
                ${
                  staff.originalRole && staff.originalRole !== staff.role
                    ? `<div class="small text-muted">Asıl Görev: ${staff.originalRole}</div>`
                    : ""
                }
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-info btn-sm" onclick="event.stopPropagation(); showEventStaffDetails(${index});">
                <i class="fas fa-info-circle me-1"></i>Detay
              </button>
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); removeStaff(${index});">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `
          )
          .join("");
      }

      function getFilmographyHtml(text) {
        if (!text) {
          return '<span class="text-muted">Henüz geçmiş proje bilgisi eklenmemiş.</span>';
        }

        const items = text
          .split(/\n+/)
          .map((item) => item.replace(/^[-•\s]+/, "").trim())
          .filter(Boolean);

        if (items.length === 0) {
          return '<span class="text-muted">Henüz geçmiş proje bilgisi eklenmemiş.</span>';
        }

        return `<ul class="mb-0 ps-3">${items
          .map((item) => `<li>${item}</li>`)
          .join("")}</ul>`;
      }

      window.showEventStaffDetails = function (index) {
        const staff = currentStaff[index];
        if (!staff) return;

        const photoContainer = document.getElementById("eventStaffDetailPhoto");
        if (staff.eventPhotoUrl || staff.photoUrl) {
          photoContainer.innerHTML = `<img src="${
            staff.eventPhotoUrl || staff.photoUrl
          }" alt="${staff.name}"
        style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #0d6efd;">`;
        } else {
          photoContainer.innerHTML = `<div style="width: 120px; height: 120px; border-radius: 50%; background: #e9ecef;
        display: flex; align-items: center; justify-content: center; border: 3px solid #6c757d;">
        <i class="fas fa-user fa-3x text-muted"></i></div>`;
        }

        document.getElementById("eventStaffDetailName").textContent =
          staff.name;
        document.getElementById("eventStaffDetailRole").textContent =
          staff.role;
        document.getElementById("eventStaffDetailOriginalRole").textContent =
          staff.originalRole
            ? `Asıl Görev: ${staff.originalRole}`
            : "Asıl Görev: -";
        document.getElementById("eventStaffDetailCharacter").textContent =
          staff.characterName
            ? `Karakter: ${staff.characterName}`
            : "Karakter: -";
        document.getElementById("eventStaffDetailBio").textContent =
          staff.bio || "-";
        document.getElementById("eventStaffDetailFilmography").innerHTML =
          getFilmographyHtml(staff.filmography);

        const modal = new bootstrap.Modal(
          document.getElementById("eventStaffDetailsModal")
        );
        modal.show();
      };

      // Kadro üyesini kaldır
      window.removeStaff = async function (index) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const removedStaff = currentStaff[index];

        if (!confirm(`${removedStaff.name} kadrodan çıkarılsın mı?`)) {
          return;
        }

        currentStaff.splice(index, 1);
        renderStaffList();

        // Eğer düzenleme modundaysa otomatik kaydet
        if (editingEventId) {
          try {
            await saveStaffToFirebase(editingEventId);
            console.log("Staff silme işlemi otomatik olarak kaydedildi");
            alert(`${removedStaff.name} kadrodan çıkarıldı!`);
            await logActivity(db, {
              userEmail: currentUserEmail,
              userName: currentUserName,
              action: "activity_staff_remove",
              page: "activity",
              targetId: editingEventId,
              targetType: "event",
              meta: {
                staffName: removedStaff.name,
                role: removedStaff.role,
              },
            });
          } catch (error) {
            console.error("Otomatik kaydetme hatası:", error);
            alert("Kadro güncellenirken hata oluştu!");
          }
        } else {
          alert(`${removedStaff.name} kadrodan çıkarıldı!`);
        }
      };

      // Kadro verilerini Firebase'e kaydet
      async function saveStaffToFirebase(eventId) {
        if (!canWrite) {
          throw new Error("Yetkiniz olmayan bir işlem denendi.");
        }
        if (currentStaff.length === 0) return;

        try {
          // Önce mevcut kadro verilerini temizle
          const staffCollectionRef = collection(
            db,
            "activity",
            eventId,
            "staff"
          );
          const existingStaff = await getDocs(staffCollectionRef);

          // Mevcut kadro üyelerini sil
          const deletePromises = existingStaff.docs.map((doc) =>
            deleteDoc(doc.ref)
          );
          await Promise.all(deletePromises);

          // Yeni kadro üyelerini ekle
          const addPromises = currentStaff.map(async (staff, index) => {
            const staffRef = doc(collection(db, "activity", eventId, "staff"));
            return setDoc(staffRef, {
              staffId: staff.staffId, // Firebase staff koleksiyonundaki ID
              role: staff.role, // Bu etkinlikteki görevi
              originalRole: staff.originalRole, // Asıl görevi
              characterName: staff.characterName || "", // Karakter adı
              name: staff.name,
              photoUrl: staff.photoUrl || "", // Asıl fotoğraf
              eventPhotoUrl: staff.eventPhotoUrl || "", // Bu oyun için özel fotoğraf
              bio: staff.bio || "",
              filmography: staff.filmography || "",
              order: index, // Sıralama için
              createdAt: Timestamp.now(),
            });
          });

          await Promise.all(addPromises);
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "activity_staff_sync",
            page: "activity",
            targetId: eventId,
            targetType: "event",
            meta: {
              memberCount: currentStaff.length,
            },
          });
        } catch (error) {
          console.error("Error saving staff:", error);
          throw error;
        }
      }

      // Kadro verilerini Firebase'den yükle
      async function loadStaffFromFirebase(eventId) {
        try {
          const staffRef = collection(db, "activity", eventId, "staff");
          const querySnapshot = await getDocs(staffRef);

          currentStaff = [];
          const staffArray = [];

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            staffArray.push({
              id: doc.id,
              staffId: data.staffId, // Firebase staff koleksiyonundaki ID
              role: data.role, // Bu etkinlikteki görevi
              originalRole: data.originalRole, // Asıl görevi
              characterName: data.characterName || "", // Karakter adı
              name: data.name,
              photoUrl: data.photoUrl || "", // Asıl fotoğraf
              eventPhotoUrl: data.eventPhotoUrl || "", // Bu oyun için özel fotoğraf
              bio: data.bio || "",
              filmography: data.filmography || "",
              order: data.order || 0, // Sıralama
            });
          });

          // Sıraya göre sırala
          currentStaff = staffArray.sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );

          renderStaffList();
        } catch (error) {
          console.error("Error loading staff:", error);
          currentStaff = [];
          renderStaffList();
        }
      }

      // Setup event form
      function setupEventForm() {
        const form = document.getElementById("eventForm");

        // Image upload handlers
        document
          .getElementById("uploadImageBtn")
          .addEventListener("click", async () => {
            const fileInput = document.getElementById("eventImageFile");
            const urlInput = document.getElementById("eventImage");

            if (fileInput.files[0]) {
              try {
                alert("Görsel yükleniyor...");
                const downloadURL = await uploadImage(
                  fileInput.files[0],
                  "event-images"
                );
                urlInput.value = downloadURL;
                alert("Görsel başarıyla yüklendi!");
              } catch (error) {
                alert("Görsel yüklenirken hata oluştu!");
              }
            } else {
              alert("Lütfen bir görsel seçin!");
            }
          });

        document
          .getElementById("uploadPosterBtn")
          .addEventListener("click", async () => {
            const fileInput = document.getElementById("eventPosterImageFile");
            const urlInput = document.getElementById("eventPosterImage");

            if (fileInput.files[0]) {
              try {
                alert("Poster yükleniyor...");
                const downloadURL = await uploadImage(
                  fileInput.files[0],
                  "event-posters"
                );
                urlInput.value = downloadURL;
                alert("Poster başarıyla yüklendi!");
              } catch (error) {
                alert("Poster yüklenirken hata oluştu!");
              }
            } else {
              alert("Lütfen bir poster seçin!");
            }
          });

        document
          .getElementById("uploadSquareImageBtn")
          .addEventListener("click", async () => {
            const fileInput = document.getElementById("eventSquareImageFile");
            const urlInput = document.getElementById("eventSquareImage");

            if (fileInput.files[0]) {
              try {
                alert("Kare fotoğraf yükleniyor...");
                const downloadURL = await uploadImage(
                  fileInput.files[0],
                  "event-square-images"
                );
                urlInput.value = downloadURL;
                alert("Kare fotoğraf başarıyla yüklendi!");
              } catch (error) {
                alert("Kare fotoğraf yüklenirken hata oluştu!");
              }
            } else {
              alert("Lütfen bir kare fotoğraf seçin!");
            }
          });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!canWrite) {
            alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
            return;
          }

          // Get location with coordinates
          const locationSelect = document.getElementById("eventLocation");
          const selectedOption =
            locationSelect.options[locationSelect.selectedIndex];
          const locationData = {
            name: locationSelect.value,
            coordinates: {
              lat: parseFloat(selectedOption.dataset.lat) || null,
              lng: parseFloat(selectedOption.dataset.lng) || null,
            },
          };

          const formData = {
            name: document.getElementById("eventName").value,
            description: document.getElementById("eventDescription").value,
            date: Timestamp.fromDate(
              new Date(
                document.getElementById("eventDate").value +
                  "T" +
                  document.getElementById("eventTime").value
              )
            ),
            time: document.getElementById("eventTime").value,
            location: locationData.name,
            locationCoordinates: locationData.coordinates,
            category: document.getElementById("eventCategory").value,
            imageUrl: document.getElementById("eventImage").value,
            posterImageUrl: document.getElementById("eventPosterImage").value,
            squareImageUrl: document.getElementById("eventSquareImage").value,
            registrationUrl: document.getElementById("registrationUrl").value,
            showInSlider: document.getElementById("showInSlider").checked,
            activityTicketInfo: document.getElementById("activityTicketInfo").checked,
          };

          try {
            let eventId;

            if (editingEventId) {
              // Update existing event
              const eventRef = doc(db, "activity", editingEventId);
              await updateDoc(eventRef, formData);
              eventId = editingEventId;

              // Tiyatro ise kadro verilerini kaydet
              if (formData.category === "Tiyatro") {
                await saveStaffToFirebase(eventId);
              }

              await logActivity(db, {
                userEmail: currentUserEmail,
                userName: currentUserName,
                action: "activity_event_update",
                page: "activity",
                targetId: eventId,
                targetType: "event",
                meta: {
                  name: formData.name,
                  category: formData.category,
                },
              });

              alert("Etkinlik güncellendi!");
            } else {
              // Add new event
              const docRef = await addDoc(collection(db, "activity"), formData);
              eventId = docRef.id;

              // Tiyatro ise kadro verilerini kaydet
              if (formData.category === "Tiyatro") {
                await saveStaffToFirebase(eventId);
              }

              await logActivity(db, {
                userEmail: currentUserEmail,
                userName: currentUserName,
                action: "activity_event_create",
                page: "activity",
                targetId: eventId,
                targetType: "event",
                meta: {
                  name: formData.name,
                  category: formData.category,
                },
              });

              alert("Etkinlik eklendi!");
            }

            // Şablon olarak kaydet seçeneği işaretliyse
            const saveAsTemplate =
              document.getElementById("saveAsTemplate").checked;
            if (saveAsTemplate && !editingEventId) {
              try {
                const templateData = {
                  ...formData,
                  title: formData.name, // Şablon başlığı
                  templateName: formData.name, // Geriye uyumluluk için
                  createdAt: Timestamp.now(),
                };

                // Tarih ve saat bilgilerini şablondan çıkar
                delete templateData.date;
                delete templateData.time;

                if (
                  formData.category === "Tiyatro" &&
                  Array.isArray(currentStaff) &&
                  currentStaff.length > 0
                ) {
                  templateData.theaterStaff = currentStaff.map((staff) => ({
                    staffId: staff.staffId || "",
                    name: staff.name || "",
                    role: staff.role || "",
                    originalRole: staff.originalRole || "",
                    characterName: staff.characterName || "",
                    photoUrl: staff.photoUrl || "",
                    eventPhotoUrl: staff.eventPhotoUrl || "",
                    bio: staff.bio || "",
                    filmography: staff.filmography || "",
                  }));
                } else {
                  delete templateData.theaterStaff;
                }

                await addDoc(collection(db, "eventTemplates"), templateData);
                await logActivity(db, {
                  userEmail: currentUserEmail,
                  userName: currentUserName,
                  action: "activity_template_create",
                  page: "activity",
                  targetId: eventId,
                  targetType: "eventTemplate",
                  meta: {
                    name: formData.name,
                    category: formData.category,
                  },
                });
                alert("Etkinlik şablon olarak da kaydedildi!");
              } catch (error) {
                console.error("Error saving template:", error);
                alert("Şablon kaydedilirken hata oluştu!");
              }
            }

            // Form'u gizle ve temizle
            hideEventForm();

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML =
              '<i class="fas fa-save me-2"></i>Etkinlik Ekle';
            loadEvents();
          } catch (error) {
            console.error("Error saving event:", error);
            alert("Etkinlik kaydedilirken hata oluştu!");
          }
        });
      }

      // Toggle slider visibility
      window.toggleSlider = async function (eventId, showInSlider) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        try {
          const eventRef = doc(db, "activity", eventId);
          await updateDoc(eventRef, { showInSlider });

          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: showInSlider
              ? "activity_event_slider_enable"
              : "activity_event_slider_disable",
            page: "activity",
            targetId: eventId,
            targetType: "event",
          });

          alert(
            showInSlider
              ? "Etkinlik slider'a eklendi!"
              : "Etkinlik slider'dan kaldırıldı!"
          );
          loadEvents();
        } catch (error) {
          console.error("Error updating slider status:", error);
          alert("İşlem sırasında hata oluştu!");
        }
      };

      // Delete event
      window.deleteEvent = async function (eventId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        if (!confirm("Bu etkinliği silmek istediğinizden emin misiniz?"))
          return;

        try {
          const event = events.find((e) => e.id === eventId);
          await deleteDoc(doc(db, "activity", eventId));
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "activity_event_delete",
            page: "activity",
            targetId: eventId,
            targetType: "event",
            meta: {
              name: event?.name || "",
            },
          });
          alert("Etkinlik silindi!");
          loadEvents();
        } catch (error) {
          console.error("Error deleting event:", error);
          alert("Etkinlik silinirken hata oluştu!");
        }
      };

      // Edit event
      window.editEvent = async function (eventId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const event = events.find((e) => e.id === eventId);
        if (!event) return;

        // Fill form with event data
        document.getElementById("eventName").value = event.name;
        document.getElementById("eventDescription").value =
          event.description || "";
        document.getElementById("eventDate").value = event.date
          .toISOString()
          .split("T")[0];
        document.getElementById("eventTime").value = event.time || "";
        document.getElementById("eventLocation").value = event.location || "";
        document.getElementById("eventCategory").value =
          event.category || "Konser";
        document.getElementById("eventImage").value = event.imageUrl || "";
        document.getElementById("eventPosterImage").value =
          event.posterImageUrl || "";
        document.getElementById("eventSquareImage").value =
          event.squareImageUrl || "";
        document.getElementById("registrationUrl").value =
          event.registrationUrl || "";
        document.getElementById("showInSlider").checked =
          event.showInSlider || false;
        document.getElementById("activityTicketInfo").checked =
          event.activityTicketInfo || false;

        // Tiyatro ise kadro verilerini yükle ve göster
        if (event.category === "Tiyatro") {
          document.getElementById("theaterExtras").style.display = "block";
          await loadStaffFromFirebase(eventId);
        } else {
          document.getElementById("theaterExtras").style.display = "none";
          currentStaff = [];
          renderStaffList();
        }

        // Show form in edit mode
        showEventForm("edit");

        // Change form to update mode
        editingEventId = eventId;
        const submitBtn = document.querySelector(
          '#eventForm button[type="submit"]'
        );
        submitBtn.innerHTML =
          '<i class="fas fa-save me-2"></i>Etkinlik Güncelle';
      };

      // Show staff modal
      window.showStaffModal = async function (eventId) {
        try {
          const staffRef = collection(db, "activity", eventId, "staff");
          const querySnapshot = await getDocs(staffRef);

          let staffList = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            staffList.push({
              role: data.role,
              name: data.name,
            });
          });

          if (staffList.length === 0) {
            alert("Bu etkinlik için henüz kadro bilgisi eklenmemiş.");
            return;
          }

          // Kadro listesini göster
          const staffText = staffList
            .map((staff) => `${staff.role}: ${staff.name}`)
            .join("\n");
          alert(`Tiyatro Kadrosu:\n\n${staffText}`);
        } catch (error) {
          console.error("Error loading staff:", error);
          alert("Kadro bilgileri yüklenirken hata oluştu!");
        }
      };

      // Make functions globally available
      window.loadEvents = loadEvents;
      // Template System Functions
      let eventTemplates = [];

      // Show templates modal
      async function showTemplatesModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("templateModal")
        );
        modal.show();
        await loadTemplates();
      }

      // Show from template modal
      async function showFromTemplateModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("fromTemplateModal")
        );
        modal.show();
        await loadTemplateOptions();
      }

      // Load template options for select
      async function loadTemplateOptions() {
        try {
          const templatesRef = collection(db, "eventTemplates");
          const querySnapshot = await getDocs(templatesRef);
          const select = document.getElementById("templateSelect");

          select.innerHTML = '<option value="">Şablon seçin...</option>';

          querySnapshot.forEach((doc) => {
            const template = doc.data();
            const option = document.createElement("option");
            option.value = doc.id;
            const title =
              template.title ||
              template.templateName ||
              template.name ||
              "İsimsiz Şablon";
            const category = template.category || "Genel";
            option.textContent = `${title} (${category})`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading template options:", error);
        }
      }

      // Preview selected template
      async function previewSelectedTemplate() {
        const templateId = document.getElementById("templateSelect").value;
        const preview = document.getElementById("selectedTemplatePreview");
        const content = document.getElementById("templatePreviewContent");

        if (!templateId) {
          preview.style.display = "none";
          return;
        }

        try {
          const templateRef = doc(db, "eventTemplates", templateId);
          const templateSnap = await getDoc(templateRef);

          if (templateSnap.exists()) {
            const template = templateSnap.data();
            const title =
              template.title ||
              template.templateName ||
              template.name ||
              "İsimsiz Şablon";
            const category = template.category || "Genel";
            const location = template.location || "Belirtilmemiş";
            const staffCount = Array.isArray(template.theaterStaff)
              ? template.theaterStaff.length
              : 0;

            content.innerHTML = `
              <h6 class="mb-2">${title}</h6>
              <p class="mb-2 text-muted">${
                template.description || "Açıklama yok"
              }</p>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-secondary">${category}</span>
                <span class="badge bg-info">${location}</span>
                ${
                  template.registrationUrl || template.registrationLink
                    ? '<span class="badge bg-success">Kayıt linki var</span>'
                    : ""
                }
                ${
                  staffCount > 0
                    ? `<span class="badge bg-warning text-dark">${staffCount} kadro üyesi</span>`
                    : ""
                }
              </div>
            `;
            preview.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading template preview:", error);
        }
      }

      // Delete template
      window.deleteTemplate = async function (templateId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        if (!confirm("Bu şablonu silmek istediğinizden emin misiniz?")) {
          return;
        }

        try {
          await deleteDoc(doc(db, "eventTemplates", templateId));
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "activity_template_delete",
            page: "activity",
            targetId: templateId,
            targetType: "eventTemplate",
          });
          alert("Şablon silindi!");
          loadTemplates();
        } catch (error) {
          console.error("Error deleting template:", error);
          alert("Şablon silinirken hata oluştu!");
        }
      };

      // Load templates from Firebase
      async function loadTemplates() {
        try {
          const templatesRef = collection(db, "eventTemplates");
          const querySnapshot = await getDocs(templatesRef);
          eventTemplates = [];

          querySnapshot.forEach((doc) => {
            eventTemplates.push({
              id: doc.id,
              ...doc.data(),
            });
          });

          renderTemplates();
        } catch (error) {
          console.error("Error loading templates:", error);
          document.getElementById("templatesContainer").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
              <p class="mt-2 text-danger">Şablonlar yüklenirken hata oluştu!</p>
            </div>
          `;
        }
      }

      // Render templates in modal
      function renderTemplates() {
        const container = document.getElementById("templatesContainer");

        if (eventTemplates.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-copy fa-2x text-muted"></i>
              <p class="mt-2 text-muted">Henüz şablon bulunmuyor.</p>
              <small class="text-muted">Etkinlik eklerken "Şablon olarak kaydet" seçeneğini işaretleyin.</small>
            </div>
          `;
          return;
        }

        container.innerHTML = eventTemplates
          .map(
            (template) => `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="card-title mb-2">
                    <i class="fas fa-${getCategoryIcon(
                      template.category || "Genel"
                    )} me-2 text-primary"></i>
                    ${
                      template.title ||
                      template.templateName ||
                      template.name ||
                      "İsimsiz Şablon"
                    }
                  </h6>
                  <p class="card-text text-muted mb-2">${
                    template.description || "Açıklama yok"
                  }</p>
                  <div class="d-flex gap-2 flex-wrap">
                    <span class="badge bg-secondary">${
                      template.category || "Genel"
                    }</span>
                    <span class="badge bg-info">${
                      template.location || "Belirtilmemiş"
                    }</span>
                    ${
                      template.theaterStaff
                        ? '<span class="badge bg-warning">Kadro var</span>'
                        : ""
                    }
                  </div>
                </div>
                ${
                  canWrite
                    ? `<div class="ms-3">
                        <button class="btn btn-danger btn-sm" onclick="deleteTemplate('${template.id}')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>`
                    : ""
                }
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Create event from template
      async function createEventFromTemplate() {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const templateId = document.getElementById("templateSelect").value;
        const eventDate = document.getElementById("templateEventDate").value;
        const eventTime = document.getElementById("templateEventTime").value;

        if (!templateId || !eventDate || !eventTime) {
          alert("Lütfen tüm alanları doldurun!");
          return;
        }

        try {
          // Get template data
          const templateRef = doc(db, "eventTemplates", templateId);
          const templateSnap = await getDoc(templateRef);

          if (!templateSnap.exists()) {
            alert("Şablon bulunamadı!");
            return;
          }

          const template = templateSnap.data();

          // Create new event from template
          const eventData = {
            ...template,
            name:
              template.title ||
              template.templateName ||
              template.name ||
              "İsimsiz Etkinlik",
            date: eventDate,
            time: eventTime,
            createdAt: Timestamp.now(),
          };

          // Şablon-specific alanları temizle
          delete eventData.title;
          delete eventData.templateName;

          // Add to events collection
          const docRef = await addDoc(collection(db, "activity"), eventData);

          if (
            Array.isArray(template.theaterStaff) &&
            template.theaterStaff.length > 0
          ) {
            await copyTemplateStaffToEvent(docRef.id, template.theaterStaff);
          }

          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "activity_event_create_from_template",
            page: "activity",
            targetId: docRef.id,
            targetType: "event",
            meta: {
              templateId,
              name: eventData.name,
            },
          });

          alert("Etkinlik başarıyla oluşturuldu!");

          // Close modal and refresh events
          (function closeTemplateModal() {
            try {
              const modalElement = document.getElementById("fromTemplateModal");
              if (!modalElement) return;
              if (window.bootstrap && bootstrap.Modal) {
                const instance = bootstrap.Modal.getInstance
                  ? bootstrap.Modal.getInstance(modalElement)
                  : null;
                if (instance && typeof instance.hide === "function") {
                  instance.hide();
                  return;
                }
                if (typeof bootstrap.Modal === "function") {
                  const newInstance = new bootstrap.Modal(modalElement);
                  if (newInstance && typeof newInstance.hide === "function") {
                    newInstance.hide();
                  }
                }
              } else {
                // Fallback for Bootstrap 4
                window.$ && window.$(modalElement).modal("hide");
              }
            } catch (closeError) {
              console.warn("Şablon modal kapatılırken hata:", closeError);
            }
          })();

          // Form temizle
          document.getElementById("templateEventDate").value = "";
          document.getElementById("templateEventTime").value = "";
          document.getElementById("templateSelect").value = "";
          document.getElementById("selectedTemplatePreview").style.display =
            "none";

          loadEvents();
        } catch (error) {
          console.error("Error creating event from template:", error);
          alert("Etkinlik oluşturulurken hata oluştu!");
        }
      }

      async function copyTemplateStaffToEvent(eventId, staffList) {
        try {
          const staffCollectionRef = collection(
            db,
            "activity",
            eventId,
            "staff"
          );
          const addPromises = staffList.map((staff, index) => {
            const staffRef = doc(staffCollectionRef);
            return setDoc(staffRef, {
              staffId: staff.staffId || "",
              name: staff.name || "",
              role: staff.role || "",
              originalRole: staff.originalRole || "",
              characterName: staff.characterName || "",
              photoUrl: staff.photoUrl || "",
              eventPhotoUrl: staff.eventPhotoUrl || "",
              bio: staff.bio || "",
              filmography: staff.filmography || "",
              order: index,
              createdAt: Timestamp.now(),
            });
          });
          await Promise.all(addPromises);
        } catch (error) {
          console.error(
            "Şablon kadrosu yeni etkinliğe aktarılırken hata:",
            error
          );
        }
      }

      // Get category icon
      function getCategoryIcon(category) {
        const icons = {
          Tiyatro: "theater-masks",
          Konser: "music",
          Sergi: "palette",
          Konferans: "microphone",
          Workshop: "tools",
          Festival: "star",
        };
        return icons[category] || "calendar";
      }
    </script>
  </body>
</html>
