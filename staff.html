<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ekip Yönetimi</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/mobile.css" />
    <link rel="stylesheet" href="css/tablet.css" />
    <link rel="stylesheet" href="css/activity.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      .offcanvas {
        transform: translateX(-100%);
        visibility: visible;
        transition: transform 0.3s ease;
        width: 400px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        height: 100vh;
        background-color: white;
      }

      .offcanvas.show {
        transform: translateX(0);
      }

      #mainContainer {
        transition: all 0.3s ease;
        width: 100%;
        margin-left: 0;
        position: relative;
        overflow-x: auto;
        padding-bottom: 60px;
      }

      #mainContainer.shifted {
        margin-left: 400px;
        width: calc(100% - 400px);
      }

      #menuButton {
        display: inline-block;
      }

      @media (max-width: 992px) {
        /* Tablet and Mobile: Hide offcanvas by default */
        .offcanvas {
          transform: translateX(-100%);
        }

        .offcanvas.show {
          transform: translateX(0);
        }

        #mainContainer.shifted {
          margin-left: 0;
          width: 100%;
        }

        /* Show menu button on mobile and tablet */
        #menuButton {
          display: inline-block;
        }

        /* Mobile overlay */
        .menu-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1040;
        }

        .menu-overlay.active {
          display: block;
        }
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow-x: auto;
        padding: 20px;
      }

      footer {
        height: 50px;
        background-color: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
      }

      .container-fluid {
        margin-bottom: 70px;
      }

      .stats-card {
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 20px;
      }

      .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .staff-member-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #007bff;
      }

      .staff-member-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .staff-photo-card {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e9ecef;
      }

      .staff-placeholder-card {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e9ecef;
      }

      .staff-details {
        min-height: 120px;
      }

      .permissions-badges {
        max-height: 60px;
        overflow-y: auto;
      }

      .card-actions {
        display: flex;
        gap: 8px;
      }

      /* Yeni Ekip Üyesi Ekle Butonu Stilleri */
      .staff-action-bar {
        background: #007bff !important;
        transition: all 0.3s ease;
        border: none;
      }

      .staff-action-bar:hover {
        background: #0056b3 !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4) !important;
      }

      .staff-action-btn {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        transition: all 0.2s ease;
      }

      .staff-action-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        transform: scale(1.05);
      }

      .staff-action-btn:focus {
        box-shadow: none !important;
        background: rgba(255, 255, 255, 0.1) !important;
      }

      .staff-card {
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .staff-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .staff-photo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #007bff;
        margin-right: 20px;
      }

      .staff-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        border: 3px solid #6c757d;
      }

      .role-badge {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 8px;
      }

      .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        border-bottom: 1px solid #dee2e6;
      }

      .form-control,
      .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
      }

      .btn {
        border-radius: 6px;
      }

      @media (max-width: 768px) {
        .offcanvas {
          width: 300px;
        }

        #mainContainer.shifted {
          margin-left: 300px;
          width: calc(100% - 300px);
        }

        .staff-card {
          text-align: center;
        }

        .staff-photo,
        .staff-placeholder {
          margin: 0 auto 15px auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div
        class="offcanvas offcanvas-start"
        data-bs-backdrop="false"
        id="adminPanelSideMenu"
      >
        <div
          class="offcanvas-header d-flex justify-content-start"
          style="margin-top: 2%"
        >
          <div>
            <img
              src="assets/274348852_320609883437173_4953649348556891409_n.jpg"
              alt="profilResmi"
              width="50px"
              height="50px"
              style="border-radius: 50px"
            />
          </div>
          <div class="offcanvas-title text-primary ms-4 h4">Yönetim Paneli</div>
        </div>

        <div
          class="offcanvas-body offcanvas-primary d-flex align-items-top flex-column"
        >
          <div class="list-group mb-auto p2">
            <a
              href="activity.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,2,2a"
              >Etkinlikler
            </a>
            <a
              href="staff.html"
              class="list-group-item list-group-item-action active"
              data-required-permissions="1,1a,10,10a"
              >Ekip</a
            >
            <a
              href="salooncontrol.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,3,3a"
              >Salon Takip</a
            >
        
            <a
              href="news.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,5,5a"
              >Haberler</a
            >
            <a
              href="library.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,8,8a"
              >Kütüphane</a
            >
            <a
              href="costume.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,9,9a"
              >Kostümler</a
            >
            <a
              href="messages.html"
              class="list-group-item list-group-item-action messages-link"
              style="display: none"
              data-required-permissions="1,1a,2,2a"
              >Mesajlar</a
            >
          </div>

          <div class="list-group">
            <a href="users.html" class="list-group-item list-group-item-action">
              Kullanıcılar
            </a>
            <button
              class="list-group-item list-group-item-action bg-danger text-white"
              id="logoutButton"
            >
              Çıkış Yap
            </button>
          </div>
        </div>
      </div>

      <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
      
      <div class="container-fluid" id="mainContainer">
        <div
          class="containerTitle d-flex justify-content-between border-bottom border-primary bg-white"
        >
          <button class="btn btn-primary mb-3 mt-3" id="menuButton">
            <i class="fas fa-times"></i>
          </button>
          <div class="h3 text-primary m-3 pb-0 flex-fill">Ekip Yönetimi</div>
        </div>

        <!-- İstatistikler -->
        <div class="row mt-4">
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #007bff, #0056b3)"
            >
              <div class="stats-number" id="totalStaff">0</div>
              <div class="stats-label">Toplam Ekip Üyesi</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #28a745, #20c997)"
            >
              <div class="stats-number" id="totalManagement">0</div>
              <div class="stats-label">Yönetim</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #ffc107, #fd7e14)"
            >
              <div class="stats-number" id="totalArtistic">0</div>
              <div class="stats-label">Sanat Ekibi</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #dc3545, #e83e8c)"
            >
              <div class="stats-number" id="totalAdministrative">0</div>
              <div class="stats-label">İdari Personel</div>
            </div>
          </div>
        </div>


        <!-- Ana İçerik -->
        <div class="row">
          <div class="col-12" id="staffFormContainer" style="display: none">
            <div class="card">
              <div
                class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">
                  <i class="fas fa-user-plus me-2"></i>Yeni Ekip Üyesi Ekle
                </h5>
                <button
                  class="btn btn-sm btn-outline-light"
                  id="hideFormButton"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="card-body">
                <form id="staffForm">
                  <div class="row">
                    <!-- Sol Sütun -->
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Ad Soyad *</label>
                        <input
                          type="text"
                          class="form-control"
                          id="staffName"
                          required
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Görev *</label>
                        <select class="form-select" id="staffRole" required>
                          <option value="">Görev Seçin</option>
                          <optgroup label="Yönetim">
                            <option value="Daire Başkanı">Daire Başkanı</option>
                            <option value="Şube Müdürü">Şube Müdürü</option>
                            <option value="Genel Sanat Yönetmeni">
                              Genel Sanat Yönetmeni
                            </option>
                          </optgroup>
                          <optgroup label="Sanat ve Prodüksiyon">
                            <option value="Yönetmen">Yönetmen</option>
                            <option value="Işık Tasarımcısı">
                              Işık Tasarımcısı
                            </option>
                            <option value="Dekor Tasarımcısı">
                              Dekor Tasarımcısı
                            </option>
                            <option value="Müzik Yönetmeni">Müzik Yönetmeni</option>
                            <option value="Oyuncu">Oyuncu</option>
                          </optgroup>
                          <optgroup label="İdari Personel">
                            <option value="Memur">Memur</option>
                            <option value="Teknik Görevli">Teknik Görevli</option>
                          </optgroup>
                          <optgroup label="Destek Personeli">
                            <option value="Çaycı">Çaycı</option>
                            <option value="Temizlikçi">Temizlikçi</option>
                          </optgroup>
                        </select>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Telefon</label>
                        <input
                          type="tel"
                          class="form-control"
                          id="staffPhone"
                          placeholder="0555 123 45 67"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">E-posta</label>
                        <input
                          type="email"
                          class="form-control"
                          id="staffEmail"
                          placeholder="ornek@email.com"
                          required
                        />
                      </div>
                    </div>

                    <!-- Sağ Sütun -->
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Biyografi</label>
                        <textarea
                          class="form-control"
                          id="staffBio"
                          rows="4"
                          placeholder="Kısa biyografi..."
                        ></textarea>
                      </div>
          <div class="mb-3">
            <label class="form-label">Geçmiş Projeler</label>
            <textarea
              class="form-control"
              id="staffFilmography"
              rows="4"
              placeholder="Her satıra bir proje veya görev yazın. Örnek:&#10;• Bir Delinin Hatıra Defteri - Oyuncu (2021)&#10;• Şehir Tiyatrosu - Işık Tasarımcısı (2020)"
            ></textarea>
            <small class="text-muted"
              ><i class="fas fa-info-circle me-1"></i>Listenizi satır satır
              yazabilirsiniz. Bu geçmiş proje bilgileri kadro detayında ve etkinliklerde
              görünecek.</small
            >
                      </div>

                      <div class="mb-3">
                    <label class="form-label">Yetki Kodları *</label>
                    <div
                      class="border rounded p-3"
                      style="background-color: #f8f9fa"
                    >
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_1"
                              value="1"
                            />
                            <label class="form-check-label" for="perm_1">
                              <strong>1 - Tüm Alanlar (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_1a"
                              value="1a"
                            />
                            <label class="form-check-label" for="perm_1a">
                              1a - Tüm Alanlar (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_2"
                              value="2"
                            />
                            <label class="form-check-label" for="perm_2">
                              <strong>2 - Etkinlikler (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_2a"
                              value="2a"
                            />
                            <label class="form-check-label" for="perm_2a">
                              2a - Etkinlikler (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_3"
                              value="3"
                            />
                            <label class="form-check-label" for="perm_3">
                              <strong>3 - Salon Takip (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_3a"
                              value="3a"
                            />
                            <label class="form-check-label" for="perm_3a">
                              3a - Salon Takip (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_4"
                              value="4"
                            />
                            <label class="form-check-label" for="perm_4">
                              <strong>4 - Duyurular (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_4a"
                              value="4a"
                            />
                            <label class="form-check-label" for="perm_4a">
                              4a - Duyurular (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_5"
                              value="5"
                            />
                            <label class="form-check-label" for="perm_5">
                              <strong>5 - Haberler (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_5a"
                              value="5a"
                            />
                            <label class="form-check-label" for="perm_5a">
                              5a - Haberler (Sadece Görme)
                            </label>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_6"
                              value="6"
                            />
                            <label class="form-check-label" for="perm_6">
                              <strong>6 - Foto Galeri (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_6a"
                              value="6a"
                            />
                            <label class="form-check-label" for="perm_6a">
                              6a - Foto Galeri (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_7"
                              value="7"
                            />
                            <label class="form-check-label" for="perm_7">
                              <strong>7 - Blog (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_7a"
                              value="7a"
                            />
                            <label class="form-check-label" for="perm_7a">
                              7a - Blog (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_8"
                              value="8"
                            />
                            <label class="form-check-label" for="perm_8">
                              <strong>8 - Kütüphane (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_8a"
                              value="8a"
                            />
                            <label class="form-check-label" for="perm_8a">
                              8a - Kütüphane (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_9"
                              value="9"
                            />
                            <label class="form-check-label" for="perm_9">
                              <strong>9 - Kostüm (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_9a"
                              value="9a"
                            />
                            <label class="form-check-label" for="perm_9a">
                              9a - Kostüm (Sadece Görme)
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_10"
                              value="10"
                            />
                            <label class="form-check-label" for="perm_10">
                              <strong>10 - Ekip (Yazma)</strong>
                            </label>
                          </div>
                          <div class="form-check mb-2">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              id="perm_10a"
                              value="10a"
                            />
                            <label class="form-check-label" for="perm_10a">
                              10a - Ekip (Sadece Görme)
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="mt-2">
                        <small class="text-muted">
                          <i class="fas fa-info-circle me-1"></i>
                          <strong>Kalın</strong> yazılanlar yazma yetkisi,
                          diğerleri sadece görme yetkisi verir.
                        </small>
                      </div>
                    </div>

                      <div class="mb-3">
                        <label class="form-label">Fotoğraf</label>
                        <div class="input-group mb-2">
                          <input
                            type="file"
                            class="form-control"
                            id="staffPhotoFile"
                            accept="image/*"
                          />
                          <button
                            class="btn btn-outline-secondary"
                            type="button"
                            id="uploadPhotoBtn"
                          >
                            <i class="fas fa-upload"></i> Yükle
                          </button>
                        </div>
                        <input
                          type="url"
                          class="form-control"
                          id="staffPhotoUrl"
                          placeholder="Fotoğraf URL'si"
                          readonly
                        />
                      </div>
                    </div>
                  </div>

                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save me-2"></i>Ekip Üyesi Ekle
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      id="cancelFormButton"
                    >
                      <i class="fas fa-arrow-left me-2"></i>Geri Dön
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Ekip Listesi -->
        <div class="row">
          <div class="col-12" id="staffListContainer">
            <div class="card">
              <div
                class="card-header text-white d-flex justify-content-between align-items-center staff-action-bar"
                style="box-shadow: 0 2px 10px rgba(0, 123, 255, 0.2);"
              >
                <h5 class="mb-0">
                  <i class="fas fa-users me-2"></i>Ekip Üyeleri
                </h5>
                <div class="d-flex gap-2" id="addMemberButtonContainer">
                  <button
                    type="button"
                    class="btn text-white border-0 staff-action-btn"
                    id="showAddMemberForm"
                    style="background: rgba(255, 255, 255, 0.1); border-radius: 6px;"
                  >
                    <i class="fas fa-plus me-1"></i>Yeni Ekip Üyesi Ekle
                  </button>
                  <button
                    class="btn text-white border-0 staff-action-btn"
                    onclick="loadStaff()"
                    style="background: rgba(255, 255, 255, 0.1); border-radius: 6px;"
                  >
                    <i class="fas fa-sync-alt me-1"></i>Yenile
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div id="staffContainer">
                  <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Ekip üyeleri yükleniyor...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p style="margin: 0">© 2024 EBB Kültür Sanat. Tüm hakları saklıdır.</p>
    </footer>

    <!-- Staff Detay Modal -->
    <div class="modal fade" id="staffDetailsModal" tabindex="-1" aria-labelledby="staffDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="staffDetailsModalLabel">
              <i class="fas fa-user me-2"></i>Ekip Üyesi Detayları
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4 text-center mb-3">
                <div id="detailStaffPhoto" class="mb-3"></div>
                <h5 id="detailStaffName" class="mb-2"></h5>
                <span id="detailStaffRole" class="badge bg-primary"></span>
              </div>
              <div class="col-md-8">
                <div class="mb-3">
                  <label class="form-label fw-bold"><i class="fas fa-envelope me-2"></i>E-posta:</label>
                  <p id="detailStaffEmail" class="mb-0 text-muted">-</p>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold"><i class="fas fa-phone me-2"></i>Telefon:</label>
                  <p id="detailStaffPhone" class="mb-0 text-muted">-</p>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold"><i class="fas fa-info-circle me-2"></i>Özgeçmiş:</label>
                  <p id="detailStaffBio" class="mb-0 text-muted">-</p>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold"><i class="fas fa-film me-2"></i>Geçmiş Projeler:</label>
                  <div id="detailStaffFilmography" class="text-muted">-</div>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold"><i class="fas fa-key me-2"></i>Yetkiler:</label>
                  <div id="detailStaffPermissions" class="d-flex flex-wrap gap-1"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Geçici Şifre Modal -->
    <div class="modal fade" id="temporaryPasswordModal" tabindex="-1" aria-labelledby="temporaryPasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="temporaryPasswordModalLabel">
              <i class="fas fa-key me-2"></i>Geçici Şifre Oluşturuldu
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Ekip üyesi başarıyla eklendi!</strong>
              <br>
              Aşağıdaki geçici şifreyi kullanıcıyla paylaşın. Kullanıcı ilk girişinde şifresini değiştirmesi gerekecektir.
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Kullanıcı Bilgileri:</label>
              <div class="p-3 bg-light rounded">
                <p class="mb-1"><strong>Ad Soyad:</strong> <span id="modalStaffName"></span></p>
                <p class="mb-0"><strong>E-posta:</strong> <span id="modalStaffEmail"></span></p>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Geçici Şifre:</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control font-monospace" 
                  id="temporaryPasswordInput" 
                  readonly
                  style="font-size: 1.1rem; font-weight: bold;"
                >
                <button 
                  class="btn btn-primary" 
                  type="button" 
                  id="copyPasswordBtn"
                  onclick="copyTemporaryPassword()"
                >
                  <i class="fas fa-copy me-1"></i>Kopyala
                </button>
              </div>
              <small class="text-muted d-block mt-2">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Bu şifreyi güvenli bir şekilde saklayın ve kullanıcıyla paylaşın.
              </small>
            </div>
          </div>
          <div class="modal-footer">
            <button 
              type="button" 
              class="btn btn-success" 
              id="shareWhatsAppBtn"
              onclick="shareViaWhatsApp()"
            >
              <i class="fab fa-whatsapp me-2"></i>WhatsApp ile Paylaş
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/main.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase -->
    <script type="module">
      // Firebase imports
      import {
        initializeApp,
        getApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        query,
        orderBy,
        where,
        limit,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
      import {
        ensureAuth,
        logActivity,
      } from "./js/authGuard.js";
      import {
        updateMessagesLinkVisibility,
        enforceLinkPermissions,
      } from "./js/offcanvas.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD978ixFjE9KVlNsm6-BYww3B6S4qPVLfQ",
        authDomain: "ebbkultursanatapp.firebaseapp.com",
        projectId: "ebbkultursanatapp",
        storageBucket: "ebbkultursanatapp.appspot.com",
        messagingSenderId: "540910775157",
        appId: "1:540910775157:web:4af35312414acf20bd013c",
        measurementId: "G-4JCKV13ER8",
      };

      // Initialize Firebase
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      const authContext = await ensureAuth({
        app,
        auth,
        db,
        requiredAny: ["1", "1a", "10", "10a"],
        writeCodes: ["1", "10"],
        pageName: "Ekip Yönetimi",
      }).catch((error) => {
        console.error("Yetkilendirme başarısız:", error);
        return null;
      });

      if (!authContext) {
        // guard already redirected
        throw new Error("Authorisation failed");
      }

      const currentUserEmail = authContext.user.email;
      const currentUserName =
        authContext.profile?.userName ||
        authContext.user.displayName ||
        "";
      const currentPermissions = authContext.permissions || [];
      const canWrite = authContext.canWrite;
      updateMessagesLinkVisibility(currentPermissions);
      enforceLinkPermissions(currentPermissions);

      if (!canWrite) {
        document.body.dataset.readOnly = "true";
      }

      window.currentUserEmail = currentUserEmail;
      window.currentUserName = currentUserName;
      window.currentUserPermissions = currentPermissions;
      window.canManageStaff = canWrite;

      // Global variables
      let staffMembers = [];
      let editingStaffId = null;

      // Form toggle functions
      function showStaffForm() {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        console.log("showStaffForm called");
        
        // Hide button and list
        const buttonContainer = document.getElementById("addMemberButtonContainer");
        const listContainer = document.getElementById("staffListContainer");
        const formContainer = document.getElementById("staffFormContainer");
        
        console.log("Elements found:", {
          buttonContainer: !!buttonContainer,
          listContainer: !!listContainer,
          formContainer: !!formContainer
        });
        
        if (buttonContainer) {
          buttonContainer.style.display = "none";
          buttonContainer.style.visibility = "hidden";
        }
        if (listContainer) {
          listContainer.style.display = "none";
          listContainer.style.visibility = "hidden";
          console.log("List hidden");
        }
        if (formContainer) {
          formContainer.style.display = "block";
          formContainer.style.visibility = "visible";
          formContainer.style.opacity = "1";
          console.log("Form shown");
          
          // Scroll to form
          setTimeout(() => {
            formContainer.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 100);
        }

        // Reset form title
        const titleElement = document.querySelector("#staffFormContainer .card-header h5");
        if (titleElement) {
          titleElement.innerHTML = '<i class="fas fa-user-plus me-2"></i>Yeni Ekip Üyesi Ekle';
        }
        
        // Reset form if not editing
        if (!editingStaffId) {
          const form = document.getElementById("staffForm");
          if (form) {
            form.reset();
            // Clear all permission checkboxes
            const permissionCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="perm_"]');
            permissionCheckboxes.forEach((checkbox) => {
              checkbox.checked = false;
            });
          }
        }
      }

      function hideStaffForm() {
        // Show button and list
        const buttonContainer = document.getElementById("addMemberButtonContainer");
        const listContainer = document.getElementById("staffListContainer");
        const formContainer = document.getElementById("staffFormContainer");
        
        if (buttonContainer) {
          buttonContainer.style.display = "flex";
          buttonContainer.style.visibility = "visible";
        }
        if (listContainer) {
          listContainer.style.display = "block";
          listContainer.style.visibility = "visible";
        }
        if (formContainer) {
          formContainer.style.display = "none";
          formContainer.style.visibility = "hidden";
        }

        // Reset form
        const form = document.getElementById("staffForm");
        if (form) form.reset();
        editingStaffId = null;

        // Reset submit button
        const submitBtn = document.querySelector('#staffForm button[type="submit"]');
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Ekip Üyesi Ekle';
        }

        // Clear all permission checkboxes
        const permissionCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="perm_"]');
        permissionCheckboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });
      }

      // Menu toggle functionality (salooncontrol style)
      function setupMenuToggle() {
        const menuButton = document.getElementById("menuButton");
        const adminPanel = document.getElementById("adminPanelSideMenu");
        const mainContainer = document.getElementById("mainContainer");

        if (!menuButton || !adminPanel || !mainContainer) {
          return;
        }

        const menuIcon = menuButton.querySelector("i");

        function toggleMenu() {
          adminPanel.classList.toggle("show");
          mainContainer.classList.toggle("shifted");
          
          // İkon değişimi
          if (menuIcon) {
            if (menuIcon.classList.contains("fa-bars")) {
              menuIcon.classList.remove("fa-bars");
              menuIcon.classList.add("fa-times");
            } else {
              menuIcon.classList.remove("fa-times");
              menuIcon.classList.add("fa-bars");
            }
          }
        }

        menuButton.addEventListener("click", function (e) {
          e.stopPropagation();
          toggleMenu();
        });

        // Initialize: menu açık başla (salooncontrol gibi)
        adminPanel.classList.add("show");
        mainContainer.classList.add("shifted");
        if (menuIcon) {
          menuIcon.classList.remove("fa-bars");
          menuIcon.classList.add("fa-times");
        }
      }

      function initializeStaffPage() {
        setupMenuToggle();

        const addMemberButtonContainer = document.getElementById(
          "addMemberButtonContainer"
        );
        const showAddMemberBtn = document.getElementById("showAddMemberForm");
        if (showAddMemberBtn) {
          showAddMemberBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Add member button clicked");
            showStaffForm();
            return false;
          });
        } else {
          console.error("showAddMemberForm button not found!");
        }

        if (!canWrite) {
          if (showAddMemberBtn) {
            showAddMemberBtn.disabled = true;
            showAddMemberBtn.classList.add("disabled");
          }
          if (addMemberButtonContainer) {
            addMemberButtonContainer.style.display = "none";
          }
          const formContainer = document.getElementById("staffFormContainer");
          if (formContainer) {
            formContainer.classList.add("d-none");
          }
        }

        const hideFormBtn = document.getElementById("hideFormButton");
        if (hideFormBtn) {
          hideFormBtn.addEventListener("click", function (e) {
            e.preventDefault();
            hideStaffForm();
          });
        }

        const cancelFormBtn = document.getElementById("cancelFormButton");
        if (cancelFormBtn) {
          cancelFormBtn.addEventListener("click", function (e) {
            e.preventDefault();
            hideStaffForm();
          });
        }

        // Initialize
        loadStaff();
        setupStaffForm();
        
        const staffListContainer = document.getElementById("staffListContainer");
        if (staffListContainer) {
          staffListContainer.style.display = "block";
        }
        const staffFormContainer = document.getElementById("staffFormContainer");
        if (staffFormContainer) {
          staffFormContainer.style.display = "none";
        }
        if (addMemberButtonContainer) {
          addMemberButtonContainer.style.display = "flex";
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeStaffPage);
      } else {
        initializeStaffPage();
      }

      // Load staff from Firebase
      async function loadStaff() {
        try {
          const staffRef = collection(db, "staff");
          const q = query(staffRef, orderBy("name", "asc"));
          const querySnapshot = await getDocs(q);

          staffMembers = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            staffMembers.push({
              id: doc.id,
              ...data,
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
            });
          });

          renderStaff();
          updateStats();
        } catch (error) {
          console.error("Error loading staff:", error);
          document.getElementById("staffContainer").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
              <p class="mt-2 text-danger">Ekip üyeleri yüklenirken hata oluştu!</p>
            </div>
          `;
        }
      }

      // Render staff list
      function renderStaff() {
        const container = document.getElementById("staffContainer");

        if (staffMembers.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-users fa-2x text-muted"></i>
              <p class="mt-2 text-muted">Henüz ekip üyesi bulunmuyor.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="row">
            ${staffMembers
              .map(
                (staff) => `
              <div class="col-lg-6 col-xl-4 mb-3">
                <div class="card h-100 staff-member-card">
                  <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                      ${
                        staff.photoUrl
                          ? `
                        <img src="${staff.photoUrl}" alt="${staff.name}" class="staff-photo-card me-3">
                      `
                          : `
                        <div class="staff-placeholder-card me-3">
                          <i class="fas fa-user fa-2x text-muted"></i>
                        </div>
                      `
                      }
                      <div class="flex-grow-1">
                        <div class="role-badge mb-2">${staff.role}</div>
                        <h5 class="card-title mb-2">${staff.name}</h5>
                      </div>
                    </div>
                    
                    <div class="staff-details">
                      ${
                        staff.permissions && staff.permissions.length > 0
                          ? `<div class="mb-3">
                              <small class="text-muted d-block mb-1"><i class="fas fa-key me-1"></i>Yetkiler:</small>
                              <div class="permissions-badges">
                                ${staff.permissions
                                  .map(
                                    (perm) =>
                                      `<span class="badge bg-secondary me-1 mb-1">${perm}</span>`
                                  )
                                  .join("")}
                              </div>
                             </div>`
                          : ""
                      }
                    </div>
                    
                    <div class="card-actions mt-auto pt-2 border-top d-flex justify-content-between align-items-center">
                      <button class="btn btn-info btn-sm" onclick="showStaffDetails('${staff.id}')">
                        <i class="fas fa-info-circle me-1"></i>Detay
                      </button>
                      ${
                        canWrite
                          ? `<div class="d-flex gap-2">
                              <button class="btn btn-warning btn-sm" onclick="editStaff('${staff.id}')">
                        <i class="fas fa-edit me-1"></i>Düzenle
                      </button>
                              ${
                                currentPermissions.includes("1") || currentPermissions.includes("1a")
                                  ? `<button class="btn btn-danger btn-sm" onclick="deleteStaff('${staff.id}')">
                        <i class="fas fa-trash me-1"></i>Sil
                                    </button>`
                                  : ""
                              }
                            </div>`
                          : ""
                      }
                    </div>
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
      }

      // Update statistics
      function updateStats() {
        const totalStaff = staffMembers.length;

        // Yönetim kadrosu
        const totalManagement = staffMembers.filter((s) =>
          ["Daire Başkanı", "Şube Müdürü", "Genel Sanat Yönetmeni"].includes(
            s.role
          )
        ).length;

        // Sanat ekibi
        const totalArtistic = staffMembers.filter((s) =>
          [
            "Yönetmen",
            "Işık Tasarımcısı",
            "Dekor Tasarımcısı",
            "Müzik Yönetmeni",
            "Oyuncu",
          ].includes(s.role)
        ).length;

        // İdari personel (Memur, Teknik Görevli, Çaycı, Temizlikçi)
        const totalAdministrative = staffMembers.filter((s) =>
          ["Memur", "Teknik Görevli", "Çaycı", "Temizlikçi"].includes(s.role)
        ).length;

        document.getElementById("totalStaff").textContent = totalStaff;
        document.getElementById("totalManagement").textContent =
          totalManagement;
        document.getElementById("totalArtistic").textContent = totalArtistic;
        document.getElementById("totalAdministrative").textContent =
          totalAdministrative;
      }

      // Upload image to Firebase Storage
      async function uploadImage(file, folder) {
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageRef = ref(storage, `${folder}/${fileName}`);

        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        return downloadURL;
      }

      // Setup staff form
      function setupStaffForm() {
        const form = document.getElementById("staffForm");

        // Photo upload handler
        document
          .getElementById("uploadPhotoBtn")
          .addEventListener("click", async () => {
            const fileInput = document.getElementById("staffPhotoFile");
            const urlInput = document.getElementById("staffPhotoUrl");
            const uploadBtn = document.getElementById("uploadPhotoBtn");

            if (fileInput.files[0]) {
              try {
                uploadBtn.innerHTML =
                  '<i class="fas fa-spinner fa-spin"></i> Yükleniyor...';
                uploadBtn.disabled = true;

                const downloadURL = await uploadImage(
                  fileInput.files[0],
                  "staff-photos"
                );
                urlInput.value = downloadURL;

                uploadBtn.innerHTML =
                  '<i class="fas fa-check text-success"></i> Yüklendi';
                setTimeout(() => {
                  uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Yükle';
                  uploadBtn.disabled = false;
                }, 2000);
              } catch (error) {
                console.error("Error uploading photo:", error);
                alert("Fotoğraf yüklenirken hata oluştu!");
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Yükle';
                uploadBtn.disabled = false;
              }
            } else {
              alert("Lütfen bir fotoğraf seçin!");
            }
          });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!canWrite) {
            alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
            return;
          }

          // Yetki kodlarını topla
          const permissions = [];
          const permissionCheckboxes = document.querySelectorAll(
            'input[type="checkbox"][id^="perm_"]'
          );
          permissionCheckboxes.forEach((checkbox) => {
            if (checkbox.checked) {
              permissions.push(checkbox.value);
            }
          });

          // En az bir yetki seçilmeli
          if (permissions.length === 0) {
            alert("Lütfen en az bir yetki kodu seçin!");
            return;
          }

          const formData = {
            name: document.getElementById("staffName").value.trim(),
            role: document.getElementById("staffRole").value,
            phone: document.getElementById("staffPhone").value.trim(),
            email: document.getElementById("staffEmail").value.trim().toLowerCase(),
            bio: document.getElementById("staffBio").value.trim(),
            filmography: document.getElementById("staffFilmography").value.trim(),
            photoUrl: document.getElementById("staffPhotoUrl").value.trim(),
            permissions: permissions,
          };

          // Ad Soyad kontrolü
          if (!formData.name) {
            alert("Lütfen ad soyad girin.");
            return;
          }

          // Ad Soyad'ın email formatında olmadığından emin ol
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (emailPattern.test(formData.name)) {
            alert("Ad Soyad alanına email adresi giremezsiniz. Lütfen gerçek ad soyad girin.");
            return;
          }

          if (!formData.email) {
            alert("Lütfen geçerli bir e-posta adresi girin.");
            return;
          }

          // Email ve telefon kontrolü - daha önce kullanılmış mı?
          if (!editingStaffId) {
            // Yeni ekleme durumunda kontrol et
            const existingStaffWithEmail = staffMembers.find(
              (s) => s.email && s.email.toLowerCase() === formData.email.toLowerCase()
            );
            if (existingStaffWithEmail) {
              alert("Bu e-posta adresi daha önce kullanılmış. Lütfen farklı bir e-posta adresi girin.");
              return;
            }

            if (formData.phone) {
              // Telefon numarasını normalize et (sadece rakamlar)
              const normalizedPhone = formData.phone.replace(/\D/g, '');
              const existingStaffWithPhone = staffMembers.find((s) => {
                if (!s.phone) return false;
                const existingPhone = s.phone.replace(/\D/g, '');
                return existingPhone === normalizedPhone;
              });
              if (existingStaffWithPhone) {
                alert("Bu telefon numarası daha önce kullanılmış. Lütfen farklı bir telefon numarası girin.");
                return;
              }
            }
          } else {
            // Düzenleme durumunda - sadece başka kayıtlarda kullanılmış mı kontrol et
            const existingStaffWithEmail = staffMembers.find(
              (s) => s.id !== editingStaffId && s.email && s.email.toLowerCase() === formData.email.toLowerCase()
            );
            if (existingStaffWithEmail) {
              alert("Bu e-posta adresi başka bir ekip üyesi tarafından kullanılıyor. Lütfen farklı bir e-posta adresi girin.");
              return;
            }

            if (formData.phone) {
              const normalizedPhone = formData.phone.replace(/\D/g, '');
              const existingStaffWithPhone = staffMembers.find((s) => {
                if (s.id === editingStaffId || !s.phone) return false;
                const existingPhone = s.phone.replace(/\D/g, '');
                return existingPhone === normalizedPhone;
              });
              if (existingStaffWithPhone) {
                alert("Bu telefon numarası başka bir ekip üyesi tarafından kullanılıyor. Lütfen farklı bir telefon numarası girin.");
                return;
              }
            }
          }

          try {
            if (editingStaffId) {
              // Update existing staff
              const staffRef = doc(db, "staff", editingStaffId);
              await updateDoc(staffRef, {
                ...formData,
                updatedAt: Timestamp.now(),
              });
              await syncStaffUserAccount({
                email: formData.email,
                name: formData.name,
                permissions,
                db,
                isUpdate: true,
              });
              await logActivity(db, {
                userEmail: currentUserEmail,
                userName: currentUserName,
                action: "staff_update",
                page: "staff",
                targetId: editingStaffId,
                targetType: "staff",
                meta: {
                  name: formData.name,
                  role: formData.role,
                },
              });
              alert("Ekip üyesi güncellendi!");
              // Hide form and show list
              hideStaffForm();
              loadStaff();
            } else {
              // Add new staff
              const docRef = await addDoc(collection(db, "staff"), {
                ...formData,
                createdAt: Timestamp.now(),
              });
              const syncResult = await syncStaffUserAccount({
                email: formData.email,
                name: formData.name,
                permissions,
                db,
                createIfMissing: true,
              });

              await logActivity(db, {
                userEmail: currentUserEmail,
                userName: currentUserName,
                action: "staff_create",
                page: "staff",
                targetId: docRef.id,
                targetType: "staff",
                meta: {
                  name: formData.name,
                  role: formData.role,
                },
              });

              if (syncResult?.temporaryPassword) {
                // Modal açılacak, form'u modal kapandığında gizleyeceğiz
                showTemporaryPasswordModal(syncResult.temporaryPassword, formData.name, formData.email, formData.phone);
                // Modal kapandığında form'u gizle ve listeyi yenile
                const modalElement = document.getElementById("temporaryPasswordModal");
                if (modalElement) {
                  modalElement.addEventListener('hidden.bs.modal', function onModalHidden() {
                    hideStaffForm();
                    loadStaff();
                    modalElement.removeEventListener('hidden.bs.modal', onModalHidden);
                  }, { once: true });
                }
              } else {
                alert("Ekip üyesi eklendi!");
            // Hide form and show list
            hideStaffForm();
            loadStaff();
              }
            }
          } catch (error) {
            console.error("Error saving staff:", error);
            alert("Ekip üyesi kaydedilirken hata oluştu!");
          }
        });
      }

      async function syncStaffUserAccount({
        email,
        name,
        permissions,
        db,
        isUpdate = false,
        createIfMissing = false,
      }) {
        if (!email) {
          return null;
        }

        const usersRef = collection(db, "Users");
        const userQuery = query(
          usersRef,
          where("userEmail", "==", email),
          limit(1)
        );
        const snapshot = await getDocs(userQuery);

        if (!snapshot.empty) {
          const userDoc = snapshot.docs[0];
          await updateDoc(doc(db, "Users", userDoc.id), {
            userName: name,
            userAuthority: permissions,
            updatedAt: Timestamp.now(),
            status: "active",
          });
          return { updated: true };
        }

        if (!createIfMissing) {
          return null;
        }

        const temporaryPassword = generateTemporaryPassword(10);
        const creationResult = await createFirebaseUser(email, temporaryPassword);

        if (creationResult === null) {
          return null;
        }

        if (creationResult?.skippedDueToExisting) {
          // User exists in Auth but not in Firestore. Proceed with Firestore record.
        }

        await addDoc(usersRef, {
          userEmail: email,
          userName: name,
          userAuthority: permissions,
          passwordEdit: false,
          status: "active",
          createdAt: Timestamp.now(),
          createdBy: currentUserEmail,
        });

        return {
          created: true,
          temporaryPassword,
        };
      }

      async function setStaffUserInactive(email) {
        if (!email) return;

        const usersRef = collection(db, "Users");
        const userQuery = query(
          usersRef,
          where("userEmail", "==", email),
          limit(1)
        );
        const snapshot = await getDocs(userQuery);

        const updates = snapshot.docs.map((docSnap) =>
          updateDoc(doc(db, "Users", docSnap.id), {
            userAuthority: [],
            status: "inactive",
            updatedAt: Timestamp.now(),
            deactivatedAt: Timestamp.now(),
          })
        );

        await Promise.all(updates);
      }

      // Delete Firebase Auth user (requires Admin SDK - using Identity Toolkit API)
      async function deleteFirebaseAuthUser(email) {
        if (!email) return null;

        try {
          // Note: This requires Admin SDK on backend. 
          // For client-side, we can only disable the user or use Cloud Functions.
          // Here we'll try to get the user ID first from Firestore, then attempt deletion
          // However, direct deletion from client-side is not possible for security reasons.
          // This function is a placeholder - actual deletion should be done via Cloud Function.
          
          // For now, we'll just log that deletion was attempted
          console.log(`Firebase Auth user deletion requested for: ${email}`);
          console.warn("Note: Firebase Auth user deletion requires Admin SDK. Consider implementing a Cloud Function.");
          
          // Return null to indicate deletion was not performed
          // In production, this should call a Cloud Function that uses Admin SDK
          return null;
        } catch (error) {
          console.error("Error attempting to delete Firebase Auth user:", error);
          return null;
        }
      }

      function generateTemporaryPassword(length = 10) {
        // Sadece harf ve sayılar (karışıklık yaratabilecek karakterler çıkarıldı: I, l, 1, O, 0)
        const alphabet =
          "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
        let password = "";
        for (let i = 0; i < length; i += 1) {
          const index = Math.floor(Math.random() * alphabet.length);
          password += alphabet[index];
        }
        return password;
      }

      async function createFirebaseUser(email, password) {
        try {
          const response = await fetch(
            `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email,
                password,
                returnSecureToken: false,
              }),
            }
          );

          const data = await response.json();

          if (data.error) {
            if (data.error.message === "EMAIL_EXISTS") {
              return { skippedDueToExisting: true };
            }
            throw new Error(data.error.message);
          }

          return { uid: data.localId };
        } catch (error) {
          console.error("Firebase Auth kullanıcısı oluşturulamadı:", error);
          alert(
            `Firebase kullanıcısı oluşturulurken hata oluştu: ${error.message}`
          );
          return null;
        }
      }

      // Delete staff
      window.deleteStaff = async function (staffId) {
        // Sadece yetki kodu "1" veya "1a" olan kullanıcılar silebilir
        if (!currentPermissions.includes("1") && !currentPermissions.includes("1a")) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok. Sadece tüm alanları yönetebilen kullanıcılar ekip üyesi silebilir.");
          return;
        }
        if (!confirm("Bu ekip üyesini silmek istediğinizden emin misiniz?"))
          return;

        try {
          const staff = staffMembers.find((s) => s.id === staffId);
          
          // 1. Firestore'dan staff kaydını sil
          await deleteDoc(doc(db, "staff", staffId));
          
          if (staff?.email) {
            // 2. Firestore'daki Users koleksiyonunda kullanıcıyı inactive yap
            await setStaffUserInactive(staff.email);
            
            // 3. Firebase Auth'tan kullanıcıyı sil (Not: Bu işlem Admin SDK gerektirir)
            // Client-side'dan direkt silme mümkün olmadığı için Cloud Function kullanılmalı
            // Şimdilik sadece Firestore'dan siliniyor, Auth'tan silme için Cloud Function gerekli
            await deleteFirebaseAuthUser(staff.email);
          }
          
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "staff_delete",
            page: "staff",
            targetId: staffId,
            targetType: "staff",
            meta: {
              name: staff?.name || "",
              role: staff?.role || "",
            },
          });
          alert("Ekip üyesi silindi!");
          loadStaff();
        } catch (error) {
          console.error("Error deleting staff:", error);
          alert("Ekip üyesi silinirken hata oluştu!");
        }
      };

      // Edit staff
      window.editStaff = function (staffId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const staff = staffMembers.find((s) => s.id === staffId);
        if (!staff) return;

        // Fill form with staff data
        document.getElementById("staffName").value = staff.name;
        document.getElementById("staffRole").value = staff.role;
        document.getElementById("staffPhone").value = staff.phone || "";
        // Email'i her zaman küçük harfe çevirerek göster
        document.getElementById("staffEmail").value = staff.email ? staff.email.toLowerCase() : "";
        document.getElementById("staffBio").value = staff.bio || "";
        document.getElementById("staffFilmography").value = staff.filmography || "";
        document.getElementById("staffPhotoUrl").value = staff.photoUrl || "";

        // Clear all permission checkboxes first
        const permissionCheckboxes = document.querySelectorAll(
          'input[type="checkbox"][id^="perm_"]'
        );
        permissionCheckboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });

        // Set permissions if they exist
        if (staff.permissions && staff.permissions.length > 0) {
          staff.permissions.forEach((permission) => {
            const checkbox = document.getElementById(`perm_${permission}`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        }

        // Change form to update mode
        editingStaffId = staffId;
        const submitBtn = document.querySelector(
          '#staffForm button[type="submit"]'
        );
        submitBtn.innerHTML =
          '<i class="fas fa-save me-2"></i>Ekip Üyesi Güncelle';

        // Update form title
        document.querySelector(
          "#staffFormContainer .card-header h5"
        ).innerHTML = '<i class="fas fa-edit me-2"></i>Ekip Üyesi Düzenle';

        // Show form
        showStaffForm();
        document
          .getElementById("staffForm")
          .scrollIntoView({ behavior: "smooth" });
      };

      // Show temporary password modal
      function showTemporaryPasswordModal(password, staffName, staffEmail, staffPhone) {
        const modalElement = document.getElementById("temporaryPasswordModal");
        if (!modalElement) {
          console.error("Modal element not found!");
          alert(`Ekip üyesi eklendi!\n\nGeçici şifre: ${password}\nLütfen bu bilgiyi güvenli bir şekilde kullanıcıyla paylaşın.`);
          return;
        }

        document.getElementById("temporaryPasswordInput").value = password;
        document.getElementById("modalStaffName").textContent = staffName;
        // Email'i her zaman küçük harfe çevirerek göster
        document.getElementById("modalStaffEmail").textContent = staffEmail ? staffEmail.toLowerCase() : "";
        
        // Store data for WhatsApp sharing
        window.tempPasswordData = {
          password,
          staffName,
          staffEmail,
          staffPhone: staffPhone || ""
        };
        
        // Modal'ı aç
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Modal'ın açıldığını kontrol et
        setTimeout(() => {
          if (!modalElement.classList.contains('show')) {
            console.warn("Modal did not open, showing alert instead");
            alert(`Ekip üyesi eklendi!\n\nGeçici şifre: ${password}\nLütfen bu bilgiyi güvenli bir şekilde kullanıcıyla paylaşın.`);
          }
        }, 500);
      }

      // Copy temporary password to clipboard
      window.copyTemporaryPassword = function() {
        const passwordInput = document.getElementById("temporaryPasswordInput");
        passwordInput.select();
        passwordInput.setSelectionRange(0, 99999); // For mobile devices
        
        try {
          document.execCommand("copy");
          const copyBtn = document.getElementById("copyPasswordBtn");
          const originalText = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Kopyalandı!';
          copyBtn.classList.remove("btn-primary");
          copyBtn.classList.add("btn-success");
          
          setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove("btn-success");
            copyBtn.classList.add("btn-primary");
          }, 2000);
        } catch (err) {
          // Fallback: modern clipboard API
          navigator.clipboard.writeText(passwordInput.value).then(() => {
            const copyBtn = document.getElementById("copyPasswordBtn");
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Kopyalandı!';
            copyBtn.classList.remove("btn-primary");
            copyBtn.classList.add("btn-success");
            
            setTimeout(() => {
              copyBtn.innerHTML = originalText;
              copyBtn.classList.remove("btn-success");
              copyBtn.classList.add("btn-primary");
            }, 2000);
          }).catch(() => {
            alert("Şifre kopyalanamadı. Lütfen manuel olarak kopyalayın.");
          });
        }
      };

      // Share via WhatsApp
      window.shareViaWhatsApp = function() {
        if (!window.tempPasswordData) {
          alert("Paylaşım verisi bulunamadı.");
          return;
        }

        const { password, staffName, staffEmail, staffPhone } = window.tempPasswordData;
        
        // Format phone number for WhatsApp (remove spaces, dashes, parentheses, and ensure it starts with country code)
        let phoneNumber = "";
        if (staffPhone) {
          // Remove all non-digit characters
          phoneNumber = staffPhone.replace(/\D/g, '');
          
          // If it starts with 0, replace with 90 (Turkey country code)
          if (phoneNumber.startsWith('0')) {
            phoneNumber = '90' + phoneNumber.substring(1);
          }
          // If it doesn't start with country code, add 90
          else if (!phoneNumber.startsWith('90')) {
            phoneNumber = '90' + phoneNumber;
          }
        }
        
        // Get current website URL
        const websiteUrl = window.location.origin;
        const loginUrl = `${websiteUrl}/adminpanellogin.html`;
        
        // Create a nice formatted message
        const message = `🎭 *EBB Kültür Sanat - Yönetim Paneli Giriş Bilgileri*

Merhaba ${staffName},

Yönetim paneline erişim bilgileriniz aşağıda yer almaktadır:

👤 *Kullanıcı Bilgileri:*
• Ad Soyad: ${staffName}
• E-posta: ${staffEmail}

🔑 *Geçici Şifre:*
${password}

⚠️ *Önemli:* İlk girişinizde şifrenizi değiştirmeniz gerekecektir.

🌐 *Giriş Adresi:*
${loginUrl}

📱 *Nasıl Giriş Yapılır?*
1. Yukarıdaki giriş adresine tıklayın veya tarayıcınıza yapıştırın
2. E-posta adresinizi girin
3. Geçici şifrenizi girin
4. İlk girişte yeni şifrenizi belirleyin

Sorularınız için bizimle iletişime geçebilirsiniz.

İyi çalışmalar! 🎨`;

        // Encode message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Open WhatsApp - if phone number exists, send directly to that number
        let whatsappUrl;
        if (phoneNumber) {
          whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        } else {
          // If no phone number, open WhatsApp without specific number
          whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        }
        
        window.open(whatsappUrl, '_blank');
      };

      function renderFilmographyList(text, targetElementId) {
        const target = document.getElementById(targetElementId);
        if (!target) return;

        if (!text) {
        target.innerHTML = '<span class="text-muted">Henüz geçmiş proje bilgisi eklenmemiş.</span>';
          return;
        }

        const items = text
          .split(/\n+/)
          .map((item) => item.replace(/^[-•\s]+/, "").trim())
          .filter(Boolean);

        if (items.length === 0) {
        target.innerHTML = '<span class="text-muted">Henüz geçmiş proje bilgisi eklenmemiş.</span>';
          return;
        }

        target.innerHTML = `<ul class="mb-0 ps-3">${items
          .map((item) => `<li>${item}</li>`)
          .join("")}</ul>`;
      }

      // Show staff details modal
      window.showStaffDetails = function(staffId) {
        const staff = staffMembers.find((s) => s.id === staffId);
        if (!staff) return;

        // Set photo
        const photoContainer = document.getElementById("detailStaffPhoto");
        if (staff.photoUrl) {
          photoContainer.innerHTML = `<img src="${staff.photoUrl}" alt="${staff.name}" class="staff-photo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;">`;
        } else {
          photoContainer.innerHTML = `<div class="staff-placeholder" style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #e9ecef, #dee2e6); display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 3px solid #6c757d;"><i class="fas fa-user fa-4x text-muted"></i></div>`;
        }

        // Set name and role
        document.getElementById("detailStaffName").textContent = staff.name;
        document.getElementById("detailStaffRole").textContent = staff.role;

        // Set email
        document.getElementById("detailStaffEmail").textContent = staff.email || "-";

        // Set phone
        document.getElementById("detailStaffPhone").textContent = staff.phone || "-";

        // Set bio
        document.getElementById("detailStaffBio").textContent = staff.bio || "-";
        renderFilmographyList(staff.filmography, "detailStaffFilmography");

        // Set permissions
        const permissionsContainer = document.getElementById("detailStaffPermissions");
        if (staff.permissions && staff.permissions.length > 0) {
          permissionsContainer.innerHTML = staff.permissions
            .map((perm) => `<span class="badge bg-secondary">${perm}</span>`)
            .join("");
        } else {
          permissionsContainer.innerHTML = '<span class="text-muted">Yetki tanımlanmamış</span>';
        }

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById("staffDetailsModal"));
        modal.show();
      };

      // Make functions globally available
      window.loadStaff = loadStaff;
    </script>
  </body>
</html>
