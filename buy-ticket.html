<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bilet Al - EBB Kültür Sanat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/global.css" />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Inter", sans-serif;
      }
      .page-hero {
        background: rgba(0, 0, 0, 0.35);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
      }
      .page-hero h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
      .seating-chart-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        margin-bottom: 2rem;
        direction: ltr;
      }
      .seating-scroll-area {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .seating-scroll-inner { display: inline-block; min-width: 100%; }
      .stage-area {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-weight: 600;
      }
      .seating-section {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .section-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #2c3e50;
      }
      .seat-row {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 0.4rem;
        justify-content: center;
        flex-wrap: nowrap;
      }
      .seat {
        width: 32px;
        height: 32px;
        min-width: 24px;
        min-height: 24px;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        color: #495057;
      }
      .seat.available {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
      }
      .seat.reserved {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }
      .seat.occupied {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
        cursor: not-allowed;
      }
      .seat.disabled {
        background: #e9ecef;
        cursor: not-allowed;
        visibility: hidden;
        pointer-events: none;
      }
      .seat:hover:not(.occupied):not(.disabled) {
        transform: scale(1.08);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      @media (max-width: 768px) {
        .seat { width: 26px; height: 26px; font-size: 0.5rem; }
      }
      .legend {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        flex-wrap: wrap;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
      }
      .legend-item { display: flex; align-items: center; gap: 0.5rem; }
      .legend-color {
        width: 22px;
        height: 22px;
        border-radius: 4px;
        border: 2px solid;
      }
      .btn-bilet-al {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 25px;
        padding: 12px 32px;
        color: white;
        font-weight: 600;
      }
      .btn-bilet-al:hover { color: white; transform: translateY(-2px); }
      .btn-bilet-al:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
      .loading-spinner, .error-message {
        text-align: center;
        padding: 3rem;
        color: white;
      }
      .step-panel .card { max-width: 560px; margin: 0 auto; }
      .seat-count-btn.active { background: var(--bs-primary); color: white; border-color: var(--bs-primary); }
    </style>
  </head>
  <body class="has-fixed-header">
    <header class="header">
      <nav class="nav container">
        <a href="index.html" class="logo">
          <img src="assets/Asset 1.png" alt="EBB Logo" />
          <span>EBB Kültür Sanat</span>
        </a>
        <ul class="nav-menu" id="navMenu">
          <li><a href="index.html#home" class="nav-link">Ana Sayfa</a></li>
          <li><a href="ourhalls.html" class="nav-link">Salonlarımız</a></li>
          <li><a href="news-list.html" class="nav-link">Haberler</a></li>
          <li><a href="index.html#contact" class="nav-link">İletişim</a></li>
          <li><a href="biletlerim.html" class="nav-link">Biletlerim</a></li>
        </ul>
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
      </nav>
    </header>

    <div id="loadingState" class="loading-spinner">
      <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
      <p>Etkinlik ve koltuklar yükleniyor...</p>
    </div>

    <div id="errorState" class="error-message" style="display: none;">
      <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
      <h4>Etkinlik Bulunamadı</h4>
      <p>Geçersiz veya biletli olmayan bir etkinlik.</p>
      <a href="calendar.html" class="btn btn-light">Takvime Dön</a>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="page-hero">
        <div class="container">
          <h1 id="eventTitle">Etkinlik</h1>
          <p class="mb-0" id="eventDateLocation">Tarih · Konum</p>
        </div>
      </div>

      <!-- Adım 0: Üye girişi / Üye ol -->
      <div id="stepAuth" class="step-panel container pb-5" style="display: none;">
        <div class="card shadow-sm border-0 rounded-3 p-4 p-md-5">
          <h5 class="mb-3">Bilet almak için giriş yapın veya üye olun</h5>
          <p class="text-muted small mb-4">Devam edebilmek için üye girişi yapın. Üye değilseniz üyelik oluşturun.</p>
          <div class="d-flex flex-column flex-sm-row gap-2">
            <button type="button" class="btn btn-primary flex-fill" id="btnUyeGiris">
              <i class="fas fa-sign-in-alt me-2"></i>Üye Girişi Yap
            </button>
            <button type="button" class="btn btn-outline-primary flex-fill" id="btnUyeOl">
              <i class="fas fa-user-plus me-2"></i>Üye Ol
            </button>
          </div>
        </div>
      </div>

      <!-- Adım 1: Koltuk sayısı -->
      <div id="stepSeatCount" class="step-panel container pb-5" style="display: none;">
        <div class="card shadow-sm border-0 rounded-3 p-4 p-md-5">
          <h5 class="mb-3">Kaç koltuk almak istiyorsunuz?</h5>
          <p class="text-muted small mb-3">En fazla 5 koltuk seçebilirsiniz.</p>
          <div class="d-flex flex-wrap gap-2 mb-4" id="seatCountButtons">
            <button type="button" class="btn btn-outline-primary seat-count-btn" data-count="1">1</button>
            <button type="button" class="btn btn-outline-primary seat-count-btn" data-count="2">2</button>
            <button type="button" class="btn btn-outline-primary seat-count-btn" data-count="3">3</button>
            <button type="button" class="btn btn-outline-primary seat-count-btn" data-count="4">4</button>
            <button type="button" class="btn btn-outline-primary seat-count-btn" data-count="5">5</button>
          </div>
          <p class="text-muted small mb-0" id="seatCountSelected">Seçim: —</p>
          <button type="button" class="btn btn-bilet-al mt-3" id="btnSeatCountNext" disabled>
            <i class="fas fa-arrow-right me-2"></i>Devam Et
          </button>
        </div>
      </div>

      <!-- Adım 2: Koltuk seçimi -->
      <div id="stepSeatSelect" class="step-panel container pb-5" style="display: none;">
        <div class="seating-chart-container">
          <p class="text-muted small mb-2" id="seatSelectHint">1 koltuk seçin.</p>
          <div class="seating-scroll-area">
            <div class="seating-scroll-inner">
              <div class="stage-area">SAHNE</div>
              <div id="seatingChartContent"></div>
            </div>
          </div>
          <div class="legend">
            <div class="legend-item"><span class="legend-color" style="background:#d4edda;border-color:#28a745;"></span><span>Boş</span></div>
            <div class="legend-item"><span class="legend-color" style="background:#fff3cd;border-color:#ffc107;"></span><span>Seçiminiz</span></div>
            <div class="legend-item"><span class="legend-color" style="background:#f8d7da;border-color:#dc3545;"></span><span>Dolu</span></div>
          </div>
          <div class="text-center">
            <p class="text-muted small mb-2">Seçilen: <span id="selectedSeatsLabel">—</span></p>
            <button type="button" class="btn btn-bilet-al" id="btnSeatSelectNext" disabled>
              <i class="fas fa-arrow-right me-2"></i>Devam Et
            </button>
          </div>
        </div>
      </div>

      <!-- Adım 3: Bilgiler -->
      <div id="stepInfo" class="step-panel container pb-5" style="display: none;">
        <div class="card shadow-sm border-0 rounded-3 p-4 p-md-5">
          <h5 class="mb-3">İletişim bilgileriniz</h5>
          <p class="text-muted small mb-4">Daha önce bilet aldıysanız bilgileriniz otomatik gelir.</p>
          <form id="buyTicketForm">
            <div class="mb-3">
              <label class="form-label">Ad <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="buyFirstName" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Soyad <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="buyLastName" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Telefon <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="buyPhone" required />
            </div>
            <div class="mb-3">
              <label class="form-label">E-posta <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="buyEmail" required />
            </div>
          </form>
          <button type="button" class="btn btn-bilet-al" id="btnInfoNext">
            <i class="fas fa-arrow-right me-2"></i>Devam Et
          </button>
        </div>
      </div>

      <!-- Adım 4: Özet -->
      <div id="stepSummary" class="step-panel container pb-5" style="display: none;">
        <div class="card shadow-sm border-0 rounded-3 p-4 p-md-5">
          <h5 class="mb-4">Rezervasyon özeti</h5>
          <div class="mb-3">
            <strong>Etkinlik:</strong> <span id="summaryEventName">—</span>
          </div>
          <div class="mb-3">
            <strong>Koltuklar:</strong> <span id="summarySeats">—</span>
          </div>
          <div class="mb-3">
            <strong>Ad Soyad:</strong> <span id="summaryName">—</span>
          </div>
          <div class="mb-3">
            <strong>Telefon:</strong> <span id="summaryPhone">—</span>
          </div>
          <div class="mb-4">
            <strong>E-posta:</strong> <span id="summaryEmail">—</span>
          </div>
          <button type="button" class="btn btn-bilet-al" id="btnCompleteReservation">
            <i class="fas fa-check me-2"></i>Rezervasyonu Tamamla
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Üye girişi -->
    <div class="modal fade" id="loginModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Üye Girişi</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label">E-posta</label>
                <input type="email" class="form-control" id="loginEmail" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Şifre</label>
                <input type="password" class="form-control" id="loginPassword" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
            <button type="button" class="btn btn-primary" id="btnLoginSubmit">Giriş Yap</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Üye ol -->
    <div class="modal fade" id="signupModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Üye Ol</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="signupForm">
              <div class="mb-3">
                <label class="form-label">E-posta</label>
                <input type="email" class="form-control" id="signupEmail" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Şifre (en az 6 karakter)</label>
                <input type="password" class="form-control" id="signupPassword" required minlength="6" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
            <button type="button" class="btn btn-primary" id="btnSignupSubmit">Üye Ol</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        getDocs,
        query,
        where,
        setDoc,
        addDoc,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD978ixFjE9KVlNsm6-BYww3B6S4qPVLfQ",
        authDomain: "ebbkultursanatapp.firebaseapp.com",
        projectId: "ebbkultursanatapp",
        storageBucket: "ebbkultursanatapp.appspot.com",
        messagingSenderId: "540910775157",
        appId: "1:540910775157:web:4af35312414acf20bd013c",
        measurementId: "G-4JCKV13ER8",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      function getEventIdFromUrl() {
        return new URLSearchParams(window.location.search).get("eventId");
      }

      let currentEventId = null;
      let currentEvent = null;
      let selectedSeatIds = new Set();
      let selectedSeatCount = 0; // Adım 1'de seçilen koltuk sayısı (1-5)
      let seatStatusMapCache = null;

      function showStep(stepId) {
        document.querySelectorAll(".step-panel").forEach((el) => { el.style.display = "none"; });
        const panel = document.getElementById(stepId);
        if (panel) panel.style.display = "block";
      }

      function updateSelectedLabel() {
        const el = document.getElementById("selectedSeatsLabel");
        const btn = document.getElementById("btnSeatSelectNext");
        if (!el) return;
        const seats = [...selectedSeatIds];
        const labels = seats.map((id) => {
          const seatEl = document.querySelector(`.seat[data-seat-id="${id}"][data-event-id="${currentEventId}"]`);
          return seatEl ? seatEl.textContent : id;
        });
        el.textContent = labels.length ? labels.join(", ") : "—";
        if (btn) btn.disabled = seats.length !== selectedSeatCount;
      }

      function toggleSeat(seatId, status, seatEl) {
        if (status === "occupied" || seatEl.classList.contains("disabled")) return;
        if (status === "available") {
          if (selectedSeatIds.size >= selectedSeatCount) {
            alert(`En fazla ${selectedSeatCount} koltuk seçebilirsiniz.`);
            return;
          }
          selectedSeatIds.add(seatId);
          seatEl.setAttribute("data-status", "reserved");
          seatEl.className = "seat reserved";
        } else if (selectedSeatIds.has(seatId)) {
          selectedSeatIds.delete(seatId);
          seatEl.setAttribute("data-status", "available");
          seatEl.className = "seat available";
        }
        updateSelectedLabel();
      }

      function buildSeatStatusMap(seatsSnapshot) {
        const map = {};
        if (!seatsSnapshot.empty) {
          seatsSnapshot.forEach((d) => {
            const data = d.data();
            map[data.seatId || d.id] = data.status || "available";
          });
        }
        return map;
      }

      function generateIbrahimErkalChart(eventId, seatStatusMap) {
        let html = "";
        const frontRows = ["A","B","C","D","E","F","G","H","I","J"];
        html += '<div class="seating-section"><div class="section-title">Ön Blok</div>';
        frontRows.forEach((rowLetter) => {
          html += '<div class="seat-row">';
          for (let n = 1; n <= 24; n++) {
            const seatId = `ON-${rowLetter}${n}`;
            const status = seatStatusMap[seatId] || "available";
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${rowLetter}${n}</div>`;
          }
          html += "</div>";
        });
        html += "</div>";

        const middleRows = ["K","L","M","N","P","Q","R","S"];
        html += '<div class="seating-section"><div class="section-title">Orta Blok</div>';
        middleRows.forEach((rowLetter) => {
          html += '<div class="seat-row">';
          for (let n = 1; n <= 11; n++) {
            const seatId = `ORTA-${rowLetter}${n}`;
            const status = seatStatusMap[seatId] || "available";
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${rowLetter}${n}</div>`;
          }
          for (let i = 0; i < 3; i++)
            html += `<div class="seat disabled" style="visibility:hidden;pointer-events:none;" data-seat-id="ORTA-SPACER-${rowLetter}-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
          for (let n = 12; n <= 21; n++) {
            const seatId = `ORTA-${rowLetter}${n}`;
            const status = seatStatusMap[seatId] || "available";
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${rowLetter}${n}</div>`;
          }
          html += "</div>";
        });
        html += "</div>";

        const backRows1 = ["T","U","V"];
        html += '<div class="seating-section"><div class="section-title">Arka Blok</div>';
        backRows1.forEach((rowLetter) => {
          html += '<div class="seat-row">';
          html += `<div class="seat disabled" style="visibility:hidden;pointer-events:none;" data-seat-id="ARKA-SPACER-${rowLetter}-start" data-status="disabled" data-event-id="${eventId}"></div>`;
          for (let n = 1; n <= 11; n++) {
            const seatId = `ARKA-${rowLetter}${n}`;
            const status = seatStatusMap[seatId] || "available";
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${rowLetter}${n}</div>`;
          }
          const s12 = seatStatusMap[`ARKA-${rowLetter}12`] || "available";
          html += `<div class="seat ${s12}" data-seat-id="ARKA-${rowLetter}12" data-status="${s12}" data-event-id="${eventId}">${rowLetter}12</div>`;
          for (let i = 0; i < 3; i++)
            html += `<div class="seat disabled" style="visibility:hidden;pointer-events:none;" data-seat-id="ARKA-SPACER-${rowLetter}-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
          for (let n = 13; n <= 24; n++) {
            const seatId = `ARKA-${rowLetter}${n}`;
            const status = seatStatusMap[seatId] || "available";
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${rowLetter}${n}</div>`;
          }
          html += "</div>";
        });
        html += '<div class="seat-row">';
        for (let i = 0; i < 2; i++)
          html += `<div class="seat disabled" style="visibility:hidden;pointer-events:none;" data-seat-id="ARKA-SPACER-Y-start-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
        for (let n = 1; n <= 13; n++) {
          const seatId = `ARKA-Y${n}`;
          const status = seatStatusMap[seatId] || "available";
          html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">Y${n}</div>`;
        }
        for (let i = 0; i < 3; i++)
          html += `<div class="seat disabled" style="visibility:hidden;pointer-events:none;" data-seat-id="ARKA-SPACER-Y-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
        for (let n = 14; n <= 27; n++) {
          const seatId = `ARKA-Y${n}`;
          const status = seatStatusMap[seatId] || "available";
          html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">Y${n}</div>`;
        }
        html += "</div></div>";
        return html;
      }

      function generateSampleChart(eventId, seatStatusMap) {
        let html = "";
        ["Sol", "Orta", "Sağ"].forEach((label, block) => {
          const rows = block === 0 || block === 2 ? 10 : 15;
          const cols = block === 1 ? 12 : 8;
          const prefix = block === 0 ? "L" : block === 1 ? "C" : "R";
          html += `<div class="seating-section"><div class="section-title">${label} Blok</div>`;
          for (let r = 1; r <= rows; r++) {
            html += '<div class="seat-row">';
            for (let c = 1; c <= cols; c++) {
              const seatId = `${prefix}${r}-${c}`;
              const status = seatStatusMap[seatId] || "available";
              const label2 = r + String.fromCharCode(64 + c);
              html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${label2}</div>`;
            }
            html += "</div>";
          }
          html += "</div>";
        });
        return html;
      }

      async function loadEventAndSeats() {
        const eventId = getEventIdFromUrl();
        if (!eventId) {
          document.getElementById("loadingState").style.display = "none";
          document.getElementById("errorState").style.display = "block";
          return;
        }
        try {
          const eventRef = doc(db, "activity", eventId);
          const eventSnap = await getDoc(eventRef);
          if (!eventSnap.exists()) throw new Error("Etkinlik yok");
          const event = eventSnap.data();
          if (!event.activityTicketInfo) throw new Error("Biletli etkinlik değil");

          currentEventId = eventId;
          currentEvent = { id: eventId, ...event };

          let eventDate = new Date();
          if (event.activityDate?.toDate) eventDate = event.activityDate.toDate();
          else if (event.date?.toDate) eventDate = event.date.toDate();
          else if (event.activityBeginDate?.toDate) eventDate = event.activityBeginDate.toDate();
          const dateStr = eventDate.toLocaleDateString("tr-TR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });

          document.getElementById("eventTitle").textContent = event.name || "Etkinlik";
          document.getElementById("eventDateLocation").textContent = `${dateStr} · ${event.location || ""}`;

          const seatsRef = collection(db, "activity", eventId, "seats");
          const seatsSnap = await getDocs(seatsRef);
          seatStatusMapCache = buildSeatStatusMap(seatsSnap);

          document.getElementById("loadingState").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
          window._eventLoaded = true;
          if (window._authReady) applyStep();
        } catch (e) {
          console.error(e);
          document.getElementById("loadingState").style.display = "none";
          document.getElementById("errorState").style.display = "block";
        }
      }

      function renderSeatingChart() {
        if (!currentEventId || !seatStatusMapCache) return;
        const location = (currentEvent?.location || "").trim();
        const isIbrahimErkal = location.includes("İbrahim Erkal") && location.includes("Büyük Salon");
        const seatsHTML = isIbrahimErkal
          ? generateIbrahimErkalChart(currentEventId, seatStatusMapCache)
          : generateSampleChart(currentEventId, seatStatusMapCache);
        document.getElementById("seatingChartContent").innerHTML = seatsHTML;
        selectedSeatIds = new Set();
        updateSelectedLabel();
        document.querySelectorAll(".seat").forEach((seatEl) => {
          seatEl.addEventListener("click", () => {
            const seatId = seatEl.getAttribute("data-seat-id");
            const status = seatEl.getAttribute("data-status");
            toggleSeat(seatId, status, seatEl);
          });
        });
      }

      function applyStep() {
        if (!window._eventLoaded) return;
        const user = auth.currentUser;
        if (!user) {
          showStep("stepAuth");
          return;
        }
        if (!window._currentStep || window._currentStep === "auth") {
          showStep("stepSeatCount");
          window._currentStep = "seatCount";
        }
      }

      onAuthStateChanged(auth, (user) => {
        window._authReady = true;
        if (!window._eventLoaded) return;
        if (!user) {
          showStep("stepAuth");
          window._currentStep = "auth";
          return;
        }
        showStep("stepSeatCount");
        window._currentStep = "seatCount";
      });

      // Adım 0: Üye girişi / Üye ol
      document.getElementById("btnUyeGiris").addEventListener("click", () => {
        const modal = new bootstrap.Modal(document.getElementById("loginModal"));
        modal.show();
      });
      document.getElementById("btnUyeOl").addEventListener("click", () => {
        const modal = new bootstrap.Modal(document.getElementById("signupModal"));
        modal.show();
      });

      document.getElementById("btnLoginSubmit").addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value;
        if (!email || !password) { alert("E-posta ve şifre girin."); return; }
        const btn = document.getElementById("btnLoginSubmit");
        btn.disabled = true;
        btn.textContent = "Giriş yapılıyor...";
        try {
          await signInWithEmailAndPassword(auth, email, password);
          bootstrap.Modal.getInstance(document.getElementById("loginModal")).hide();
          showStep("stepSeatCount");
          window._currentStep = "seatCount";
        } catch (err) {
          if (err.code === "auth/invalid-credential" || err.code === "auth/wrong-password") alert("E-posta veya şifre hatalı.");
          else alert("Giriş yapılamadı: " + (err.message || ""));
        } finally {
          btn.disabled = false;
          btn.textContent = "Giriş Yap";
        }
      });

      document.getElementById("btnSignupSubmit").addEventListener("click", async () => {
        const email = document.getElementById("signupEmail").value.trim();
        const password = document.getElementById("signupPassword").value;
        if (!email || !password) { alert("E-posta ve şifre girin."); return; }
        if (password.length < 6) { alert("Şifre en az 6 karakter olmalı."); return; }
        const btn = document.getElementById("btnSignupSubmit");
        btn.disabled = true;
        btn.textContent = "Kaydediliyor...";
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          bootstrap.Modal.getInstance(document.getElementById("signupModal")).hide();
          showStep("stepSeatCount");
          window._currentStep = "seatCount";
        } catch (err) {
          if (err.code === "auth/email-already-in-use") alert("Bu e-posta zaten kayıtlı.");
          else alert("Kayıt oluşturulamadı: " + (err.message || ""));
        } finally {
          btn.disabled = false;
          btn.textContent = "Üye Ol";
        }
      });

      // Adım 1: Koltuk sayısı
      document.querySelectorAll(".seat-count-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".seat-count-btn").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedSeatCount = parseInt(btn.getAttribute("data-count"), 10);
          document.getElementById("seatCountSelected").textContent = "Seçim: " + selectedSeatCount + " koltuk";
          document.getElementById("btnSeatCountNext").disabled = false;
        });
      });
      document.getElementById("btnSeatCountNext").addEventListener("click", () => {
        showStep("stepSeatSelect");
        document.getElementById("seatSelectHint").textContent = selectedSeatCount === 1 ? "1 koltuk seçin." : selectedSeatCount + " koltuk seçin.";
        renderSeatingChart();
      });

      // Adım 2: Koltuk seçimi
      document.getElementById("btnSeatSelectNext").addEventListener("click", () => {
        if (selectedSeatIds.size !== selectedSeatCount) {
          alert("Lütfen tam " + selectedSeatCount + " koltuk seçin.");
          return;
        }
        showStep("stepInfo");
        fillUserInfoFromLastTicket();
      });

      async function fillUserInfoFromLastTicket() {
        const user = auth.currentUser;
        if (!user) return;
        try {
          const q = query(collection(db, "userTickets"), where("userId", "==", user.uid));
          const snap = await getDocs(q);
          let last = null;
          let lastTime = 0;
          snap.forEach((d) => {
            const t = d.data();
            const created = t.createdAt?.toMillis?.() ?? 0;
            if (created > lastTime) { lastTime = created; last = t; }
          });
          if (last) {
            document.getElementById("buyFirstName").value = last.firstName || "";
            document.getElementById("buyLastName").value = last.lastName || "";
            document.getElementById("buyPhone").value = last.phone || "";
            document.getElementById("buyEmail").value = last.email || user.email || "";
          } else {
            document.getElementById("buyEmail").value = user.email || "";
          }
        } catch (_) {}
      }

      // Adım 3: Bilgiler
      document.getElementById("btnInfoNext").addEventListener("click", () => {
        const firstName = document.getElementById("buyFirstName").value.trim();
        const lastName = document.getElementById("buyLastName").value.trim();
        const phone = document.getElementById("buyPhone").value.trim();
        const email = document.getElementById("buyEmail").value.trim();
        if (!firstName || !lastName || !phone || !email) {
          alert("Tüm alanları doldurun.");
          return;
        }
        const labels = [...selectedSeatIds].map((id) => {
          const el = document.querySelector(`.seat[data-seat-id="${id}"][data-event-id="${currentEventId}"]`);
          return el ? el.textContent : id;
        });
        document.getElementById("summaryEventName").textContent = currentEvent?.name || "—";
        document.getElementById("summarySeats").textContent = labels.join(", ");
        document.getElementById("summaryName").textContent = firstName + " " + lastName;
        document.getElementById("summaryPhone").textContent = phone;
        document.getElementById("summaryEmail").textContent = email;
        window._pendingBuy = { firstName, lastName, phone, email };
        showStep("stepSummary");
      });

      // Adım 4: Özet ve tamamla
      document.getElementById("btnCompleteReservation").addEventListener("click", async () => {
        const pending = window._pendingBuy;
        const user = auth.currentUser;
        if (!pending || !user || !currentEventId || selectedSeatIds.size === 0) return;

        const btn = document.getElementById("btnCompleteReservation");
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Kaydediliyor...';

        try {
          const seatIds = [...selectedSeatIds];
          const ticketData = {
            userId: user.uid,
            userEmail: user.email || pending.email,
            eventId: currentEventId,
            eventName: currentEvent?.name || "",
            eventDate: currentEvent?.activityDate || currentEvent?.date || null,
            location: currentEvent?.location || "",
            seatIds,
            firstName: pending.firstName,
            lastName: pending.lastName,
            phone: pending.phone,
            email: pending.email,
            createdAt: Timestamp.now(),
          };
          await addDoc(collection(db, "userTickets"), ticketData);

          for (const seatId of seatIds) {
            const seatRef = doc(db, "activity", currentEventId, "seats", seatId);
            await setDoc(seatRef, {
              seatId,
              eventId: currentEventId,
              status: "occupied",
              reservation: {
                firstName: pending.firstName,
                lastName: pending.lastName,
                phone: pending.phone,
                email: pending.email,
                userId: user.uid,
              },
              updatedAt: Timestamp.now(),
            }, { merge: true });
          }

          window._pendingBuy = null;
          alert("Rezervasyonunuz tamamlandı. Biletlerim sayfasından görüntüleyebilirsiniz.");
          window.location.href = "biletlerim.html";
        } catch (err) {
          console.error(err);
          alert("Rezervasyon kaydedilirken hata oluştu.");
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check me-2"></i>Rezervasyonu Tamamla';
        }
      });

      loadEventAndSeats();
    </script>
  </body>
</html>
