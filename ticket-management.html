<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bilet Yönetimi</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/mobile.css" />
    <link rel="stylesheet" href="css/tablet.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      .offcanvas {
        transform: translateX(-100%);
        visibility: visible;
        transition: transform 0.3s ease;
        width: 400px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        height: 100vh;
        background-color: white;
      }

      .offcanvas.show {
        transform: translateX(0);
      }

      #mainContainer {
        transition: all 0.3s ease;
        width: 100%;
        margin-left: 0;
        position: relative;
        overflow-x: auto;
        padding-bottom: 60px;
      }

      #mainContainer.shifted {
        margin-left: 400px;
        width: calc(100% - 400px);
      }

      #menuButton {
        display: inline-block;
      }

      @media (max-width: 992px) {
        .offcanvas {
          transform: translateX(-100%);
        }

        .offcanvas.show {
          transform: translateX(0);
        }

        #mainContainer.shifted {
          margin-left: 0;
          width: 100%;
        }

        #menuButton {
          display: inline-block;
        }

        .menu-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1040;
        }

        .menu-overlay.active {
          display: block;
        }
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow-x: auto;
        padding: 20px;
      }

      footer {
        height: 50px;
        background-color: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
      }

      .container-fluid {
        margin-bottom: 70px;
      }

      .event-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        background: white;
      }

      .event-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .event-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
      }

      .event-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
      }

      .event-date {
        color: #6c757d;
        font-size: 0.9rem;
      }

      .event-info {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }

      .event-info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #495057;
        font-size: 0.9rem;
      }

      .event-info-item i {
        color: var(--bs-primary);
      }

      .loading-spinner {
        text-align: center;
        padding: 3rem;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #dee2e6;
      }

      /* Salon Kroki Sayfası Stilleri */
      .seating-chart-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
        width: 100%;
        direction: ltr; /* Scroll'un soldan başlaması için */
      }

      /* Not: Flex + overflow-x kombinasyonunda "sola kaymama" sorunu yaşanır.
         Bu yüzden yatay kaydırmayı ayrı bir scroll alanında yönetiyoruz. */
      .seating-scroll-area {
        width: 100%;
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }

      /* İçerik genişliği kadar olsun; dar ekranda ortalansın, genişse sola yaslansın */
      .seating-scroll-inner {
        display: inline-block;
        min-width: 100%;
      }

      .stage-area {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 2rem;
        font-weight: 600;
        font-size: 1.25rem;
        width: 100%;
        max-width: 100%;
      }

      .seating-section {
        margin-bottom: 2rem;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: fit-content;
      }

      .section-title {
        font-weight: 600;
        margin-bottom: 1rem;
        color: #2c3e50;
        font-size: 1.1rem;
      }

      .seat-row {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
        justify-content: center;
        flex-wrap: nowrap;
        position: relative;
        min-width: fit-content;
        width: 100%;
        max-width: 100%;
      }

      /* 24 koltuklu satırlarda ortada görsel ayrım (12. ve 13. koltuk arası) */
      .seat-row::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 8px;
        background: transparent;
        transform: translateX(-50%);
        pointer-events: none;
      }

      .seat {
        width: 35px;
        height: 35px;
        min-width: 25px;
        min-height: 25px;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        color: #495057;
        flex-shrink: 0;
      }

      @media (max-width: 768px) {
        .seating-chart-container {
          padding: 1rem;
          overflow-x: auto;
          overflow-y: visible;
          -webkit-overflow-scrolling: touch;
          scroll-behavior: smooth;
          width: 100%;
          max-width: 100vw;
          position: relative;
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .stage-area {
          width: 100%;
          max-width: 100%;
          margin-left: auto;
          margin-right: auto;
        }

        .seating-section {
          width: 100%;
          min-width: 100%;
          align-items: center;
          margin: 0 auto;
          padding: 0;
          display: flex;
          flex-direction: column;
        }

        .seat-row {
          gap: 0.15rem;
          margin-bottom: 0.4rem;
          justify-content: center;
          width: max-content;
          display: flex;
          margin-left: auto;
          margin-right: auto;
          flex-wrap: nowrap;
        }

        .seating-section {
          width: max-content;
          min-width: 100%;
        }

        .section-title {
          text-align: center;
          width: 100%;
          padding-left: 0;
        }

        .seat {
          width: 28px;
          height: 28px;
          min-width: 22px;
          min-height: 22px;
          font-size: 0.5rem;
          border-width: 1.5px;
        }

        .section-title {
          font-size: 1rem;
          margin-bottom: 0.75rem;
          text-align: center;
          width: 100%;
        }

        .stage-area {
          padding: 1rem;
          font-size: 1rem;
          margin-bottom: 1.5rem;
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .seat {
          width: 24px;
          height: 24px;
          min-width: 20px;
          min-height: 20px;
          font-size: 0.45rem;
        }

        .seat-row {
          gap: 0.1rem;
        }
      }

      .seat:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .seat.available {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
      }

      .seat.reserved {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }

      .seat.occupied {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      .seat.disabled {
        background: #e9ecef;
        border-color: #adb5bd;
        color: #6c757d;
        cursor: not-allowed;
      }

      .reserve-actions {
        text-align: center;
        padding: 1rem;
      }

      .reserve-actions .btn:disabled {
        cursor: not-allowed;
      }

      #reservationModal.show {
        display: block !important;
      }

      #reservationModal .modal-backdrop {
        z-index: 1040;
      }

      .legend {
        display: flex;
        gap: 2rem;
        justify-content: center;
        margin-top: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 2px solid;
      }

      .back-button {
        margin-bottom: 1rem;
      }

      .event-details-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
      }

      .event-details-header h2 {
        margin: 0 0 0.5rem 0;
        color: white;
      }

      .event-details-header p {
        margin: 0.25rem 0;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div
        class="offcanvas offcanvas-start"
        data-bs-backdrop="false"
        id="adminPanelSideMenu"
      >
        <div
          class="offcanvas-header d-flex justify-content-start"
          style="margin-top: 2%"
        >
          <div>
            <img
              src="assets/274348852_320609883437173_4953649348556891409_n.jpg"
              alt="profilResmi"
              width="50px"
              height="50px"
              style="border-radius: 50px"
            />
          </div>
          <div class="offcanvas-title text-primary ms-4 h4">Yönetim Paneli</div>
        </div>

        <div
          class="offcanvas-body offcanvas-primary d-flex align-items-top flex-column"
        >
          <div class="list-group mb-auto p2">
            <a
              href="activity.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,2,2a"
              >Etkinlikler
            </a>
            <a
              href="staff.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,10,10a"
              >Ekip</a
            >
            <a
              href="salooncontrol.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,3,3a"
              >Salon Takip</a
            >
            <a
              href="ticket-management.html"
              class="list-group-item list-group-item-action active"
              data-required-permissions="1,1a,2,2a"
              >Bilet Yönetimi</a
            >
            <a
              href="news.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,5,5a"
              >Haberler</a
            >
            <a
              href="costume.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,9,9a"
              >Kostümler</a
            >
            <a
              href="library.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,8,8a"
              >Kütüphane</a
            >
            <a
              href="messages.html"
              class="list-group-item list-group-item-action messages-link"
              style="display: none"
              data-required-permissions="1,1a,2,2a"
              >Mesajlar</a
            >
          </div>

          <div class="list-group">
            <button
              class="list-group-item list-group-item-action bg-danger text-white"
              id="logoutButton"
            >
              Çıkış Yap
            </button>
          </div>
        </div>
      </div>

      <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

      <div class="container-fluid" id="mainContainer">
        <div
          class="containerTitle d-flex justify-content-between border-bottom border-primary bg-white"
        >
          <button class="btn btn-primary mb-3 mt-3" id="menuButton">
            <i class="fas fa-bars"></i>
          </button>
          <div class="h3 text-primary m-3 pb-0 flex-fill">Bilet Yönetimi</div>
        </div>

        <!-- Etkinlik Listesi -->
        <div id="eventsListContainer" class="p-4">
          <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2">Etkinlikler yükleniyor...</p>
          </div>
        </div>

        <!-- Salon Kroki Detay Sayfası (Başlangıçta gizli) -->
        <div id="seatingChartContainer" class="p-4" style="display: none">
          <button class="btn btn-secondary back-button" id="backToListBtn">
            <i class="fas fa-arrow-left"></i> Listeye Dön
          </button>

          <div id="eventDetailsHeader" class="event-details-header">
            <h2 id="eventDetailTitle">Etkinlik Adı</h2>
            <p id="eventDetailDate"><i class="fas fa-calendar"></i> Tarih</p>
            <p id="eventDetailLocation">
              <i class="fas fa-map-marker-alt"></i> Konum
            </p>
          </div>

          <div class="seating-chart-container">
            <div class="seating-scroll-area">
              <div class="seating-scroll-inner">
                <div class="stage-area">SAHNE</div>

                <div id="seatingChartContent">
                  <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-2">Salon krokisi yükleniyor...</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="legend">
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background: #d4edda; border-color: #28a745"
                ></div>
                <span>Boş</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background: #fff3cd; border-color: #ffc107"
                ></div>
                <span>Rezerve</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background: #f8d7da; border-color: #dc3545"
                ></div>
                <span>Dolu</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background: #e9ecef; border-color: #adb5bd"
                ></div>
                <span>Devre Dışı</span>
              </div>
            </div>

            <div class="reserve-actions mt-3">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                id="rezerveEtBtn"
                disabled
              >
                Rezerve Et
              </button>
              <p class="text-muted small mt-2 mb-0" id="rezerveHint">
                1–5 koltuk seçin, ardından Rezerve Et'e tıklayın.
              </p>
            </div>
          </div>
        </div>

        <!-- Rezervasyon Diyalogu -->
        <div
          class="modal fade"
          id="reservationModal"
          tabindex="-1"
          aria-labelledby="reservationModalLabel"
          aria-hidden="true"
          data-backdrop="static"
          data-keyboard="false"
        >
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">
                  Rezervasyon
                </h5>
                <button
                  type="button"
                  class="close"
                  data-dismiss="modal"
                  aria-label="Kapat"
                  id="reservationModalCloseBtn"
                >
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="alert alert-warning mb-3" id="countdownAlert">
                  <strong id="countdownText">5:00</strong> — 5 dakika içinde
                  işlem yapılmazsa koltuklar boş olarak işaretlenecek.
                </div>
                <div id="selectedSeatsSection" class="mb-3">
                  <div class="font-weight-bold mb-1">Seçilen Koltuklar</div>
                  <div id="selectedSeatsText" class="small text-muted"></div>
                </div>

                <div id="seatOwnerSection" class="mb-3" style="display: none">
                  <div class="font-weight-bold mb-1">Koltuklar</div>
                  <div id="seatOwnerSeatsList" class="mb-3 small text-muted"></div>
                  <div class="font-weight-bold mb-1">Bilet Bilgileri</div>
                  <div class="alert alert-info mb-0" id="seatOwnerText"></div>
                </div>
                <form id="reservationForm">
                  <div class="form-group">
                    <label for="reservationFirstName"
                      >İsim <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="reservationFirstName"
                      required
                      placeholder="İsim"
                    />
                  </div>
                  <div class="form-group">
                    <label for="reservationLastName"
                      >Soyisim <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="reservationLastName"
                      required
                      placeholder="Soyisim"
                    />
                  </div>
                  <div class="form-group">
                    <label for="reservationPhone"
                      >Telefon <span class="text-danger">*</span></label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="reservationPhone"
                      required
                      placeholder="Telefon"
                    />
                  </div>
                  <div class="form-group">
                    <label for="reservationEmail"
                      >E-posta
                      <span class="text-muted">(opsiyonel)</span></label
                    >
                    <input
                      type="email"
                      class="form-control"
                      id="reservationEmail"
                      placeholder="E-posta"
                    />
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="reservationCancelBtn"
                >
                  İptal
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="reservationRevokeBtn"
                  style="display: none"
                >
                  Rezervasyonu İptal Et
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="reservationCompleteBtn"
                >
                  Rezervasyonu Tamamla
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p class="mb-0">&copy; 2024 EBB Kültür ve Sanat Merkezi</p>
    </footer>

    <!-- Firebase -->
    <script type="module">
      // Firebase imports
      import {
        initializeApp,
        getApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        doc,
        query,
        where,
        orderBy,
        updateDoc,
        setDoc,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import { ensureAuth, logActivity } from "./js/authGuard.js";
      import {
        updateMessagesLinkVisibility,
        enforceLinkPermissions,
      } from "./js/offcanvas.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD978ixFjE9KVlNsm6-BYww3B6S4qPVLfQ",
        authDomain: "ebbkultursanatapp.firebaseapp.com",
        projectId: "ebbkultursanatapp",
        storageBucket: "ebbkultursanatapp.appspot.com",
        messagingSenderId: "540910775157",
        appId: "1:540910775157:web:4af35312414acf20bd013c",
        measurementId: "G-4JCKV13ER8",
      };

      // Initialize Firebase
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const authContext = await ensureAuth({
        app,
        auth,
        db,
        requiredAny: ["1", "1a", "2", "2a"],
        writeCodes: ["1", "2"],
        pageName: "Bilet Yönetimi",
      }).catch((error) => {
        console.error("Yetkilendirme başarısız:", error);
        return null;
      });

      if (!authContext) {
        window.location.href = "adminpanellogin.html";
      }

      const currentUser = authContext.user;
      const currentUserEmail = currentUser.email;
      const currentUserName =
        authContext.profile?.userName || currentUser.displayName || "";
      const userAuthorityArray = authContext.permissions || [];
      updateMessagesLinkVisibility(userAuthorityArray);
      enforceLinkPermissions(userAuthorityArray);

      // Rezervasyon seçimi (sadece UI; Firebase'e Rezervasyonu Tamamla'da yazılır)
      let selectedSeatIds = new Set();
      let currentReservationEventId = null;
      let reservationCountdownTimer = null;
      let reservationCountdownSeconds = 300; // 5 dakika
      let reservationModalMode = "reserve"; // "reserve" | "info"
      let seatDetailSeatId = null;
      let seatDetailSeatIds = []; // Aynı kişiye ait tüm koltuk id'leri (iptal için)

      function updateRezerveEtButton() {
        const btn = document.getElementById("rezerveEtBtn");
        if (!btn) return;
        btn.disabled = selectedSeatIds.size === 0;
      }

      function formatSelectedSeatsForModal(eventId) {
        const seats = [...selectedSeatIds].map((id) => {
          const el = document.querySelector(
            `.seat[data-seat-id="${id}"][data-event-id="${eventId}"]`,
          );
          return el ? el.textContent || id : id;
        });
        return seats.join(", ");
      }

      function ensureModalOpen() {
        const modal = document.getElementById("reservationModal");
        if (!modal) return false;
        modal.classList.add("show");
        modal.style.display = "block";
        document.body.classList.add("modal-open");
        if (!document.getElementById("reservationModalBackdrop")) {
          const backdrop = document.createElement("div");
          backdrop.className = "modal-backdrop fade show";
          backdrop.id = "reservationModalBackdrop";
          document.body.appendChild(backdrop);
        }
        return true;
      }

      function setModalModeReserve() {
        reservationModalMode = "reserve";
        seatDetailSeatId = null;
        seatDetailSeatIds = [];
        document.getElementById("reservationModalLabel").textContent =
          "Rezervasyon";
        document.getElementById("countdownAlert").style.display = "block";
        document.getElementById("selectedSeatsSection").style.display = "block";
        document.getElementById("seatOwnerSection").style.display = "none";
        document.getElementById("reservationForm").style.display = "block";
        document.getElementById("reservationCompleteBtn").style.display =
          "inline-block";
        document.getElementById("reservationRevokeBtn").style.display = "none";
        document.getElementById("reservationCancelBtn").textContent = "İptal";
      }

      function setModalModeInfo() {
        reservationModalMode = "info";
        document.getElementById("reservationModalLabel").textContent =
          "Rezervasyon Bilgisi";
        document.getElementById("countdownAlert").style.display = "none";
        document.getElementById("selectedSeatsSection").style.display = "none";
        document.getElementById("seatOwnerSection").style.display = "block";
        document.getElementById("reservationForm").style.display = "none";
        document.getElementById("reservationCompleteBtn").style.display =
          "none";
        document.getElementById("reservationRevokeBtn").style.display =
          "inline-block";
        document.getElementById("reservationCancelBtn").textContent = "Geri Dön";
      }

      function toggleSeatSelection(
        eventId,
        seatId,
        currentStatus,
        seatElement,
      ) {
        if (seatElement.classList.contains("disabled")) return;
        if (currentStatus === "occupied") {
          openSeatInfoModal(eventId, seatId);
          return;
        }

        if (currentStatus === "available") {
          if (selectedSeatIds.size >= 5) {
            alert("Bir kerede en fazla 5 koltuk rezerve edilebilir.");
            return;
          }
          selectedSeatIds.add(seatId);
          seatElement.setAttribute("data-status", "reserved");
          seatElement.className = "seat reserved";
        } else if (
          currentStatus === "reserved" &&
          selectedSeatIds.has(seatId)
        ) {
          selectedSeatIds.delete(seatId);
          seatElement.setAttribute("data-status", "available");
          seatElement.className = "seat available";
        }
        updateRezerveEtButton();
      }

      function openReservationModal() {
        if (!ensureModalOpen()) return;
        setModalModeReserve();
        document.getElementById("reservationForm").reset();
        document.getElementById("selectedSeatsText").textContent =
          formatSelectedSeatsForModal(currentReservationEventId) || "—";
        reservationCountdownSeconds = 300;
        document.getElementById("countdownText").textContent = "5:00";
        startReservationCountdown();
      }

      function closeReservationModal() {
        const modal = document.getElementById("reservationModal");
        if (!modal) return;
        modal.classList.remove("show");
        modal.style.display = "none";
        document.body.classList.remove("modal-open");
        const backdrop = document.getElementById("reservationModalBackdrop");
        if (backdrop) backdrop.remove();
      }

      async function openSeatInfoModal(eventId, seatId) {
        clearReservationCountdown();
        if (!ensureModalOpen()) return;
        setModalModeInfo();
        seatDetailSeatId = seatId;
        currentReservationEventId = eventId;
        const seatsListEl = document.getElementById("seatOwnerSeatsList");
        const infoEl = document.getElementById("seatOwnerText");
        seatsListEl.textContent = "Yükleniyor...";
        infoEl.textContent = "";
        try {
          const seatRef = doc(db, "activity", eventId, "seats", seatId);
          const snap = await getDoc(seatRef);
          if (!snap.exists()) {
            seatsListEl.textContent = "Rezervasyon bulunamadı.";
            return;
          }
          const data = snap.data() || {};
          const r = data.reservation || {};
          const phone = (r.phone || "").trim();
          const lastName = (r.lastName || "").trim();
          if (!phone && !lastName) {
            seatsListEl.textContent = "Rezervasyon bilgisi eksik.";
            infoEl.textContent = "Ad, soyad veya telefon kaydı yok.";
            seatDetailSeatIds = [seatId];
            return;
          }
          const seatsRef = collection(db, "activity", eventId, "seats");
          const seatsSnapshot = await getDocs(seatsRef);
          const sameReservationSeats = [];
          seatsSnapshot.forEach((docSnap) => {
            const d = docSnap.data() || {};
            if (d.status !== "occupied") return;
            const res = d.reservation || {};
            const samePhone = (res.phone || "").trim() === phone;
            const sameLastName = (res.lastName || "").trim() === lastName;
            if (samePhone && sameLastName) {
              sameReservationSeats.push({
                seatId: d.seatId || docSnap.id,
                label: d.seatId || docSnap.id,
              });
            }
          });
          sameReservationSeats.sort((a, b) =>
            String(a.seatId).localeCompare(String(b.seatId)),
          );
          seatDetailSeatIds = sameReservationSeats.map((s) => s.seatId);
          const labels = sameReservationSeats.map((s) => {
            const el = document.querySelector(
              `.seat[data-seat-id="${s.seatId}"][data-event-id="${eventId}"]`,
            );
            return el ? el.textContent || s.seatId : s.seatId;
          });
          seatsListEl.textContent = labels.join(", ");
          const fullName =
            [r.firstName, r.lastName].filter(Boolean).join(" ") || "—";
          const email = r.email || "—";
          infoEl.innerHTML = `
            <div><strong>Ad Soyad:</strong> ${fullName}</div>
            <div><strong>Telefon:</strong> ${r.phone || "—"}</div>
            <div><strong>E-posta:</strong> ${email}</div>
          `;
        } catch (err) {
          console.error("Koltuk bilgisi alınırken hata:", err);
          seatsListEl.textContent = "Bilgi alınırken hata oluştu.";
          infoEl.textContent = "";
          seatDetailSeatIds = [seatId];
        }
      }

      async function revokeSeatReservation() {
        if (seatDetailSeatIds.length === 0) return;
        const msg =
          "Bu rezervasyona ait tüm koltuklar boşaltılacak. Emin misiniz?";
        if (!confirm(msg)) return;
        const eventId = currentReservationEventId;
        if (!eventId) return;
        try {
          for (const sid of seatDetailSeatIds) {
            const seatRef = doc(db, "activity", eventId, "seats", sid);
            await setDoc(
              seatRef,
              {
                seatId: sid,
                eventId,
                status: "available",
                reservation: null,
                updatedAt: Timestamp.now(),
                updatedBy: currentUserEmail,
              },
              { merge: true },
            );
            const el = document.querySelector(
              `.seat[data-seat-id="${sid}"][data-event-id="${eventId}"]`,
            );
            if (el) {
              el.setAttribute("data-status", "available");
              el.className = "seat available";
            }
          }
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "ticket_reservation_revoke",
            page: "ticket-management",
            targetId: eventId,
            targetType: "event",
            meta: { seatIds: [...seatDetailSeatIds] },
          });
          seatDetailSeatIds = [];
          closeReservationModal();
        } catch (err) {
          console.error("Rezervasyon iptal edilirken hata:", err);
          alert("Rezervasyon iptal edilirken bir hata oluştu.");
        }
      }

      function startReservationCountdown() {
        if (reservationCountdownTimer) clearInterval(reservationCountdownTimer);
        const countdownEl = document.getElementById("countdownText");
        reservationCountdownTimer = setInterval(() => {
          reservationCountdownSeconds--;
          const m = Math.floor(reservationCountdownSeconds / 60);
          const s = reservationCountdownSeconds % 60;
          countdownEl.textContent = `${m}:${s.toString().padStart(2, "0")}`;
          if (reservationCountdownSeconds <= 0) {
            clearInterval(reservationCountdownTimer);
            reservationCountdownTimer = null;
            revertSelectedSeatsToAvailable();
            closeReservationModal();
            updateRezerveEtButton();
          }
        }, 1000);
      }

      function clearReservationCountdown() {
        if (reservationCountdownTimer) {
          clearInterval(reservationCountdownTimer);
          reservationCountdownTimer = null;
        }
      }

      function revertSelectedSeatsToAvailable() {
        const eventId = currentReservationEventId;
        if (!eventId) return;
        selectedSeatIds.forEach((seatId) => {
          const el = document.querySelector(
            `.seat[data-seat-id="${seatId}"][data-event-id="${eventId}"]`,
          );
          if (el) {
            el.setAttribute("data-status", "available");
            el.className = "seat available";
          }
        });
        selectedSeatIds.clear();
      }

      function confirmReservation() {
        const firstName = document
          .getElementById("reservationFirstName")
          .value.trim();
        const lastName = document
          .getElementById("reservationLastName")
          .value.trim();
        const phone = document.getElementById("reservationPhone").value.trim();
        const email = document.getElementById("reservationEmail").value.trim();
        if (!firstName || !lastName || !phone) {
          alert("Lütfen İsim, Soyisim ve Telefon alanlarını doldurun.");
          return;
        }
        const eventId = currentReservationEventId;
        if (!eventId || selectedSeatIds.size === 0) return;

        (async () => {
          try {
            for (const seatId of selectedSeatIds) {
              const seatRef = doc(db, "activity", eventId, "seats", seatId);
              await setDoc(
                seatRef,
                {
                  seatId,
                  eventId,
                  status: "occupied",
                  reservation: {
                    firstName,
                    lastName,
                    phone,
                    email: email || null,
                  },
                  updatedAt: Timestamp.now(),
                  updatedBy: currentUserEmail,
                },
                { merge: true },
              );
              const el = document.querySelector(
                `.seat[data-seat-id="${seatId}"][data-event-id="${eventId}"]`,
              );
              if (el) {
                el.setAttribute("data-status", "occupied");
                el.className = "seat occupied";
              }
            }
            await logActivity(db, {
              userEmail: currentUserEmail,
              userName: currentUserName,
              action: "ticket_reservation_complete",
              page: "ticket-management",
              targetId: eventId,
              targetType: "event",
              meta: {
                seatIds: [...selectedSeatIds],
                firstName,
                lastName,
                phone,
              },
            });
            selectedSeatIds.clear();
            clearReservationCountdown();
            closeReservationModal();
            updateRezerveEtButton();
          } catch (err) {
            console.error("Rezervasyon kaydedilirken hata:", err);
            alert("Rezervasyon kaydedilirken bir hata oluştu.");
          }
        })();
      }

      // Menu toggle functionality
      function toggleMenu() {
        const offcanvas = document.getElementById("adminPanelSideMenu");
        const mainContainer = document.getElementById("mainContainer");
        const menuOverlay = document.getElementById("menuOverlay");

        offcanvas.classList.toggle("show");
        mainContainer.classList.toggle("shifted");
        menuOverlay.classList.toggle("active");
      }

      document
        .getElementById("menuButton")
        .addEventListener("click", toggleMenu);

      // Logout functionality
      document.getElementById("logoutButton").addEventListener("click", () => {
        import("./js/authGuard.js").then(({ signOut }) => {
          signOut(auth).then(() => {
            window.location.href = "adminpanellogin.html";
          });
        });
      });

      // Biletli etkinlikleri yükle
      async function loadTicketEvents() {
        try {
          const eventsRef = collection(db, "activity");
          // Index gerektirmemek için önce tüm etkinlikleri çek, sonra client-side filtrele
          // orderBy kullanmadan çekiyoruz, client-side sıralama yapacağız
          const q = query(eventsRef);

          const querySnapshot = await getDocs(q);
          const eventsListContainer = document.getElementById(
            "eventsListContainer",
          );

          // Biletli etkinlikleri filtrele
          const ticketEvents = [];
          querySnapshot.forEach((doc) => {
            const event = doc.data();
            // activityTicketInfo true olan etkinlikleri al
            if (event.activityTicketInfo === true) {
              ticketEvents.push({ id: doc.id, ...event });
            }
          });

          if (ticketEvents.length === 0) {
            eventsListContainer.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-ticket-alt"></i>
                <h3>Biletli Etkinlik Bulunamadı</h3>
                <p>Henüz biletli etkinlik oluşturulmamış.</p>
              </div>
            `;
            return;
          }

          // Tarihe göre sırala (activityDate veya date alanını kullan)
          ticketEvents.sort((a, b) => {
            const getDate = (event) => {
              if (event.activityDate?.toDate)
                return event.activityDate.toDate();
              if (event.date?.toDate) return event.date.toDate();
              if (event.activityBeginDate?.toDate)
                return event.activityBeginDate.toDate();
              if (event.date) return new Date(event.date);
              if (event.activityDate) return new Date(event.activityDate);
              if (event.activityBeginDate)
                return new Date(event.activityBeginDate);
              return new Date(0); // Eğer tarih yoksa en eskiye koy
            };
            const dateA = getDate(a);
            const dateB = getDate(b);
            return dateB - dateA; // Yeni tarihler önce
          });

          let eventsHTML = "";
          ticketEvents.forEach((event) => {
            // Tarih alanını bul (activityDate, date veya activityBeginDate)
            let eventDate;
            if (event.activityDate?.toDate) {
              eventDate = event.activityDate.toDate();
            } else if (event.date?.toDate) {
              eventDate = event.date.toDate();
            } else if (event.activityBeginDate?.toDate) {
              eventDate = event.activityBeginDate.toDate();
            } else if (event.activityDate) {
              eventDate = new Date(event.activityDate);
            } else if (event.date) {
              eventDate = new Date(event.date);
            } else if (event.activityBeginDate) {
              eventDate = new Date(event.activityBeginDate);
            } else {
              eventDate = new Date();
            }

            const formattedDate = eventDate.toLocaleDateString("tr-TR", {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            eventsHTML += `
              <div class="event-card" data-event-id="${event.id}">
                <div class="event-card-header">
                  <h3 class="event-title">${event.name || "Etkinlik Adı Yok"}</h3>
                  <span class="event-date">${formattedDate}</span>
                </div>
                <div class="event-info">
                  <div class="event-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${event.location || "Konum belirtilmemiş"}</span>
                  </div>
                  <div class="event-info-item">
                    <i class="fas fa-tag"></i>
                    <span>${event.category || "Kategori yok"}</span>
                  </div>
                  <div class="event-info-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Biletli Etkinlik</span>
                  </div>
                </div>
              </div>
            `;
          });

          eventsListContainer.innerHTML = eventsHTML;

          // Event card click handlers
          document.querySelectorAll(".event-card").forEach((card) => {
            card.addEventListener("click", () => {
              const eventId = card.getAttribute("data-event-id");
              loadSeatingChart(eventId);
            });
          });
        } catch (error) {
          console.error("Etkinlikler yüklenirken hata:", error);
          document.getElementById("eventsListContainer").innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Hata</h3>
              <p>Etkinlikler yüklenirken bir hata oluştu.</p>
            </div>
          `;
        }
      }

      // Salon krokisini yükle
      async function loadSeatingChart(eventId) {
        // Liste görünümünü gizle, kroki görünümünü göster
        document.getElementById("eventsListContainer").style.display = "none";
        document.getElementById("seatingChartContainer").style.display =
          "block";

        const seatingChartContent = document.getElementById(
          "seatingChartContent",
        );
        seatingChartContent.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2">Salon krokisi yükleniyor...</p>
          </div>
        `;

        try {
          // Etkinlik detaylarını yükle
          const eventRef = doc(db, "activity", eventId);
          const eventSnap = await getDoc(eventRef);

          if (!eventSnap.exists()) {
            throw new Error("Etkinlik bulunamadı");
          }

          const event = eventSnap.data();
          // Tarih alanını bul (activityDate, date veya activityBeginDate)
          let eventDate;
          if (event.activityDate?.toDate) {
            eventDate = event.activityDate.toDate();
          } else if (event.date?.toDate) {
            eventDate = event.date.toDate();
          } else if (event.activityBeginDate?.toDate) {
            eventDate = event.activityBeginDate.toDate();
          } else if (event.activityDate) {
            eventDate = new Date(event.activityDate);
          } else if (event.date) {
            eventDate = new Date(event.date);
          } else if (event.activityBeginDate) {
            eventDate = new Date(event.activityBeginDate);
          } else {
            eventDate = new Date();
          }

          const formattedDate = eventDate.toLocaleDateString("tr-TR", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

          // Etkinlik detaylarını göster
          document.getElementById("eventDetailTitle").textContent =
            event.name || "Etkinlik Adı Yok";
          document.getElementById("eventDetailDate").innerHTML = `
            <i class="fas fa-calendar"></i> ${formattedDate}
          `;
          document.getElementById("eventDetailLocation").innerHTML = `
            <i class="fas fa-map-marker-alt"></i> ${event.location || "Konum belirtilmemiş"}
          `;

          // Koltuk durumlarını yükle
          const seatsRef = collection(db, "activity", eventId, "seats");
          const seatsSnapshot = await getDocs(seatsRef);

          // Salon tipine göre kroki oluştur
          let seatsHTML = "";
          const location = event.location || "";

          if (seatsSnapshot.empty) {
            // Eğer koltuk verisi yoksa, salon tipine göre kroki oluştur
            if (
              location.includes("İbrahim Erkal") &&
              location.includes("Büyük Salon")
            ) {
              seatsHTML = generateIbrahimErkalBuyukSalonChart(
                eventId,
                seatsSnapshot,
              );
            } else {
              seatsHTML = generateSampleSeatingChart(eventId);
            }
          } else {
            // Firebase'deki koltuk verilerini kullan
            if (
              location.includes("İbrahim Erkal") &&
              location.includes("Büyük Salon")
            ) {
              seatsHTML = await generateIbrahimErkalBuyukSalonChart(
                eventId,
                seatsSnapshot,
              );
            } else {
              seatsHTML = await generateSeatingChartFromFirebase(
                seatsSnapshot,
                eventId,
              );
            }
          }

          seatingChartContent.innerHTML = seatsHTML;

          selectedSeatIds = new Set();
          currentReservationEventId = eventId;
          updateRezerveEtButton();

          // Yatay kaydırma konumu:
          // - İlk açılışta ortala
          // - Kullanıcı kaydırdıktan sonra son konumu hatırla (event bazlı)
          const scrollArea = document.querySelector(".seating-scroll-area");
          const scrollKey = `seatingScroll:${eventId}`;

          // Önce varsa eski dinleyiciyi temizle
          if (window.__seatingScrollCleanup) {
            try {
              window.__seatingScrollCleanup();
            } catch (_) {}
            window.__seatingScrollCleanup = null;
          }

          if (scrollArea) {
            const restoreScroll = () => {
              const saved = localStorage.getItem(scrollKey);
              const maxScroll = Math.max(
                0,
                scrollArea.scrollWidth - scrollArea.clientWidth,
              );

              if (saved !== null && saved !== "") {
                const parsed = Number(saved);
                if (!Number.isNaN(parsed)) {
                  scrollArea.scrollLeft = Math.min(
                    Math.max(0, parsed),
                    maxScroll,
                  );
                  return;
                }
              }

              // İlk açılış: ortala
              scrollArea.scrollLeft = Math.max(0, Math.floor(maxScroll / 2));
            };

            // Render/layout oturduktan sonra uygula
            requestAnimationFrame(() => requestAnimationFrame(restoreScroll));

            // Kaydırınca konumu kaydet (debounce)
            let saveTimer = null;
            const onScroll = () => {
              if (saveTimer) clearTimeout(saveTimer);
              saveTimer = setTimeout(() => {
                localStorage.setItem(
                  scrollKey,
                  String(scrollArea.scrollLeft || 0),
                );
              }, 150);
            };
            scrollArea.addEventListener("scroll", onScroll, { passive: true });

            // Resize durumunda da (özellikle mobil rotate) yeniden uygula
            let resizeTimer = null;
            const onResize = () => {
              if (resizeTimer) clearTimeout(resizeTimer);
              resizeTimer = setTimeout(restoreScroll, 100);
            };
            window.addEventListener("resize", onResize);

            window.__seatingScrollCleanup = () => {
              if (saveTimer) clearTimeout(saveTimer);
              if (resizeTimer) clearTimeout(resizeTimer);
              scrollArea.removeEventListener("scroll", onScroll);
              window.removeEventListener("resize", onResize);
            };
          }

          // Koltuk tıklama: sadece seçim (available ↔ reserved, en fazla 5)
          document.querySelectorAll(".seat").forEach((seatElement) => {
            seatElement.addEventListener("click", () => {
              const seatId = seatElement.getAttribute("data-seat-id");
              const currentStatus = seatElement.getAttribute("data-status");
              toggleSeatSelection(eventId, seatId, currentStatus, seatElement);
            });
          });
        } catch (error) {
          console.error("Salon krokisi yüklenirken hata:", error);
          seatingChartContent.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Hata</h3>
              <p>Salon krokisi yüklenirken bir hata oluştu.</p>
            </div>
          `;
        }
      }

      // Örnek salon krokisi oluştur (geçici)
      function generateSampleSeatingChart(eventId) {
        let html = "";

        // Sol blok
        html += '<div class="seating-section">';
        html += '<div class="section-title">Sol Blok</div>';
        for (let row = 1; row <= 10; row++) {
          html += '<div class="seat-row">';
          for (let seat = 1; seat <= 8; seat++) {
            const seatId = `L${row}-${seat}`;
            html += `<div class="seat available" data-seat-id="${seatId}" data-status="available" data-event-id="${eventId}">${row}${String.fromCharCode(64 + seat)}</div>`;
          }
          html += "</div>";
        }
        html += "</div>";

        // Orta blok
        html += '<div class="seating-section">';
        html += '<div class="section-title">Orta Blok</div>';
        for (let row = 1; row <= 15; row++) {
          html += '<div class="seat-row">';
          for (let seat = 1; seat <= 12; seat++) {
            const seatId = `C${row}-${seat}`;
            html += `<div class="seat available" data-seat-id="${seatId}" data-status="available" data-event-id="${eventId}">${row}${String.fromCharCode(64 + seat)}</div>`;
          }
          html += "</div>";
        }
        html += "</div>";

        // Sağ blok
        html += '<div class="seating-section">';
        html += '<div class="section-title">Sağ Blok</div>';
        for (let row = 1; row <= 10; row++) {
          html += '<div class="seat-row">';
          for (let seat = 1; seat <= 8; seat++) {
            const seatId = `R${row}-${seat}`;
            html += `<div class="seat available" data-seat-id="${seatId}" data-status="available" data-event-id="${eventId}">${row}${String.fromCharCode(64 + seat)}</div>`;
          }
          html += "</div>";
        }
        html += "</div>";

        return html;
      }

      // İbrahim Erkal Büyük Salon krokisi oluştur
      async function generateIbrahimErkalBuyukSalonChart(
        eventId,
        seatsSnapshot,
      ) {
        // Firebase'deki koltuk durumlarını map'e çevir
        const seatStatusMap = {};
        if (!seatsSnapshot.empty) {
          seatsSnapshot.forEach((doc) => {
            const data = doc.data();
            seatStatusMap[data.seatId || doc.id] = data.status || "available";
          });
        }

        let html = "";

        // Ön Blok - PERDE'nin hemen altında (A-J satırları, her satırda 24 koltuk)
        // A, B, C, D, E, F, G, H, I, J (Ç harfi atlanıyor - İngilizce alfabe kullanıyoruz)
        html += '<div class="seating-section">';
        html += '<div class="section-title">Ön Blok</div>';

        const frontRows = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"]; // Ç harfi yok

        frontRows.forEach((rowLetter) => {
          html += '<div class="seat-row">';
          // Her satırda 24 koltuk, yan yana iki blok halinde (1-12 ve 13-24)
          for (let seatNum = 1; seatNum <= 24; seatNum++) {
            const seatId = `ON-${rowLetter}${seatNum}`;
            const status = seatStatusMap[seatId] || "available";
            const seatLabel = `${rowLetter}${seatNum}`; // A1, A2, A3... A24
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
          }
          html += "</div>";
        });
        html += "</div>";

        // Orta Blok - K'dan S'ye kadar (O harfi atlanıyor)
        // K, L, M, N, P, Q, R, S (O atlanıyor)
        html += '<div class="seating-section">';
        html += '<div class="section-title">Orta Blok</div>';

        const middleRows = ["K", "L", "M", "N", "P", "Q", "R", "S"]; // O harfi atlanıyor

        middleRows.forEach((rowLetter) => {
          html += '<div class="seat-row">';
          // 1'den 11'e kadar
          for (let seatNum = 1; seatNum <= 11; seatNum++) {
            const seatId = `ORTA-${rowLetter}${seatNum}`;
            const status = seatStatusMap[seatId] || "available";
            const seatLabel = `${rowLetter}${seatNum}`;
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
          }

          // 3 tane görünmez boşluk (tıklanamaz)
          for (let i = 0; i < 3; i++) {
            html += `<div class="seat disabled" style="visibility: hidden; pointer-events: none;" data-seat-id="ORTA-SPACER-${rowLetter}-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
          }

          // 12'den 21'e kadar
          for (let seatNum = 12; seatNum <= 21; seatNum++) {
            const seatId = `ORTA-${rowLetter}${seatNum}`;
            const status = seatStatusMap[seatId] || "available";
            const seatLabel = `${rowLetter}${seatNum}`;
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
          }
          html += "</div>";
        });
        html += "</div>";

        // Arka Blok - T, U, V, Y satırları
        html += '<div class="seating-section">';
        html += '<div class="section-title">Arka Blok</div>';

        // T, U, V satırları (-1'den başlıyor, yani başta 1 görünmez koltuk)
        const backRowsMinus1 = ["T", "U", "V"];
        backRowsMinus1.forEach((rowLetter) => {
          html += '<div class="seat-row">';

          // Başta 1 görünmez koltuk (-1)
          html += `<div class="seat disabled" style="visibility: hidden; pointer-events: none;" data-seat-id="ARKA-SPACER-${rowLetter}-start" data-status="disabled" data-event-id="${eventId}"></div>`;

          // 1'den 11'e kadar
          for (let seatNum = 1; seatNum <= 11; seatNum++) {
            const seatId = `ARKA-${rowLetter}${seatNum}`;
            const status = seatStatusMap[seatId] || "available";
            const seatLabel = `${rowLetter}${seatNum}`;
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
          }

          // 12 numaralı koltuk (T12, U12, V12) - diğer koltuklarla aynı standarda
          const seatId12 = `ARKA-${rowLetter}12`;
          const status12 = seatStatusMap[seatId12] || "available";
          html += `<div class="seat ${status12}" data-seat-id="${seatId12}" data-status="${status12}" data-event-id="${eventId}">${rowLetter}12</div>`;

          // 3 tane görünmez boşluk (tıklanamaz) - diğer bloklarla aynı
          for (let i = 0; i < 3; i++) {
            html += `<div class="seat disabled" style="visibility: hidden; pointer-events: none;" data-seat-id="ARKA-SPACER-${rowLetter}-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
          }

          // 13'ten 24'e kadar
          for (let seatNum = 13; seatNum <= 24; seatNum++) {
            const seatId = `ARKA-${rowLetter}${seatNum}`;
            const status = seatStatusMap[seatId] || "available";
            const seatLabel = `${rowLetter}${seatNum}`;
            html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
          }
          html += "</div>";
        });

        // Y satırı (-2'den başlıyor, yani başta 2 görünmez koltuk, Y13'te bitiyor, sonra Y14-Y27)
        html += '<div class="seat-row">';

        // Başta 2 görünmez koltuk (-2)
        for (let i = 0; i < 2; i++) {
          html += `<div class="seat disabled" style="visibility: hidden; pointer-events: none;" data-seat-id="ARKA-SPACER-Y-start-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
        }

        // Y1'den Y13'e kadar
        for (let seatNum = 1; seatNum <= 13; seatNum++) {
          const seatId = `ARKA-Y${seatNum}`;
          const status = seatStatusMap[seatId] || "available";
          const seatLabel = `Y${seatNum}`;
          html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
        }

        // 3 tane görünmez boşluk (tıklanamaz)
        for (let i = 0; i < 3; i++) {
          html += `<div class="seat disabled" style="visibility: hidden; pointer-events: none;" data-seat-id="ARKA-SPACER-Y-${i}" data-status="disabled" data-event-id="${eventId}"></div>`;
        }

        // Y14'ten Y27'ye kadar
        for (let seatNum = 14; seatNum <= 27; seatNum++) {
          const seatId = `ARKA-Y${seatNum}`;
          const status = seatStatusMap[seatId] || "available";
          const seatLabel = `Y${seatNum}`;
          html += `<div class="seat ${status}" data-seat-id="${seatId}" data-status="${status}" data-event-id="${eventId}">${seatLabel}</div>`;
        }
        html += "</div>";

        html += "</div>";

        return html;
      }

      // Firebase'den koltuk verilerini kullanarak kroki oluştur
      async function generateSeatingChartFromFirebase(seatsSnapshot, eventId) {
        // Bu fonksiyon Firebase'deki koltuk yapısına göre güncellenecek
        // Şimdilik örnek krokisini kullan
        return generateSampleSeatingChart(eventId);
      }

      // Koltuk durumunu değiştir
      async function toggleSeatStatus(
        eventId,
        seatId,
        currentStatus,
        seatElement,
      ) {
        if (seatElement.classList.contains("disabled")) {
          return;
        }

        let newStatus;
        if (currentStatus === "available") {
          newStatus = "reserved";
        } else if (currentStatus === "reserved") {
          newStatus = "occupied";
        } else if (currentStatus === "occupied") {
          newStatus = "available";
        } else {
          newStatus = "available";
        }

        try {
          // Firebase'de koltuk durumunu güncelle
          const seatRef = doc(db, "activity", eventId, "seats", seatId);
          await updateDoc(seatRef, {
            status: newStatus,
            updatedAt: Timestamp.now(),
            updatedBy: currentUserEmail,
          });

          // UI'ı güncelle
          seatElement.setAttribute("data-status", newStatus);
          seatElement.className = `seat ${newStatus}`;

          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "ticket_seat_status_change",
            page: "ticket-management",
            targetId: eventId,
            targetType: "event",
            meta: {
              seatId: seatId,
              oldStatus: currentStatus,
              newStatus: newStatus,
            },
          });
        } catch (error) {
          // Eğer koltuk dokümanı yoksa oluştur
          try {
            const seatRef = doc(db, "activity", eventId, "seats", seatId);
            await setDoc(seatRef, {
              seatId: seatId,
              status: newStatus,
              eventId: eventId,
              createdAt: Timestamp.now(),
              updatedAt: Timestamp.now(),
              updatedBy: currentUserEmail,
            });

            seatElement.setAttribute("data-status", newStatus);
            seatElement.className = `seat ${newStatus}`;
          } catch (createError) {
            console.error("Koltuk oluşturulurken hata:", createError);
            alert("Koltuk durumu güncellenirken bir hata oluştu.");
          }
        }
      }

      // Listeye dön butonu
      document.getElementById("backToListBtn").addEventListener("click", () => {
        document.getElementById("eventsListContainer").style.display = "block";
        document.getElementById("seatingChartContainer").style.display = "none";
      });

      // Rezerve Et butonu
      document.getElementById("rezerveEtBtn").addEventListener("click", () => {
        if (selectedSeatIds.size === 0) {
          alert("Lütfen koltuk seçiniz.");
          return;
        }
        openReservationModal();
      });

      // Rezervasyon diyalogu: Geri Dön / İptal
      document
        .getElementById("reservationCancelBtn")
        .addEventListener("click", () => {
          if (reservationModalMode === "reserve") {
            revertSelectedSeatsToAvailable();
            clearReservationCountdown();
            closeReservationModal();
            updateRezerveEtButton();
          } else {
            closeReservationModal();
          }
        });

      // Rezervasyon diyalogu: X ile kapat
      document
        .getElementById("reservationModalCloseBtn")
        .addEventListener("click", () => {
          if (reservationModalMode === "reserve") {
            revertSelectedSeatsToAvailable();
            clearReservationCountdown();
            closeReservationModal();
            updateRezerveEtButton();
          } else {
            closeReservationModal();
          }
        });

      // Rezervasyonu İptal Et (dolu koltuk diyalogunda)
      document
        .getElementById("reservationRevokeBtn")
        .addEventListener("click", () => {
          revokeSeatReservation();
        });

      // Rezervasyonu Tamamla
      document
        .getElementById("reservationCompleteBtn")
        .addEventListener("click", () => {
          confirmReservation();
        });

      // Sayfa yüklendiğinde etkinlikleri yükle
      loadTicketEvents();
    </script>
  </body>
</html>
