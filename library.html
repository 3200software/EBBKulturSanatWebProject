<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kütüphane Yönetimi</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/mobile.css" />
    <link rel="stylesheet" href="css/tablet.css" />
    <link rel="stylesheet" href="css/activity.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }

      .offcanvas {
        transform: translateX(-100%);
        visibility: visible;
        transition: transform 0.3s ease;
        width: 400px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        height: 100vh;
        background-color: white;
      }

      .offcanvas.show {
        transform: translateX(0);
      }

      #mainContainer {
        transition: all 0.3s ease;
        width: 100%;
        margin-left: 0;
        position: relative;
        overflow-x: auto;
        padding-bottom: 60px;
      }

      #mainContainer.shifted {
        margin-left: 400px;
        width: calc(100% - 400px);
      }

      #menuButton {
        display: inline-block;
      }

      @media (max-width: 992px) {
        /* Tablet and Mobile: Hide offcanvas by default */
        .offcanvas {
          transform: translateX(-100%);
        }

        .offcanvas.show {
          transform: translateX(0);
        }

        #mainContainer.shifted {
          margin-left: 0;
          width: 100%;
        }

        /* Show menu button on mobile and tablet */
        #menuButton {
          display: inline-block;
        }

        /* Mobile overlay */
        .menu-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1040;
        }

        .menu-overlay.active {
          display: block;
        }
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
        overflow-x: auto;
        padding: 20px;
      }

      footer {
        height: 50px;
        background-color: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
      }

      .container-fluid {
        margin-bottom: 70px;
      }

      .stats-card {
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 20px;
      }

      .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .book-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #28a745;
        height: 100%;
      }

      .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .book-cover {
        width: 80px;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        border: 2px solid #e9ecef;
      }

      .book-placeholder {
        width: 80px;
        height: 120px;
        border-radius: 4px;
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #6c757d;
      }

      .book-details {
        min-height: 120px;
      }

      .card-actions {
        display: flex;
        gap: 8px;
      }

      #bookListContainer {
        display: block;
      }

      #bookFormContainer {
        display: none;
      }

      /* Yeni Kitap Ekle Butonu Stilleri */
      .book-action-bar {
        background: #28a745 !important;
        transition: all 0.3s ease;
        border: none;
      }

      .book-action-bar:hover {
        background: #218838 !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4) !important;
      }

      .book-action-btn {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        transition: all 0.2s ease;
      }

      .book-action-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        transform: scale(1.05);
      }

      .book-action-btn:focus {
        box-shadow: none !important;
        background: rgba(255, 255, 255, 0.1) !important;
      }

      .book-info-badge {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        display: inline-block;
        margin-right: 5px;
        margin-bottom: 5px;
      }

      .search-container {
        margin-bottom: 20px;
      }

      .search-input {
        border-radius: 25px;
        padding: 10px 20px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }

      .table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .table-success {
        background-color: #d1e7dd !important;
      }

      .table-warning {
        background-color: #fff3cd !important;
      }

      .table-secondary {
        background-color: #e9ecef !important;
      }

      /* Ana Menü Butonları Stilleri */
      #mainMenuButtons .btn {
        border: 2px solid !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        padding: 12px 24px !important;
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
      }

      #mainMenuButtons #showBooksSection {
        background-color: #157347 !important;
        border-color: #146c43 !important;
        color: white !important;
      }

      #mainMenuButtons #showBooksSection:hover {
        background-color: #0f5132 !important;
        border-color: #0d4128 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(25, 135, 84, 0.4);
      }

      #mainMenuButtons #showLoansSection {
        background-color: #0aa2c0 !important;
        border-color: #087990 !important;
        color: white !important;
      }

      #mainMenuButtons #showLoansSection:hover {
        background-color: #087990 !important;
        border-color: #066373 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(13, 202, 240, 0.4);
      }

      .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        border-bottom: 1px solid #dee2e6;
      }

      .form-control,
      .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }

      .btn {
        border-radius: 6px;
      }

      /* QR Code Scanner Styles */
      .qr-scanner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .qr-scanner-container.active {
        display: flex;
      }

      .qr-scanner-video {
        width: 90%;
        max-width: 500px;
        border: 3px solid #fff;
        border-radius: 10px;
      }

      .qr-scanner-controls {
        margin-top: 20px;
        display: flex;
        gap: 15px;
      }

      .qr-scanner-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 3px solid #28a745;
        border-radius: 10px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      }

      .qr-scanner-status {
        color: white;
        margin-top: 20px;
        font-size: 1.1rem;
        text-align: center;
      }

      .qr-button-mobile {
        display: none;
      }

      @media (max-width: 768px) {
        .offcanvas {
          width: 300px;
        }

        #mainContainer.shifted {
          margin-left: 300px;
          width: calc(100% - 300px);
        }

        .book-card {
          text-align: center;
        }

        .book-cover,
        .book-placeholder {
          margin: 0 auto 15px auto;
        }

        .qr-button-mobile {
          display: inline-block;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div
        class="offcanvas offcanvas-start"
        data-bs-backdrop="false"
        id="adminPanelSideMenu"
      >
        <div
          class="offcanvas-header d-flex justify-content-start"
          style="margin-top: 2%"
        >
          <div>
            <img
              src="assets/274348852_320609883437173_4953649348556891409_n.jpg"
              alt="profilResmi"
              width="50px"
              height="50px"
              style="border-radius: 50px"
            />
          </div>
          <div class="offcanvas-title text-primary ms-4 h4">Yönetim Paneli</div>
        </div>

        <div
          class="offcanvas-body offcanvas-primary d-flex align-items-top flex-column"
        >
          <div class="list-group mb-auto p2">
            <a
              href="activity.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,2,2a"
              >Etkinlikler
            </a>
            <a
              href="staff.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,10,10a"
              >Ekip</a
            >
            <a
              href="salooncontrol.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,3,3a"
              >Salon Takip</a
            >
            <a
              href="news.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,5,5a"
              >Haberler</a
            >
            <a
              href="costume.html"
              class="list-group-item list-group-item-action"
              data-required-permissions="1,1a,9,9a"
              >Kostümler</a
            >
            <a
              href="library.html"
              class="list-group-item list-group-item-action active"
              data-required-permissions="1,1a,8,8a"
              >Kütüphane</a
            >
            <a
              href="messages.html"
              class="list-group-item list-group-item-action messages-link"
              style="display: none"
              data-required-permissions="1,1a,2,2a"
              >Mesajlar</a
            >
          </div>

          <div class="list-group">
            <a href="users.html" class="list-group-item list-group-item-action">
              Kullanıcılar
            </a>
            <button
              class="list-group-item list-group-item-action bg-danger text-white"
              id="logoutButton"
            >
              Çıkış Yap
            </button>
          </div>
        </div>
      </div>

      <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

      <div class="container-fluid" id="mainContainer">
        <div
          class="containerTitle d-flex justify-content-between border-bottom border-primary bg-white"
        >
          <button class="btn btn-primary mb-3 mt-3" id="menuButton">
            <i class="fas fa-times"></i>
          </button>
          <div class="h3 text-primary m-3 pb-0 flex-fill">
            Kütüphane Yönetimi
          </div>
        </div>

        <!-- İstatistikler -->
        <div class="row mt-4">
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #28a745, #20c997)"
            >
              <div class="stats-number" id="totalBooks">0</div>
              <div class="stats-label">Toplam Kitap</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #007bff, #0056b3)"
            >
              <div class="stats-number" id="totalCopies">0</div>
              <div class="stats-label">Toplam Adet</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #ffc107, #fd7e14)"
            >
              <div class="stats-number" id="totalAuthors">0</div>
              <div class="stats-label">Farklı Yazar</div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div
              class="stats-card"
              style="background: linear-gradient(135deg, #dc3545, #e83e8c)"
            >
              <div class="stats-number" id="totalPublishers">0</div>
              <div class="stats-label">Farklı Yayın Evi</div>
            </div>
          </div>
        </div>

        <!-- Ana Menü Butonları -->
        <div class="row mt-4" id="mainMenuButtons">
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center">
                <div
                  class="d-flex gap-3 justify-content-center flex-wrap align-items-center"
                  style="min-height: 100px"
                >
                  <button
                    type="button"
                    class="btn btn-success btn-lg"
                    id="showBooksSection"
                    style="
                      min-width: 250px;
                      opacity: 1;
                      visibility: visible;
                      display: inline-block;
                    "
                  >
                    <i class="fas fa-books me-2"></i>Kitaplar
                  </button>
                  <button
                    type="button"
                    class="btn btn-info btn-lg"
                    id="showLoansSection"
                    style="
                      min-width: 250px;
                      opacity: 1;
                      visibility: visible;
                      display: inline-block;
                    "
                  >
                    <i class="fas fa-list me-2"></i>Kitap Çıkış Kayıtları
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ana İçerik -->
        <div class="row" id="mainContentSection" style="display: none">
          <div class="col-12" id="bookFormContainer" style="display: none">
            <div class="card">
              <div
                class="card-header bg-success text-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">
                  <i class="fas fa-book me-2"></i>Yeni Kitap Ekle
                </h5>
                <button
                  class="btn btn-sm btn-outline-light"
                  id="hideFormButton"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="card-body">
                <form id="bookForm">
                  <div class="row">
                    <!-- Sol Sütun -->
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Kitap Adı *</label>
                        <div class="input-group">
                          <input
                            type="text"
                            class="form-control"
                            id="bookTitle"
                            required
                            placeholder="Kitap adını girin"
                          />
                          <button
                            type="button"
                            class="btn btn-outline-secondary qr-button-mobile"
                            onclick="startQRScanForBook()"
                            title="QR/Barkod Okut"
                          >
                            <i class="fas fa-qrcode"></i>
                          </button>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Yazar *</label>
                        <input
                          type="text"
                          class="form-control"
                          id="bookAuthor"
                          required
                          placeholder="Yazar adını girin"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Yayın Evi *</label>
                        <input
                          type="text"
                          class="form-control"
                          id="bookPublisher"
                          required
                          placeholder="Yayın evini girin"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">ISBN</label>
                        <input
                          type="text"
                          class="form-control"
                          id="bookIsbn"
                          placeholder="ISBN numarası"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Yayın Yılı</label>
                        <input
                          type="number"
                          class="form-control"
                          id="bookYear"
                          min="1000"
                          max="9999"
                          placeholder="Örn: 2024"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Sayfa Sayısı</label>
                        <input
                          type="number"
                          class="form-control"
                          id="bookPages"
                          min="1"
                          placeholder="Sayfa sayısı"
                        />
                      </div>
                    </div>

                    <!-- Sağ Sütun -->
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label class="form-label">Baskı Sayısı</label>
                        <input
                          type="number"
                          class="form-control"
                          id="bookEdition"
                          min="1"
                          placeholder="Baskı sayısı"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Dil</label>
                        <select class="form-select" id="bookLanguage">
                          <option value="">Dil Seçin</option>
                          <option value="Türkçe">Türkçe</option>
                          <option value="İngilizce">İngilizce</option>
                          <option value="Arapça">Arapça</option>
                          <option value="Farsça">Farsça</option>
                          <option value="Diğer">Diğer</option>
                        </select>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Kategori</label>
                        <input
                          type="text"
                          class="form-control"
                          id="bookCategory"
                          placeholder="Örn: Roman, Tarih, Bilim"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Adet</label>
                        <input
                          type="number"
                          class="form-control"
                          id="bookQuantity"
                          min="1"
                          value="1"
                          placeholder="Kitap adedi"
                        />
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Açıklama</label>
                        <textarea
                          class="form-control"
                          id="bookDescription"
                          rows="4"
                          placeholder="Kitap hakkında açıklama..."
                        ></textarea>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Kapak Fotoğrafı</label>
                        <div class="input-group mb-2">
                          <input
                            type="file"
                            class="form-control"
                            id="bookCoverFile"
                            accept="image/*"
                          />
                          <button
                            class="btn btn-outline-secondary"
                            type="button"
                            id="uploadCoverBtn"
                          >
                            <i class="fas fa-upload"></i> Yükle
                          </button>
                        </div>
                        <input
                          type="url"
                          class="form-control"
                          id="bookCoverUrl"
                          placeholder="Kapak fotoğrafı URL'si"
                          readonly
                        />
                      </div>
                    </div>
                  </div>

                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success">
                      <i class="fas fa-save me-2"></i>Kitap Ekle
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      id="cancelFormButton"
                    >
                      <i class="fas fa-arrow-left me-2"></i>Geri Dön
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Kitap Listesi -->
        <div class="row" id="booksSection" style="display: none">
          <div class="col-12" id="bookListContainer">
            <div class="card">
              <div
                class="card-header text-white d-flex justify-content-between align-items-center book-action-bar"
                style="box-shadow: 0 2px 10px rgba(40, 167, 69, 0.2)"
              >
                <h5 class="mb-0"><i class="fas fa-books me-2"></i>Kitaplar</h5>
                <div class="d-flex gap-2" id="addBookButtonContainer">
                  <button
                    type="button"
                    class="btn text-white border-0 book-action-btn"
                    id="showAddBookForm"
                    style="
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 6px;
                    "
                  >
                    <i class="fas fa-plus me-1"></i>Yeni Kitap Ekle
                  </button>
                  <button
                    type="button"
                    class="btn text-white border-0 book-action-btn"
                    onclick="loadBooks()"
                    style="
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 6px;
                    "
                  >
                    <i class="fas fa-sync-alt me-1"></i>Yenile
                  </button>
                  <button
                    type="button"
                    class="btn text-white border-0 book-action-btn"
                    onclick="showMainMenu()"
                    style="
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 6px;
                    "
                  >
                    <i class="fas fa-arrow-left me-1"></i>Geri Dön
                  </button>
                </div>
              </div>
              <div class="card-body">
                <!-- Arama Çubuğu -->
                <div class="search-container">
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-search"></i>
                    </span>
                    <input
                      type="text"
                      class="form-control search-input"
                      id="searchBooks"
                      placeholder="Kitap adı, yazar, yayın evi veya ISBN ile ara..."
                    />
                  </div>
                </div>

                <div id="bookContainer">
                  <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Kitaplar yükleniyor...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Kitap Çıkış Kayıtları -->
        <div class="row mt-4" id="loansSection" style="display: none">
          <div class="col-12">
            <div class="card">
              <div
                class="card-header bg-info text-white d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">
                  <i class="fas fa-list me-2"></i>Kitap Çıkış Kayıtları
                </h5>
                <div class="d-flex gap-2">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-light"
                    onclick="loadBookLoans()"
                  >
                    <i class="fas fa-sync-alt me-1"></i>Yenile
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-light"
                    onclick="showMainMenu()"
                  >
                    <i class="fas fa-arrow-left me-1"></i>Geri Dön
                  </button>
                </div>
              </div>
              <div class="card-body">
                <!-- Arama Çubuğu -->
                <div class="search-container mb-3">
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="fas fa-search"></i>
                    </span>
                    <input
                      type="text"
                      class="form-control search-input"
                      id="searchLoans"
                      placeholder="Kitap adı, yazar, teslim alan veya not ile ara..."
                    />
                  </div>
                </div>

                <div id="bookLoansContainer">
                  <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Çıkış kayıtları yükleniyor...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- QR Kod Okuma Scanner -->
    <div id="qrScannerContainer" class="qr-scanner-container">
      <div class="qr-scanner-overlay"></div>
      <video id="qrVideo" class="qr-scanner-video" autoplay playsinline></video>
      <canvas id="qrCanvas" style="display: none"></canvas>
      <div class="qr-scanner-status" id="qrScannerStatus">
        QR kod veya barkodu kameraya doğrultun...
      </div>
      <div class="qr-scanner-controls">
        <button
          type="button"
          class="btn btn-danger btn-lg"
          onclick="stopQRScan()"
        >
          <i class="fas fa-times me-2"></i>İptal
        </button>
      </div>
    </div>

    <!-- Kitap Çıkış Modalı -->
    <div
      class="modal fade"
      id="bookLoanModal"
      tabindex="-1"
      aria-labelledby="bookLoanModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="bookLoanModalLabel">
              <i class="fas fa-sign-out-alt me-2"></i>Kitap Çıkışı
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              data-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="bookLoanForm">
              <input type="hidden" id="loanBookId" />

              <div class="mb-3">
                <label class="form-label">Kitap *</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="loanBookTitle"
                    readonly
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary qr-button-mobile"
                    onclick="startQRScanForLoan()"
                    title="QR/Barkod Okut"
                  >
                    <i class="fas fa-qrcode"></i>
                  </button>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Mevcut Adet</label>
                <input
                  type="text"
                  class="form-control"
                  id="loanBookQuantity"
                  readonly
                  disabled
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Teslim Alan (Kişi/Kurum) *</label>
                <input
                  type="text"
                  class="form-control"
                  id="loanBorrower"
                  required
                  placeholder="Örn: Ahmet Yılmaz veya Erzurum Üniversitesi"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Teslim Edilen Adet *</label>
                <input
                  type="number"
                  class="form-control"
                  id="loanQuantity"
                  required
                  min="1"
                  value="1"
                  placeholder="Teslim edilen kitap adedi"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Teslim Tarihi *</label>
                <input
                  type="date"
                  class="form-control"
                  id="loanDate"
                  required
                />
              </div>

              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="willReturn"
                    onchange="toggleReturnDate()"
                  />
                  <label class="form-check-label" for="willReturn">
                    Kitap geri gelecek
                  </label>
                </div>
              </div>

              <div class="mb-3" id="returnDateContainer" style="display: none">
                <label class="form-label">Geri Getirme Tarihi *</label>
                <input
                  type="date"
                  class="form-control"
                  id="loanReturnDate"
                  placeholder="Geri getirme tarihi"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Not/Açıklama</label>
                <textarea
                  class="form-control"
                  id="loanNotes"
                  rows="3"
                  placeholder="Ek notlar..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
              data-dismiss="modal"
            >
              <i class="fas fa-times me-1"></i>İptal
            </button>
            <button
              type="button"
              class="btn btn-info"
              onclick="submitBookLoan()"
            >
              <i class="fas fa-save me-1"></i>Kaydet
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p style="margin: 0">© 2024 EBB Kültür Sanat. Tüm hakları saklıdır.</p>
    </footer>

    <script src="js/main.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- Firebase -->
    <script type="module">
      // Firebase imports
      import {
        initializeApp,
        getApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        query,
        orderBy,
        where,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
      import { ensureAuth, logActivity } from "./js/authGuard.js";
      import {
        updateMessagesLinkVisibility,
        enforceLinkPermissions,
      } from "./js/offcanvas.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD978ixFjE9KVlNsm6-BYww3B6S4qPVLfQ",
        authDomain: "ebbkultursanatapp.firebaseapp.com",
        projectId: "ebbkultursanatapp",
        storageBucket: "ebbkultursanatapp.appspot.com",
        messagingSenderId: "540910775157",
        appId: "1:540910775157:web:4af35312414acf20bd013c",
        measurementId: "G-4JCKV13ER8",
      };

      // Initialize Firebase
      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      const authContext = await ensureAuth({
        app,
        auth,
        db,
        requiredAny: ["1", "1a", "8", "8a"],
        writeCodes: ["1", "8"],
        pageName: "Kütüphane Yönetimi",
      }).catch((error) => {
        console.error("Yetkilendirme başarısız:", error);
        return null;
      });

      if (!authContext) {
        throw new Error("Authorisation failed");
      }

      const currentUserEmail = authContext.user.email;
      const currentUserName =
        authContext.profile?.userName || authContext.user.displayName || "";
      const currentUserPermissions = authContext.permissions || [];
      const canWrite = authContext.canWrite;
      updateMessagesLinkVisibility(currentUserPermissions);
      enforceLinkPermissions(currentUserPermissions);

      if (!canWrite) {
        document.body.dataset.readOnly = "true";
      }

      window.currentUserEmail = currentUserEmail;
      window.currentUserName = currentUserName;
      window.libraryCanWrite = canWrite;
      window.libraryUserPermissions = currentUserPermissions;

      // Global variables
      let books = [];
      let editingBookId = null;
      let filteredBooks = [];
      let bookLoans = [];
      let filteredLoans = [];
      let qrScanning = false;
      let qrStream = null;
      let qrScanMode = null; // 'book' or 'loan'

      // Helper function to close modal (Bootstrap 4/5 compatibility)
      function hideModalById(id) {
        const el = document.getElementById(id);
        if (!el) return;
        try {
          if (window.bootstrap && bootstrap.Modal) {
            const inst = bootstrap.Modal.getInstance
              ? bootstrap.Modal.getInstance(el)
              : null;
            if (inst) {
              inst.hide();
              return;
            }
            const created = new bootstrap.Modal(el);
            created.hide();
            return;
          }
        } catch (e) {}
        if (window.$ && window.$.fn && window.$.fn.modal) {
          window.$(el).modal("hide");
          return;
        }
        el.classList.remove("show");
        el.style.display = "none";
      }

      // Form toggle functions
      function showBookForm() {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        console.log("showBookForm called");

        const buttonContainer = document.getElementById(
          "addBookButtonContainer"
        );
        const listContainer = document.getElementById("bookListContainer");
        const formContainer = document.getElementById("bookFormContainer");

        if (buttonContainer) {
          buttonContainer.style.display = "none";
          buttonContainer.style.visibility = "hidden";
        }
        if (listContainer) {
          listContainer.style.display = "none";
          listContainer.style.visibility = "hidden";
        }
        if (formContainer) {
          formContainer.style.display = "block";
          formContainer.style.visibility = "visible";
          formContainer.style.opacity = "1";

          setTimeout(() => {
            formContainer.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }, 100);
        }

        const titleElement = document.querySelector(
          "#bookFormContainer .card-header h5"
        );
        if (titleElement) {
          titleElement.innerHTML =
            '<i class="fas fa-book me-2"></i>Yeni Kitap Ekle';
        }

        if (!editingBookId) {
          const form = document.getElementById("bookForm");
          if (form) {
            form.reset();
            document.getElementById("bookQuantity").value = "1";
          }
        }
      }

      function hideBookForm() {
        const buttonContainer = document.getElementById(
          "addBookButtonContainer"
        );
        const listContainer = document.getElementById("bookListContainer");
        const formContainer = document.getElementById("bookFormContainer");

        if (buttonContainer) {
          buttonContainer.style.display = "flex";
          buttonContainer.style.visibility = "visible";
        }
        if (listContainer) {
          listContainer.style.display = "block";
          listContainer.style.visibility = "visible";
        }
        if (formContainer) {
          formContainer.style.display = "none";
          formContainer.style.visibility = "hidden";
        }

        const form = document.getElementById("bookForm");
        if (form) form.reset();
        editingBookId = null;
        document.getElementById("bookQuantity").value = "1";

        const submitBtn = document.querySelector(
          '#bookForm button[type="submit"]'
        );
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Kitap Ekle';
        }
      }

      // Menu toggle functionality (salooncontrol style)
      function setupMenuToggle() {
        const menuButton = document.getElementById("menuButton");
        const adminPanel = document.getElementById("adminPanelSideMenu");
        const mainContainer = document.getElementById("mainContainer");

        if (!menuButton || !adminPanel || !mainContainer) {
          return;
        }

        const menuIcon = menuButton.querySelector("i");

        function toggleMenu() {
          adminPanel.classList.toggle("show");
          mainContainer.classList.toggle("shifted");

          // İkon değişimi
          if (menuIcon) {
            if (menuIcon.classList.contains("fa-bars")) {
              menuIcon.classList.remove("fa-bars");
              menuIcon.classList.add("fa-times");
            } else {
              menuIcon.classList.remove("fa-times");
              menuIcon.classList.add("fa-bars");
            }
          }
        }

        menuButton.addEventListener("click", function (e) {
          e.stopPropagation();
          toggleMenu();
        });

        // Initialize: menu açık başla (salooncontrol gibi)
        adminPanel.classList.add("show");
        mainContainer.classList.add("shifted");
        if (menuIcon) {
          menuIcon.classList.remove("fa-bars");
          menuIcon.classList.add("fa-times");
        }
      }

      function initializeLibraryPage() {
        setupMenuToggle();

        const addBookButtonContainer = document.getElementById(
          "addBookButtonContainer"
        );

        // Add event listeners for form toggle
        const showAddBookBtn = document.getElementById("showAddBookForm");
        if (showAddBookBtn) {
          showAddBookBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Add book button clicked");
            showBookForm();
            return false;
          });
        }

        const hideFormBtn = document.getElementById("hideFormButton");
        if (hideFormBtn) {
          hideFormBtn.addEventListener("click", function (e) {
            e.preventDefault();
            hideBookForm();
          });
        }

        const cancelFormBtn = document.getElementById("cancelFormButton");
        if (cancelFormBtn) {
          cancelFormBtn.addEventListener("click", function (e) {
            e.preventDefault();
            hideBookForm();
          });
        }

        // Search functionality for books
        const searchInput = document.getElementById("searchBooks");
        if (searchInput) {
          searchInput.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            filterBooks(searchTerm);
          });
        }

        // Search functionality for loans
        const searchLoansInput = document.getElementById("searchLoans");
        if (searchLoansInput) {
          searchLoansInput.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            filterLoans(searchTerm);
          });
        }

        // Set today's date as default for loan date
        const loanDateInput = document.getElementById("loanDate");
        if (loanDateInput) {
          const today = new Date().toISOString().split("T")[0];
          loanDateInput.value = today;
        }

        // Main menu buttons
        const showBooksSectionBtn = document.getElementById("showBooksSection");
        if (showBooksSectionBtn) {
          showBooksSectionBtn.addEventListener("click", function () {
            showBooksSection();
          });
        }

        const showLoansSectionBtn = document.getElementById("showLoansSection");
        if (showLoansSectionBtn) {
          showLoansSectionBtn.addEventListener("click", function () {
            showLoansSection();
          });
        }

        if (!canWrite) {
          if (showAddBookBtn) {
            showAddBookBtn.disabled = true;
            showAddBookBtn.classList.add("disabled");
          }
          if (addBookButtonContainer) {
            addBookButtonContainer.style.display = "none";
          }
          const bookFormContainer =
            document.getElementById("bookFormContainer");
          if (bookFormContainer) {
            bookFormContainer.classList.add("d-none");
          }
        }

        // Initialize
        loadBooks();
        loadBookLoans();
        setupBookForm();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeLibraryPage);
      } else {
        initializeLibraryPage();
      }

      // Show main menu
      window.showMainMenu = function () {
        document.getElementById("mainContentSection").style.display = "none";
        document.getElementById("booksSection").style.display = "none";
        document.getElementById("loansSection").style.display = "none";
        document.getElementById("bookFormContainer").style.display = "none";
        document.getElementById("mainMenuButtons").style.display = "block";
      };

      // Show books section
      function showBooksSection() {
        document.getElementById("mainMenuButtons").style.display = "none";
        document.getElementById("mainContentSection").style.display = "block";
        document.getElementById("booksSection").style.display = "block";
        document.getElementById("loansSection").style.display = "none";
        document.getElementById("bookListContainer").style.display = "block";
        document.getElementById("bookFormContainer").style.display = "none";
        const addBookContainer = document.getElementById(
          "addBookButtonContainer"
        );
        if (addBookContainer) {
          addBookContainer.style.display = canWrite ? "flex" : "none";
        }
      }

      // Show loans section
      function showLoansSection() {
        document.getElementById("mainMenuButtons").style.display = "none";
        document.getElementById("mainContentSection").style.display = "block";
        document.getElementById("booksSection").style.display = "none";
        document.getElementById("loansSection").style.display = "block";
      }

      // Filter books
      function filterBooks(searchTerm) {
        if (!searchTerm) {
          filteredBooks = [...books];
        } else {
          filteredBooks = books.filter((book) => {
            const title = (book.title || "").toLowerCase();
            const author = (book.author || "").toLowerCase();
            const publisher = (book.publisher || "").toLowerCase();
            const isbn = (book.isbn || "").toLowerCase();
            const category = (book.category || "").toLowerCase();

            return (
              title.includes(searchTerm) ||
              author.includes(searchTerm) ||
              publisher.includes(searchTerm) ||
              isbn.includes(searchTerm) ||
              category.includes(searchTerm)
            );
          });
        }
        renderBooks();
      }

      // Filter loans
      function filterLoans(searchTerm) {
        if (!searchTerm) {
          filteredLoans = [...bookLoans];
        } else {
          filteredLoans = bookLoans.filter((loan) => {
            const bookTitle = (loan.bookTitle || "").toLowerCase();
            const bookAuthor = (loan.bookAuthor || "").toLowerCase();
            const borrower = (loan.borrower || "").toLowerCase();
            const notes = (loan.notes || "").toLowerCase();

            return (
              bookTitle.includes(searchTerm) ||
              bookAuthor.includes(searchTerm) ||
              borrower.includes(searchTerm) ||
              notes.includes(searchTerm)
            );
          });
        }
        renderBookLoans();
      }

      // Load books from Firebase
      async function loadBooks() {
        try {
          const booksRef = collection(db, "books");
          const q = query(booksRef, orderBy("title", "asc"));
          const querySnapshot = await getDocs(q);

          books = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            books.push({
              id: doc.id,
              ...data,
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
            });
          });

          filteredBooks = [...books];
          renderBooks();
          updateStats();
        } catch (error) {
          console.error("Error loading books:", error);
          document.getElementById("bookContainer").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
              <p class="mt-2 text-danger">Kitaplar yüklenirken hata oluştu!</p>
            </div>
          `;
        }
      }

      // Render books list
      function renderBooks() {
        const container = document.getElementById("bookContainer");

        if (filteredBooks.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-book fa-2x text-muted"></i>
              <p class="mt-2 text-muted">Henüz kitap bulunmuyor.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="row">
            ${filteredBooks
              .map(
                (book) => `
              <div class="col-lg-6 col-xl-4 mb-3">
                <div class="card h-100 book-card">
                  <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                      ${
                        book.coverUrl
                          ? `
                        <img src="${book.coverUrl}" alt="${book.title}" class="book-cover me-3">
                      `
                          : `
                        <div class="book-placeholder me-3">
                          <i class="fas fa-book fa-2x text-muted"></i>
                        </div>
                      `
                      }
                      <div class="flex-grow-1">
                        <h5 class="card-title mb-2">${
                          book.title || "İsimsiz Kitap"
                        }</h5>
                        <p class="mb-1 text-muted small">
                          <i class="fas fa-user me-1"></i>${
                            book.author || "Yazar belirtilmemiş"
                          }
                        </p>
                        <p class="mb-1 text-muted small">
                          <i class="fas fa-building me-1"></i>${
                            book.publisher || "Yayın evi belirtilmemiş"
                          }
                        </p>
                      </div>
                    </div>
                    
                    <div class="book-details">
                      ${
                        book.isbn
                          ? `<span class="book-info-badge"><i class="fas fa-barcode me-1"></i>ISBN: ${book.isbn}</span>`
                          : ""
                      }
                      ${
                        book.year
                          ? `<span class="book-info-badge"><i class="fas fa-calendar me-1"></i>${book.year}</span>`
                          : ""
                      }
                      ${
                        book.pages
                          ? `<span class="book-info-badge"><i class="fas fa-file-alt me-1"></i>${book.pages} sayfa</span>`
                          : ""
                      }
                      ${
                        book.language
                          ? `<span class="book-info-badge"><i class="fas fa-language me-1"></i>${book.language}</span>`
                          : ""
                      }
                      ${
                        book.category
                          ? `<span class="book-info-badge"><i class="fas fa-tag me-1"></i>${book.category}</span>`
                          : ""
                      }
                      ${
                        book.quantity
                          ? `<span class="book-info-badge"><i class="fas fa-copy me-1"></i>Adet: ${book.quantity}</span>`
                          : ""
                      }
                      ${
                        book.description
                          ? `<p class="mt-2 text-muted small">${book.description.substring(
                              0,
                              100
                            )}${book.description.length > 100 ? "..." : ""}</p>`
                          : ""
                      }
                    </div>
                    
                    ${
                      canWrite
                        ? `<div class="card-actions mt-auto pt-2 border-top">
                            <button class="btn btn-info btn-sm me-2" onclick="showLoanModal('${book.id}')" title="Kitap Çıkışı">
                              <i class="fas fa-sign-out-alt me-1"></i>Çıkış
                            </button>
                            <button class="btn btn-warning btn-sm me-2" onclick="editBook('${book.id}')">
                              <i class="fas fa-edit me-1"></i>Düzenle
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBook('${book.id}')">
                              <i class="fas fa-trash me-1"></i>Sil
                            </button>
                          </div>`
                        : `<div class="mt-3 text-muted small border-top pt-2">
                            <i class="fas fa-lock me-1"></i>Bu kayıt üzerinde değişiklik yetkiniz yok.
                          </div>`
                    }
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
      }

      // Update statistics
      function updateStats() {
        const totalBooks = books.length;
        const totalCopies = books.reduce(
          (sum, book) => sum + (parseInt(book.quantity) || 1),
          0
        );
        const uniqueAuthors = new Set(
          books.map((book) => book.author).filter(Boolean)
        );
        const uniquePublishers = new Set(
          books.map((book) => book.publisher).filter(Boolean)
        );

        document.getElementById("totalBooks").textContent = totalBooks;
        document.getElementById("totalCopies").textContent = totalCopies;
        document.getElementById("totalAuthors").textContent =
          uniqueAuthors.size;
        document.getElementById("totalPublishers").textContent =
          uniquePublishers.size;
      }

      // Upload image to Firebase Storage
      async function uploadImage(file, folder) {
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageRef = ref(storage, `${folder}/${fileName}`);

        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        return downloadURL;
      }

      // Setup book form
      function setupBookForm() {
        const form = document.getElementById("bookForm");

        // Cover upload handler
        document
          .getElementById("uploadCoverBtn")
          .addEventListener("click", async () => {
            const fileInput = document.getElementById("bookCoverFile");
            const urlInput = document.getElementById("bookCoverUrl");
            const uploadBtn = document.getElementById("uploadCoverBtn");

            if (fileInput.files[0]) {
              try {
                uploadBtn.innerHTML =
                  '<i class="fas fa-spinner fa-spin"></i> Yükleniyor...';
                uploadBtn.disabled = true;

                const downloadURL = await uploadImage(
                  fileInput.files[0],
                  "book-covers"
                );
                urlInput.value = downloadURL;

                uploadBtn.innerHTML =
                  '<i class="fas fa-check text-success"></i> Yüklendi';
                setTimeout(() => {
                  uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Yükle';
                  uploadBtn.disabled = false;
                }, 2000);
              } catch (error) {
                console.error("Error uploading cover:", error);
                alert("Kapak fotoğrafı yüklenirken hata oluştu!");
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Yükle';
                uploadBtn.disabled = false;
              }
            } else {
              alert("Lütfen bir fotoğraf seçin!");
            }
          });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!canWrite) {
            alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
            return;
          }

          const formData = {
            title: document.getElementById("bookTitle").value.trim(),
            author: document.getElementById("bookAuthor").value.trim(),
            publisher: document.getElementById("bookPublisher").value.trim(),
            isbn: document.getElementById("bookIsbn").value.trim() || null,
            year: document.getElementById("bookYear").value
              ? parseInt(document.getElementById("bookYear").value)
              : null,
            pages: document.getElementById("bookPages").value
              ? parseInt(document.getElementById("bookPages").value)
              : null,
            edition: document.getElementById("bookEdition").value
              ? parseInt(document.getElementById("bookEdition").value)
              : null,
            language: document.getElementById("bookLanguage").value || null,
            category:
              document.getElementById("bookCategory").value.trim() || null,
            quantity: document.getElementById("bookQuantity").value
              ? parseInt(document.getElementById("bookQuantity").value)
              : 1,
            description:
              document.getElementById("bookDescription").value.trim() || null,
            coverUrl:
              document.getElementById("bookCoverUrl").value.trim() || null,
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now(),
          };

          // Validate required fields
          if (!formData.title || !formData.author || !formData.publisher) {
            alert("Lütfen kitap adı, yazar ve yayın evi alanlarını doldurun!");
            return;
          }

          try {
            if (editingBookId) {
              // Update existing book
              const bookRef = doc(db, "books", editingBookId);
              delete formData.createdAt; // Don't update createdAt
              formData.updatedAt = Timestamp.now();
              await updateDoc(bookRef, formData);
              await logActivity(db, {
                userEmail: currentUserEmail,
                userName: currentUserName,
                action: "library_book_update",
                page: "library",
                targetId: editingBookId,
                targetType: "book",
                meta: {
                  title: formData.title,
                  author: formData.author,
                },
              });
              alert("Kitap güncellendi!");
            } else {
              // Add new book
              const docRef = await addDoc(collection(db, "books"), formData);
              await logActivity(db, {
                userEmail: currentUserEmail,
                userName: currentUserName,
                action: "library_book_create",
                page: "library",
                targetId: docRef.id,
                targetType: "book",
                meta: {
                  title: formData.title,
                  author: formData.author,
                },
              });
              alert("Kitap eklendi!");
            }

            hideBookForm();
            loadBooks();
          } catch (error) {
            console.error("Error saving book:", error);
            alert("Kitap kaydedilirken hata oluştu!");
          }
        });
      }

      // Delete book
      window.deleteBook = async function (bookId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        if (!confirm("Bu kitabı silmek istediğinizden emin misiniz?")) return;

        try {
          const book = books.find((b) => b.id === bookId);
          await deleteDoc(doc(db, "books", bookId));
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "library_book_delete",
            page: "library",
            targetId: bookId,
            targetType: "book",
            meta: {
              title: book?.title || "",
            },
          });
          alert("Kitap silindi!");
          loadBooks();
        } catch (error) {
          console.error("Error deleting book:", error);
          alert("Kitap silinirken hata oluştu!");
        }
      };

      // Edit book
      window.editBook = function (bookId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const book = books.find((b) => b.id === bookId);
        if (!book) return;

        // Fill form with book data
        document.getElementById("bookTitle").value = book.title || "";
        document.getElementById("bookAuthor").value = book.author || "";
        document.getElementById("bookPublisher").value = book.publisher || "";
        document.getElementById("bookIsbn").value = book.isbn || "";
        document.getElementById("bookYear").value = book.year || "";
        document.getElementById("bookPages").value = book.pages || "";
        document.getElementById("bookEdition").value = book.edition || "";
        document.getElementById("bookLanguage").value = book.language || "";
        document.getElementById("bookCategory").value = book.category || "";
        document.getElementById("bookQuantity").value = book.quantity || 1;
        document.getElementById("bookDescription").value =
          book.description || "";
        document.getElementById("bookCoverUrl").value = book.coverUrl || "";

        editingBookId = bookId;
        const submitBtn = document.querySelector(
          '#bookForm button[type="submit"]'
        );
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Kitap Güncelle';

        document.querySelector("#bookFormContainer .card-header h5").innerHTML =
          '<i class="fas fa-edit me-2"></i>Kitap Düzenle';

        showBookForm();
        document
          .getElementById("bookForm")
          .scrollIntoView({ behavior: "smooth" });
      };

      // Toggle return date field
      window.toggleReturnDate = function () {
        const willReturn = document.getElementById("willReturn").checked;
        const returnDateContainer = document.getElementById(
          "returnDateContainer"
        );
        const returnDateInput = document.getElementById("loanReturnDate");

        if (willReturn) {
          returnDateContainer.style.display = "block";
          returnDateInput.required = true;
        } else {
          returnDateContainer.style.display = "none";
          returnDateInput.required = false;
          returnDateInput.value = "";
        }
      };

      // Show loan modal
      window.showLoanModal = function (bookId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const book = books.find((b) => b.id === bookId);
        if (!book) {
          alert("Kitap bulunamadı!");
          return;
        }

        document.getElementById("loanBookId").value = bookId;
        document.getElementById("loanBookTitle").value =
          book.title || "İsimsiz Kitap";
        document.getElementById("loanBookQuantity").value = book.quantity || 1;
        document.getElementById("loanBorrower").value = "";
        document.getElementById("loanQuantity").value = "1";
        document.getElementById("loanNotes").value = "";

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("loanDate").value = today;

        // Reset return date checkbox and field
        document.getElementById("willReturn").checked = false;
        document.getElementById("loanReturnDate").value = "";
        document.getElementById("returnDateContainer").style.display = "none";
        document.getElementById("loanReturnDate").required = false;

        // Set max quantity
        const maxQuantity = parseInt(book.quantity) || 1;
        document.getElementById("loanQuantity").max = maxQuantity;

        // Open modal (Bootstrap 4/5 compatibility)
        const modalEl = document.getElementById("bookLoanModal");
        if (window.bootstrap && bootstrap.Modal) {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        } else if (window.$ && window.$.fn && window.$.fn.modal) {
          $(modalEl).modal("show");
        } else {
          modalEl.classList.add("show");
          modalEl.style.display = "block";
        }
      };

      // Submit book loan
      window.submitBookLoan = async function () {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const bookId = document.getElementById("loanBookId").value;
        const borrower = document.getElementById("loanBorrower").value.trim();
        const loanQuantity = parseInt(
          document.getElementById("loanQuantity").value
        );
        const loanDate = document.getElementById("loanDate").value;
        const willReturn = document.getElementById("willReturn").checked;
        const returnDate = willReturn
          ? document.getElementById("loanReturnDate").value
          : null;
        const notes = document.getElementById("loanNotes").value.trim();

        if (!borrower) {
          alert("Lütfen teslim alan (kişi/kurum) bilgisini girin!");
          return;
        }

        if (!loanQuantity || loanQuantity < 1) {
          alert("Lütfen geçerli bir adet girin!");
          return;
        }

        // Validate return date if will return is checked
        if (willReturn && !returnDate) {
          alert("Lütfen geri getirme tarihini girin!");
          return;
        }

        const book = books.find((b) => b.id === bookId);
        if (!book) {
          alert("Kitap bulunamadı!");
          return;
        }

        const currentQuantity = parseInt(book.quantity) || 1;
        if (loanQuantity > currentQuantity) {
          alert(`Yetersiz stok! Mevcut adet: ${currentQuantity}`);
          return;
        }

        try {
          const loanData = {
            bookId: bookId,
            bookTitle: book.title,
            bookAuthor: book.author,
            borrower: borrower,
            quantity: loanQuantity,
            loanDate: Timestamp.fromDate(new Date(loanDate)),
            willReturn: willReturn,
            returnDate: returnDate
              ? Timestamp.fromDate(new Date(returnDate))
              : null,
            notes: notes || null,
            returned: false,
            returnedDate: null,
            createdAt: Timestamp.now(),
          };

          // Add loan record
          const loanRef = await addDoc(collection(db, "bookLoans"), loanData);

          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "library_loan_create",
            page: "library",
            targetId: loanRef.id,
            targetType: "bookLoan",
            meta: {
              bookTitle: book.title,
              borrower,
              quantity: loanQuantity,
              willReturn,
            },
          });

          // Update book quantity only if book will not be returned
          if (!willReturn) {
            const newQuantity = currentQuantity - loanQuantity;
            const bookRef = doc(db, "books", bookId);
            await updateDoc(bookRef, {
              quantity: newQuantity,
              updatedAt: Timestamp.now(),
            });
          }

          alert("Kitap çıkışı başarıyla kaydedildi!");

          // Close modal
          hideModalById("bookLoanModal");

          // Reload data
          loadBooks();
          loadBookLoans();
        } catch (error) {
          console.error("Error saving book loan:", error);
          alert("Kitap çıkışı kaydedilirken hata oluştu!");
        }
      };

      // Load book loans
      async function loadBookLoans() {
        try {
          const loansRef = collection(db, "bookLoans");
          const q = query(loansRef, orderBy("createdAt", "desc"));
          const querySnapshot = await getDocs(q);

          bookLoans = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            bookLoans.push({
              id: doc.id,
              ...data,
              loanDate: data.loanDate ? data.loanDate.toDate() : new Date(),
              returnDate: data.returnDate ? data.returnDate.toDate() : null,
              returnedDate: data.returnedDate
                ? data.returnedDate.toDate()
                : null,
              createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
            });
          });

          filteredLoans = [...bookLoans];
          renderBookLoans();
        } catch (error) {
          console.error("Error loading book loans:", error);
          document.getElementById("bookLoansContainer").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
              <p class="mt-2 text-danger">Çıkış kayıtları yüklenirken hata oluştu!</p>
            </div>
          `;
        }
      }

      // Render book loans
      function renderBookLoans() {
        const container = document.getElementById("bookLoansContainer");

        if (filteredLoans.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-list fa-2x text-muted"></i>
              <p class="mt-2 text-muted">${
                bookLoans.length === 0
                  ? "Henüz çıkış kaydı bulunmuyor."
                  : "Arama sonucu bulunamadı."
              }</p>
            </div>
          `;
          return;
        }

        const formatDate = (date) => {
          if (!date) return "-";
          return new Date(date).toLocaleDateString("tr-TR");
        };

        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Kitap</th>
                  <th>Yazar</th>
                  <th>Teslim Alan</th>
                  <th>Adet</th>
                  <th>Çıkış Tarihi</th>
                  <th>Geri Getirme</th>
                  <th>Durum</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody>
                ${filteredLoans
                  .map(
                    (loan) => `
                  <tr class="${
                    loan.returned
                      ? "table-success"
                      : (loan.willReturn === false ||
                          loan.willReturn === undefined) &&
                        !loan.returned
                      ? "table-secondary"
                      : "table-warning"
                  }">
                    <td>${loan.bookTitle || "İsimsiz"}</td>
                    <td>${loan.bookAuthor || "-"}</td>
                    <td>${loan.borrower || "-"}</td>
                    <td>${loan.quantity || 1}</td>
                    <td>${formatDate(loan.loanDate)}</td>
                    <td>
                      ${
                        loan.willReturn === false ||
                        loan.willReturn === undefined
                          ? `<span class="badge bg-secondary">Geri Gelmeyecek</span>`
                          : loan.returnDate
                          ? formatDate(loan.returnDate)
                          : "-"
                      }
                    </td>
                    <td>
                      ${
                        loan.returned
                          ? `<span class="badge bg-success">İade Edildi</span>`
                          : loan.willReturn === false ||
                            loan.willReturn === undefined
                          ? `<span class="badge bg-dark">Verdi</span>`
                          : `<span class="badge bg-warning text-dark">Ödünçte</span>`
                      }
                    </td>
                    <td>
                      ${
                        canWrite
                          ? `<div class="d-flex flex-column flex-sm-row gap-2 align-items-start">
                              ${
                                loan.returned
                                  ? `<span class="text-muted small flex-grow-1">${
                                      loan.returnedDate
                                        ? formatDate(loan.returnedDate)
                                        : ""
                                    }</span>`
                                  : loan.willReturn === true ||
                                    (loan.willReturn === undefined &&
                                      loan.returnDate)
                                  ? `<button class="btn btn-sm btn-success" onclick="returnBook('${loan.id}', '${loan.bookId}', ${loan.quantity})">
                                      <i class="fas fa-check me-1"></i>Teslim Al
                                    </button>`
                                  : `<button class="btn btn-sm btn-warning" onclick="returnBook('${loan.id}', '${loan.bookId}', ${loan.quantity})">
                                      <i class="fas fa-undo me-1"></i>İade Et
                                    </button>`
                              }
                              <button class="btn btn-sm btn-outline-danger" onclick="deleteBookLoan('${
                                loan.id
                              }')">
                                <i class="fas fa-trash me-1"></i>Kaydı Sil
                              </button>
                            </div>`
                          : `<span class="text-muted small"><i class="fas fa-lock me-1"></i>Bu kayıt üzerinde değişiklik yetkiniz yok.</span>`
                      }
                    </td>
                  </tr>
                  ${
                    loan.notes
                      ? `<tr class="${
                          loan.returned
                            ? "table-success"
                            : (loan.willReturn === false ||
                                loan.willReturn === undefined) &&
                              !loan.returned
                            ? "table-secondary"
                            : "table-warning"
                        }">
                          <td colspan="8" class="text-muted small">
                            <i class="fas fa-sticky-note me-1"></i><strong>Not:</strong> ${
                              loan.notes
                            }
                          </td>
                        </tr>`
                      : ""
                  }
                `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }

      // Return book
      window.returnBook = async function (loanId, bookId, quantity) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const loan = bookLoans.find((l) => l.id === loanId);
        const isWillReturn =
          loan &&
          (loan.willReturn === true ||
            (loan.willReturn === undefined && loan.returnDate));
        const confirmMessage = isWillReturn
          ? "Bu kitabı teslim almak istediğinizden emin misiniz?"
          : "Bu kitabı iade etmek istediğinizden emin misiniz?";

        if (!confirm(confirmMessage)) return;

        try {
          const loanRef = doc(db, "bookLoans", loanId);
          await updateDoc(loanRef, {
            returned: true,
            returnedDate: Timestamp.now(),
          });

          // Update book quantity (always increase for both cases)
          const book = books.find((b) => b.id === bookId);
          if (book) {
            const currentQuantity = parseInt(book.quantity) || 0;
            const bookRef = doc(db, "books", bookId);
            await updateDoc(bookRef, {
              quantity: currentQuantity + quantity,
              updatedAt: Timestamp.now(),
            });
          }

          alert(
            isWillReturn
              ? "Kitap başarıyla teslim alındı!"
              : "Kitap başarıyla iade edildi!"
          );
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "library_loan_return",
            page: "library",
            targetId: loanId,
            targetType: "bookLoan",
            meta: {
              bookTitle: loan?.bookTitle || "",
              borrower: loan?.borrower || "",
              quantity,
              isWillReturn,
            },
          });
          loadBooks();
          loadBookLoans();
        } catch (error) {
          console.error("Error returning book:", error);
          alert("Kitap işlemi sırasında hata oluştu!");
        }
      };

      window.deleteBookLoan = async function (loanId) {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        const loan = bookLoans.find((l) => l.id === loanId);
        if (!loan) return;

        if (!confirm("Bu çıkış kaydını silmek istediğinizden emin misiniz?")) {
          return;
        }

        try {
          await deleteDoc(doc(db, "bookLoans", loanId));

          if (!loan.returned && loan.willReturn === false && loan.bookId) {
            try {
              const bookRef = doc(db, "books", loan.bookId);
              const bookSnap = await getDoc(bookRef);
              if (bookSnap.exists()) {
                const currentQuantity = parseInt(bookSnap.data().quantity) || 0;
                const updatedQuantity =
                  currentQuantity + (parseInt(loan.quantity) || 0);
                await updateDoc(bookRef, {
                  quantity: updatedQuantity,
                  updatedAt: Timestamp.now(),
                });
              }
            } catch (restoreError) {
              console.error(
                "Error restoring book quantity after loan deletion:",
                restoreError
              );
            }
          }

          alert("Çıkış kaydı başarıyla silindi!");
          await logActivity(db, {
            userEmail: currentUserEmail,
            userName: currentUserName,
            action: "library_loan_delete",
            page: "library",
            targetId: loanId,
            targetType: "bookLoan",
            meta: {
              bookTitle: loan.bookTitle || "",
              borrower: loan.borrower || "",
            },
          });
          loadBooks();
          loadBookLoans();
        } catch (error) {
          console.error("Error deleting book loan:", error);
          alert("Çıkış kaydı silinirken hata oluştu!");
        }
      };

      // QR Code Scanner Functions
      window.startQRScanForBook = function () {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        qrScanMode = "book";
        startQRScan();
      };

      window.startQRScanForLoan = function () {
        if (!canWrite) {
          alert("Bu işlemi gerçekleştirmek için yetkiniz yok.");
          return;
        }
        qrScanMode = "loan";
        startQRScan();
      };

      async function startQRScan() {
        if (qrScanning) return;

        const container = document.getElementById("qrScannerContainer");
        const video = document.getElementById("qrVideo");
        const canvas = document.getElementById("qrCanvas");
        const status = document.getElementById("qrScannerStatus");
        const ctx = canvas.getContext("2d");

        container.classList.add("active");
        qrScanning = true;

        try {
          // Request camera access
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }, // Use back camera on mobile
          });

          qrStream = stream;
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();

          status.textContent = "QR kod veya barkodu kameraya doğrultun...";

          function scanQR() {
            if (!qrScanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvas.height = video.videoHeight;
              canvas.width = video.videoWidth;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              const imageData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height
              );
              const code = jsQR(
                imageData.data,
                imageData.width,
                imageData.height,
                {
                  inversionAttempts: "dontInvert",
                }
              );

              if (code) {
                status.textContent = "Kod okundu! İşleniyor...";
                handleQRCode(code.data);
                stopQRScan();
              }
            }

            if (qrScanning) {
              requestAnimationFrame(scanQR);
            }
          }

          video.addEventListener("loadedmetadata", () => {
            scanQR();
          });
        } catch (error) {
          console.error("Error accessing camera:", error);
          status.textContent =
            "Kamera erişimi hatası! Lütfen kamera iznini kontrol edin.";
          setTimeout(() => {
            stopQRScan();
          }, 3000);
        }
      }

      function stopQRScan() {
        qrScanning = false;

        if (qrStream) {
          qrStream.getTracks().forEach((track) => track.stop());
          qrStream = null;
        }

        const container = document.getElementById("qrScannerContainer");
        const video = document.getElementById("qrVideo");
        const status = document.getElementById("qrScannerStatus");

        container.classList.remove("active");
        video.srcObject = null;
        status.textContent = "QR kod veya barkodu kameraya doğrultun...";
      }

      async function handleQRCode(data) {
        console.log("QR Code scanned:", data);

        if (qrScanMode === "book") {
          // Handle book QR code (ISBN or custom ID)
          await handleBookQRCode(data);
        } else if (qrScanMode === "loan") {
          // Handle loan QR code (Book ID)
          await handleLoanQRCode(data);
        }
      }

      async function handleBookQRCode(qrData) {
        // Try to extract ISBN from QR code
        let isbn = qrData.replace(/\D/g, ""); // Remove non-digits
        if (isbn.length === 10 || isbn.length === 13) {
          // Try to fetch book info from Google Books API
          try {
            const response = await fetch(
              `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`
            );
            const data = await response.json();

            if (data.items && data.items.length > 0) {
              const book = data.items[0].volumeInfo;

              document.getElementById("bookTitle").value = book.title || "";
              document.getElementById("bookAuthor").value =
                (book.authors && book.authors[0]) || "";
              document.getElementById("bookPublisher").value =
                book.publisher || "";
              document.getElementById("bookIsbn").value = isbn;
              document.getElementById("bookYear").value = book.publishedDate
                ? book.publishedDate.split("-")[0]
                : "";
              document.getElementById("bookPages").value = book.pageCount || "";
              document.getElementById("bookDescription").value =
                book.description || "";

              if (book.imageLinks && book.imageLinks.thumbnail) {
                document.getElementById("bookCoverUrl").value =
                  book.imageLinks.thumbnail.replace("http://", "https://");
              }

              alert("Kitap bilgileri otomatik dolduruldu!");
            } else {
              // ISBN not found, fill what we can
              document.getElementById("bookIsbn").value = isbn;
              document.getElementById("bookTitle").focus();
              alert(
                "ISBN bulundu ancak kitap bilgileri bulunamadı. Lütfen manuel olarak doldurun."
              );
            }
          } catch (error) {
            console.error("Error fetching book info:", error);
            document.getElementById("bookIsbn").value = isbn;
            document.getElementById("bookTitle").focus();
            alert("Kitap bilgileri çekilemedi. Lütfen manuel olarak doldurun.");
          }
        } else {
          // Not a valid ISBN, treat as custom ID or title
          document.getElementById("bookTitle").value = qrData;
          document.getElementById("bookTitle").focus();
          alert("QR kod okundu. Lütfen diğer bilgileri doldurun.");
        }
      }

      async function handleLoanQRCode(qrData) {
        // Try to find book by ID, ISBN, or title
        let foundBook = null;

        // Try to find by book ID (if QR contains book ID)
        if (qrData.length < 50) {
          foundBook = books.find((b) => b.id === qrData);
        }

        // Try to find by ISBN
        if (!foundBook) {
          const isbn = qrData.replace(/\D/g, "");
          foundBook = books.find(
            (b) => b.isbn && b.isbn.replace(/\D/g, "") === isbn
          );
        }

        // Try to find by title
        if (!foundBook) {
          foundBook = books.find(
            (b) =>
              b.title && b.title.toLowerCase().includes(qrData.toLowerCase())
          );
        }

        if (foundBook) {
          // Close QR scanner first if modal is open
          const modalEl = document.getElementById("bookLoanModal");
          const isModalOpen =
            modalEl &&
            (modalEl.classList.contains("show") ||
              modalEl.style.display === "block");

          // Fill loan form with book info
          if (!isModalOpen) {
            showLoanModal(foundBook.id);
          } else {
            // Modal already open, just fill the book info
            document.getElementById("loanBookId").value = foundBook.id;
            document.getElementById("loanBookTitle").value =
              foundBook.title || "İsimsiz Kitap";
            document.getElementById("loanBookQuantity").value =
              foundBook.quantity || 1;
            const maxQuantity = parseInt(foundBook.quantity) || 1;
            document.getElementById("loanQuantity").max = maxQuantity;
          }

          alert("Kitap bulundu! Sadece adet ve ödünç bilgilerini girin.");
        } else {
          alert("Kitap bulunamadı! Lütfen manuel olarak seçin.");
        }
      }

      // Make functions globally available
      window.loadBooks = loadBooks;
      window.loadBookLoans = loadBookLoans;
      window.stopQRScan = stopQRScan;
    </script>
  </body>
</html>
